<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8">
    <title>ê°ë‹¤ì‚´ ì˜ìƒ ì•„ì¹´ì´ë¸Œ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
      :root { color-scheme: light dark; }
      * { box-sizing: border-box; }
      html, body { -webkit-text-size-adjust: 100%; }
      html { width: 100%; overflow-x: hidden; }
      img, video { max-width: 100%; height: auto; }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: 'Pretendard', 'Apple SD Gothic Neo', 'Segoe UI', sans-serif;
        color: #3d2d4d;
        background: radial-gradient(circle at 18% 18%, #f5e6ff 0%, #e8d4ff 35%, #d4b5ff 65%, #c9a3ff 100%);
        display: flex;
        justify-content: center;
        padding: clamp(2rem, 5vw, 3.8rem) clamp(1.6rem, 4vw, 3.2rem);
        padding-left: max(clamp(1.6rem, 4vw, 3.2rem), env(safe-area-inset-left));
        padding-right: max(clamp(1.6rem, 4vw, 3.2rem), env(safe-area-inset-right));
        overflow-x: hidden;
        width: 100%;
      }
      main {
        width: 100%;
        max-width: 1100px;
        display: grid;
        gap: clamp(1.2rem, 3vw, 2rem);
        background: rgba(255, 255, 255, 0.88);
        border-radius: clamp(1.6rem, 3vw, 2.4rem);
        padding: clamp(1.6rem, 3vw, 2.2rem);
        box-shadow: 0 4rem 6rem rgba(138, 43, 226, 0.25), 0 1rem 2rem rgba(138, 43, 226, 0.15), inset 0 0 0 1px rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(20px);
        overflow-x: hidden;
      }
      header {
        text-align: center;
        display: grid;
        gap: 0.9rem;
      }
      header h1 {
        margin: 0;
        font-size: clamp(2.5rem, 6vw, 3.6rem);
        letter-spacing: 0.05em;
        color: #7a3fa8;
        text-shadow: 0 2px 8px rgba(138, 43, 226, 0.2);
        max-width: 100%;
        padding: 0 8px;
        box-sizing: border-box;
        overflow-wrap: anywhere;
        word-break: break-word;
      }
      header p {
        margin: 0;
        color: rgba(107, 44, 145, 0.9);
        font-size: 1.06rem;
      }
      #archives {
        display: grid;
        gap: clamp(2.2rem, 4vw, 3rem);
      }
      .archive {
        display: grid;
        gap: 1.6rem;
        padding: clamp(1.6rem, 3.5vw, 2.4rem);
        border-radius: 2rem;
        background: linear-gradient(135deg, rgba(255, 245, 255, 0.8) 0%, rgba(248, 232, 255, 0.75) 100%);
        box-shadow: inset 0 0 0 1px rgba(138, 43, 226, 0.25), 0 4px 12px rgba(138, 43, 226, 0.1);
      }
      .archive-header {
        text-align: center;
        display: grid;
        gap: 0.6rem;
      }
      .archive-title {
        margin: 0;
        font-size: clamp(1.6rem, 4vw, 2.2rem);
        font-weight: 600;
        letter-spacing: 0.02em;
      }
      .archive-description {
        margin: 0;
        color: rgba(107, 44, 145, 0.75);
        font-size: 0.98rem;
      }
      .upload-list {
        display: grid;
        gap: 1rem;
      }
      .upload-item {
        display: flex;
        gap: 1.2rem;
        flex-wrap: wrap;
        align-items: center;
        padding: 1rem 1.2rem;
        border-radius: 1.4rem;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.85) 0%, rgba(252, 245, 255, 0.8) 100%);
        box-shadow: inset 0 0 0 1px rgba(138, 43, 226, 0.3), 0 3px 10px rgba(138, 43, 226, 0.12);
        max-width: 100%;
        overflow-x: hidden;
      }
      .upload-video {
        flex: 0 0 200px;
        max-width: 240px;
        aspect-ratio: 16 / 9;
        border-radius: 1.2rem;
        overflow: hidden;
        box-shadow: 0 1.1rem 2.2rem rgba(0, 0, 0, 0.45);
      }
      .upload-video video {
        display: block;
        width: 100%;
        height: 100%;
        object-fit: cover;
        background: rgba(0, 0, 0, 0.3);
      }
      .upload-info {
        flex: 1 1 240px;
        text-align: left;
      }
      .upload-info strong {
        display: block;
        font-size: 1.05rem;
        color: #7a3fa8;
        margin-bottom: 0.4rem;
      }
      .upload-info span {
        display: block;
        font-size: 0.9rem;
        color: rgba(107, 44, 145, 0.75);
      }
      .upload-actions {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        min-width: 120px;
      }
      .upload-actions button {
        padding: 0.8rem 1.2rem;
        border: none;
        border-radius: 0.8rem;
        background: rgba(255, 255, 255, 0.9);
        color: #6b2c91;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: inset 0 0 0 1px rgba(138, 43, 226, 0.3), 0 2px 4px rgba(138, 43, 226, 0.1);
      }
      .upload-actions button:hover {
        background: rgba(255, 255, 255, 1);
        transform: translateY(-1px);
      }
      .upload-actions button:active {
        transform: translateY(0);
      }
      .upload-form {
        display: grid;
        gap: 1.2rem;
        padding: 1.8rem;
        border-radius: 1.4rem;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(252, 245, 255, 0.75) 100%);
        box-shadow: inset 0 0 0 1px rgba(138, 43, 226, 0.3), 0 4px 12px rgba(138, 43, 226, 0.12);
      }
      .upload-form input,
      .upload-form textarea {
        padding: 1rem;
        border: none;
        border-radius: 0.8rem;
        background: rgba(255, 255, 255, 0.95);
        color: #2d1b3d;
        font-size: 1rem;
        font-family: inherit;
        box-shadow: inset 0 0 0 1px rgba(138, 43, 226, 0.3);
        transition: all 0.2s ease;
      }
      .upload-form input::placeholder,
      .upload-form textarea::placeholder {
        color: rgba(107, 44, 145, 0.5);
      }
      .upload-form input:focus,
      .upload-form textarea:focus {
        outline: none;
        box-shadow: inset 0 0 0 2px rgba(138, 43, 226, 0.5);
        background: rgba(255, 255, 255, 1);
      }
      .upload-form textarea {
        resize: vertical;
        min-height: 80px;
      }
      .submit-button {
        padding: 1.2rem 2rem;
        border: none;
        border-radius: 1rem;
        font-size: 1.1rem;
        font-weight: 600;
        letter-spacing: 0.05em;
        background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
        color: #341d2f;
        cursor: pointer;
        box-shadow: 0 1.3rem 2.4rem rgba(255, 154, 158, 0.34);
      }
      .submit-button:hover { filter: brightness(1.05); }
      .submit-button:disabled { opacity: 0.55; cursor: default; filter: none; }
      @media (max-width: 900px) {
        .two-col { grid-template-columns: 1fr !important; }
      }

      @media (max-width: 720px) {
        body { 
          padding: 0.8rem 0.6rem 1.2rem; 
          font-size: 14px;
          display: block; /* avoid flex centering issues on iOS */
          overflow-x: hidden; /* prevent horizontal scroll */
          padding-left: max(0.6rem, env(safe-area-inset-left));
          padding-right: max(0.6rem, env(safe-area-inset-right));
        }
        main { 
          padding: 1rem 0.6rem 2rem; 
          border-radius: 1.5rem;
          overflow-x: hidden; /* prevent horizontal scroll */
          overflow-y: visible; /* allow content to be fully visible */
          width: calc(100vw - max(1.2rem, env(safe-area-inset-left) + env(safe-area-inset-right)));
          max-width: 100%;
          margin: 0 auto; /* center within body */
          box-sizing: border-box;
        }
        main > * {
          max-width: 100%;
          box-sizing: border-box;
          overflow-x: hidden;
        }
        /* Ensure all major blocks never exceed the viewport width */
        section, .archive, #nominated-list-section, .intro-video-container, .upload-form, .upload-item {
          width: 100%;
          max-width: calc(100% - 16px); /* add small gutters so borders don't touch */
          margin-left: auto;
          margin-right: auto;
          box-sizing: border-box;
        }
        .upload-item { padding: 0.8rem; gap: 0.8rem; }
        .upload-video { flex: 1 1 100%; max-width: 100%; }
        .upload-info { flex: 1 1 100%; }
        .upload-actions { min-width: 0; width: 100%; flex-direction: row; flex-wrap: wrap; justify-content: flex-end; gap: 0.5rem; }
        .upload-actions button { flex: 0 1 auto; }
        /* Nominated list rows */
        #nominated-list > div { max-width: 100%; }
        /* Tighten general paddings/gaps */
        .upload-form { padding: 0.9rem; gap: 0.8rem; }
        .dropzone { padding: 1rem; }
        .archive { 
          padding: 1rem; 
          margin-bottom: 1rem;
          padding-bottom: 1.5rem;
        }
        header { 
          width: 100%;
          max-width: 100%;
          margin: 0 auto; 
          overflow-x: hidden;
          box-sizing: border-box;
          padding: 0 0.4rem;
        }
        header > * {
          max-width: 100%;
          box-sizing: border-box;
        }
        header h1 {
          font-size: 1.9rem;
          margin-bottom: 0.5rem;
          letter-spacing: 0; /* prevent text from extending outside container */
          text-align: center;
          padding: 0 0.4rem;
          max-width: 100%;
          margin-left: auto;
          margin-right: auto;
          line-height: 1.2;
          overflow-wrap: anywhere;
          word-break: break-word;
          box-sizing: border-box;
        }
        header p {
          font-size: 0.9rem;
          text-align: center;
          max-width: 100%;
          margin: 0 auto;
          line-height: 1.5;
          padding: 0 0.4rem;
          overflow-wrap: anywhere;
          word-break: break-word;
          box-sizing: border-box;
        }
        header > div {
          max-width: 100%;
          box-sizing: border-box;
          padding: 0;
        }
        #qr-code-container { 
          display: block; 
          margin: 0.3rem auto 0; 
          max-width: 100%;
          box-sizing: border-box;
          width: auto;
        }
        #qr-code-img {
          width: 84px !important;
          height: 84px !important;
          max-width: 100% !important;
          box-sizing: border-box;
        }
        /* Intro section stricter rules */
        .intro-video-container { 
          max-width: calc(100% - 16px) !important; 
          width: 100% !important; 
          padding: 1rem !important; 
          overflow: hidden;
        }
        .intro-video-frame { 
          max-width: 100% !important; 
          width: 100% !important; 
          margin: 0 auto !important;
        }
        .feature-cards { 
          display: flex !important; 
          flex-wrap: wrap !important; 
          justify-content: center !important; 
          gap: 0.5rem !important; 
          width: 100% !important; 
          max-width: 100% !important;
        }
        .feature-card { 
          min-width: 0 !important; 
          flex: 1 1 120px !important; 
          max-width: calc(50% - 0.5rem) !important; 
          box-sizing: border-box; 
        }
        /* Stack cell/name inputs vertically on small screens */
        .two-inputs { grid-template-columns: 1fr !important; gap: 0.5rem !important; }
        .upload-cell, .upload-name { width: 100%; box-sizing: border-box; }
      }
      
      /* ì´ˆì†Œí˜•(ì•„ì´í° SE ë“±) í™”ë©´ ëŒ€ì‘ */
      @media (max-width: 360px) {
        header h1 { font-size: 1.8rem; }
        header p { max-width: calc(100% - 12px); padding: 0 6px; }
        #qr-code-img { width: 72px !important; height: 72px !important; }
        .intro-video-container { padding: 0.9rem !important; }
        .upload-form { padding: 0.8rem; }
        .feature-card { flex: 1 1 140px !important; max-width: 100% !important; }
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <h1>ê°ë‹¤ì‚´ ì±Œë¦°ì§€</h1>
        <p>ì˜ˆë°°ì™€ ì‚¶ì˜ íšŒë³µì„ ìœ„í•œ ê°ë‹¤ì‚´ ì±Œë¦°ì§€, í•¨ê»˜í•´ìš”!</p>
        <div style="margin: 1rem auto; text-align: center;">
          <div id="qr-code-container" style="display: inline-block; padding: 0.6rem; background: rgba(255,255,255,0.95); border-radius: 0.8rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
            <img id="qr-code-img" alt="QR Code" style="display: block; width: 120px; height: 120px;">
          </div>
          <p style="margin: 0.4rem 0 0; font-size: 0.75rem; color: rgba(107, 44, 145, 0.8);">ğŸ“± QR ì½”ë“œë¡œ ëª¨ë°”ì¼ì—ì„œ ì ‘ì†</p>
        </div>
      </header>

      <!-- ì¸íŠ¸ë¡œ ì˜ìƒ ì„¹ì…˜ (ìœ„ë¡œ ì´ë™) -->
      <section style="margin-bottom: 1.5rem; text-align: center;">
        <div class="intro-video-container" style="background: linear-gradient(135deg, rgba(252,245,255,0.85) 0%, rgba(248,232,255,0.8) 100%); padding: 1.2rem; border-radius: 1rem; backdrop-filter: blur(10px); border: 1px solid rgba(138,43,226,0.35); box-shadow: 0 4px 12px rgba(138,43,226,0.15); max-width: 600px; margin: 0 auto;">
          <h3 style="margin: 0 0 0.6rem 0; color: #7a3fa8; font-size: 1.1rem; font-weight: 600; text-shadow: 0 1px 4px rgba(138,43,226,0.2);">ğŸ’ ê°ì‚¬, í•˜ë£¨ì˜ ë°œê²¬</h3>
          <div class="intro-video-frame" style="width:100%; max-width:360px; aspect-ratio: 16 / 9; margin: 0 auto; border-radius: 0.8rem; overflow:hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1);">
            <video controls style="display:block; width:100%; height:100%; object-fit: cover;">
              <source src="ê°ì‚¬, í•˜ë£¨ì˜ ë°œê²¬.mp4" type="video/mp4">
              ê°ì‚¬, í•˜ë£¨ì˜ ë°œê²¬ ì˜ìƒ
            </video>
          </div>
          <div class="feature-cards" style="display:flex; justify-content:center; gap:0.6rem; flex-wrap:wrap; margin-top:0.6rem; flex-direction: column; align-items: center;">
            <div style="text-align:center; padding: 1.5rem; background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(252,245,255,0.85) 100%); border-radius: 1rem; border: 1px solid rgba(138,43,226,0.35); max-width: 100%; box-shadow: 0 3px 10px rgba(138,43,226,0.12);">
              <div style="font-size: 1.1rem; color: #7a3fa8; line-height: 1.6; font-weight: 500;">
                ì‚¶ì˜ ì˜ˆë°° íšŒë³µì´ í•„ìš”í•œ ë‹¹ì‹ ì„ ìœ„í•œ ê°ë‹¤ì‚´ ì±Œë¦°ì§€!<br>ì£¼ì¸ê³µì€ ë°”ë¡œ ë‹¹ì‹ ì…ë‹ˆë‹¤!ğŸ™Œ
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ì§€ëª©ëœ ì‚¬ëŒë“¤ ë¦¬ìŠ¤íŠ¸ -->
      <section id="nominated-list-section" style="margin-bottom: 1.5rem; padding: 1.2rem; background: linear-gradient(135deg, rgba(252,245,255,0.75) 0%, rgba(248,232,255,0.7) 100%); border-radius: 1rem; box-shadow: inset 0 0 0 1px rgba(138,43,226,0.25), 0 3px 10px rgba(138,43,226,0.1);">
        <h3 style="margin: 0 0 0.8rem 0; font-size: 1.2rem; color: #7a3fa8; text-align: center; text-shadow: 0 1px 4px rgba(138,43,226,0.2);">ğŸ“‹ ì±Œë¦°ì§€ ì§€ëª©ëœ ì‚¬ëŒë“¤</h3>
        <div id="nominated-list" style="display: grid; gap: 0.6rem; max-height: 200px; overflow-y: auto;">
          <p style="margin: 0; text-align: center; color: rgba(107,44,145,0.6); font-size: 0.9rem;">ì•„ì§ ì§€ëª©ëœ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      </section>

      <!-- ì˜ìƒ ì—…ë¡œë“œ ì„¹ì…˜ -->
      <section>
        <div id="archives"></div>
      </section>


      <!-- ì—…ë¡œë“œ ë¡œê·¸ ì„¹ì…˜ ì œê±°ë¨ -->

      <template id="archive-template">
        <section class="archive">
          <div class="archive-header">
            <h2 class="archive-title"></h2>
            <p class="archive-description"></p>
          </div>
          <div class="upload-list"></div>
          <form class="upload-form" autocomplete="off">
            <label>ë“±ë¡ì</label>
            <div class="two-inputs" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.6rem;">
              <input class="upload-cell" type="text" maxlength="40" placeholder="ì…€ëª… (ì˜ˆ: ê°ë‹¤ì‚´ ì…€)" required>
              <input class="upload-name" type="text" maxlength="40" placeholder="ì´ë¦„ (ì˜ˆ: ì´í•˜ì—°)" required>
            </div>
            <label style="margin-top: 0.8rem;">ì˜ìƒ ì œëª©</label>
            <input class="upload-title" type="text" maxlength="80" placeholder="ì˜ˆ: ë¯¸ì…˜ ë¸Œì´ë¡œê·¸" required>
            <div class="dropzone">
              <strong>ì˜ìƒ ë˜ëŠ” ì´ë¯¸ì§€ íŒŒì¼ì„ ëŒì–´ë‹¤ ë†“ê±°ë‚˜ ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„ íƒí•˜ì„¸ìš”.</strong>
              <span class="dropzone-status">ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</span>
              <button type="button" class="select-button">íŒŒì¼ ì„ íƒ</button>
              <input class="upload-file" type="file" accept="video/*,image/*">
            </div>
            <small class="upload-hint">Supabase í´ë¼ìš°ë“œì— ì €ì¥ë˜ì–´ ëª¨ë“  ê¸°ê¸°ì—ì„œ ì¦‰ì‹œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
            <button type="submit" class="submit-button">ì—…ë¡œë“œ</button>
          </form>
        </section>
      </template>
 
      <!-- ì§€ëª© ëª¨ë‹¬ -->
      <div id="nominate-modal" style="position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); z-index: 50;">
        <div style="width: min(520px, 92%); background: rgba(19,13,40,0.95); border-radius: 1rem; padding: 1.2rem 1.2rem 1rem; box-shadow: 0 20px 60px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.12);">
          <h3 style="margin: 0 0 0.6rem 0; color: #f5f2ff; font-size: 1.1rem;">ë‹¤ìŒ ì±Œë¦°ì§€ ì°¸ì—¬ìë¥¼ ì§€ëª©í•˜ì„¸ìš”</h3>
          <p style="margin: 0 0 0.8rem 0; color: rgba(255,255,255,0.75); font-size: 0.92rem;">ì…€ëª…ê³¼ ì´ë¦„ì„ ê°ê° ì…ë ¥í•´ì£¼ì„¸ìš”. ì—…ë¡œë“œ í•­ëª©ì— í•¨ê»˜ í‘œì‹œë©ë‹ˆë‹¤.</p>
          <div style="display: grid; gap: 0.8rem;">
            <label style="color: rgba(255,255,255,0.9); font-size: 0.9rem; font-weight: 500;">ì§€ëª©í•  ì‚¬ëŒ</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.6rem;">
              <input id="nominate-cell-input" type="text" placeholder="ì…€ëª… (ì˜ˆ: ê°ë‹¤ì‚´ ì…€)" maxlength="40" style="padding: 0.8rem 0.9rem; border: none; border-radius: 0.6rem; background: rgba(255,255,255,0.08); color: #fff;">
              <input id="nominate-name-input" type="text" placeholder="ì´ë¦„ (ì˜ˆ: ì´í•˜ì—°)" maxlength="40" style="padding: 0.8rem 0.9rem; border: none; border-radius: 0.6rem; background: rgba(255,255,255,0.08); color: #fff;">
            </div>
          </div>
          <div style="display:flex; gap:0.6rem; justify-content:flex-end; margin-top: 1rem;">
            <button id="nominate-skip" type="button" style="padding: 0.6rem 1rem; border:none; border-radius: 999px; background: rgba(255,255,255,0.14); color:#f5f2ff;">ë‚˜ì¤‘ì—</button>
            <button id="nominate-confirm" type="button" style="padding: 0.6rem 1.1rem; border:none; border-radius: 999px; background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%); color:#341d2f; font-weight:600;">í™•ì¸</button>
          </div>
        </div>
      </div>
    </main>

    <script>
const ENABLE_LOGS = false;
const MAX_UPLOADS = 12;
const sections = [
  {
    id: 'challenge',
    title: 'ê°ë‹¤ì‚´ ì±Œë¦°ì§€',
    description: 'ì˜ˆë°°ì™€ ì‚¶ì˜ íšŒë³µì„ ìœ„í•œ ê°ë‹¤ì‚´ ì±Œë¦°ì§€, í•¨ê»˜í•´ìš”!',
    storageKey: 'gamdasal-challenge-uploads',
    storageVersion: '2025-10-24-challenge-v2',
    posterColor: '211d44',
    defaults: []
  }
];

const LOG_STORAGE_KEY = 'gamdasal-upload-logs';
const LOG_LIMIT = 40;

const SUPABASE_URL = 'https://ykdmlgrlpwkqyyemcefz.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlrZG1sZ3JscHdrcXl5ZW1jZWZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNDI3NTMsImV4cCI6MjA3NjgxODc1M30.pRfCXTTXZHfp5Fohy4LLrHNujqds4Tir3pSMQIZLCvI';
const SUPABASE_BUCKET = 'videos';
const SUPABASE_TABLE = 'video_uploads';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const template = document.getElementById('archive-template');
const container = document.getElementById('archives');
const logListEl = null;
const logCopyBtn = null;
const logClearBtn = null;
const syncCloudBtn = null;
const testSupabaseBtn = null;
const testDatabaseBtn = null;
const testStorageBtn = null;

// Nomination modal elements
const nominateModal = document.getElementById('nominate-modal');
const nominateCellInput = document.getElementById('nominate-cell-input');
const nominateNameInput = document.getElementById('nominate-name-input');
const nominateConfirmBtn = document.getElementById('nominate-confirm');
const nominateSkipBtn = document.getElementById('nominate-skip');

/** ì—…ë¡œë“œ ì™„ë£Œ í›„ ì§€ëª©ì„ ì—°ê²°í•˜ê¸° ìœ„í•œ ë§ˆì§€ë§‰ ì—…ë¡œë“œ í•­ëª© ì°¸ì¡° */
let lastUploadedItem = null;

let logs = [];

// ìµëª… ë¡œê·¸ì¸ ì—†ì´ ì§ì ‘ API í˜¸ì¶œ
const SUPABASE_HEADERS = {
  'Content-Type': 'application/json',
  'apikey': SUPABASE_ANON_KEY,
  'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
  'Prefer': 'return=minimal'
};

// ê°„ë‹¨í•œ í´ë¼ìš°ë“œ ë™ê¸°í™”

// Supabase í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
const testSupabaseConnection = async () => {
  try {
    addLog('test', 'Supabase ì—°ê²° í…ŒìŠ¤íŠ¸', 'ì—°ê²° ì‹œë„ ì¤‘...');
    const { data, error } = await supabase.from('video_uploads').select('count').limit(1);
    if (error) {
      addLog('test', 'Supabase ì—°ê²° ì‹¤íŒ¨', error.message);
    } else {
      addLog('test', 'Supabase ì—°ê²° ì„±ê³µ', 'Database ì ‘ê·¼ ê°€ëŠ¥');
    }
  } catch (error) {
    addLog('test', 'Supabase ì—°ê²° ì˜¤ë¥˜', error.message);
  }
};

const testDatabase = async () => {
  try {
    addLog('test', 'Database í…ŒìŠ¤íŠ¸', 'í…Œì´ë¸” ì¡´ì¬ í™•ì¸ ì¤‘...');
    const { data, error } = await supabase
      .from(SUPABASE_TABLE)
      .select('*')
      .limit(1);
    
    if (error) {
      addLog('test', 'Database í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨', error.message);
    } else {
      addLog('test', 'Database í…ŒìŠ¤íŠ¸ ì„±ê³µ', `í…Œì´ë¸” ì ‘ê·¼ ê°€ëŠ¥ (${data?.length || 0}ê°œ ë ˆì½”ë“œ)`);
    }
  } catch (error) {
    addLog('test', 'Database í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜', error.message);
  }
};

const testStorage = async () => {
  try {
    addLog('test', 'Storage í…ŒìŠ¤íŠ¸', 'ë²„í‚· ì ‘ê·¼ í™•ì¸ ì¤‘...');
    const { data, error } = await supabase
      .storage
      .from(SUPABASE_BUCKET)
      .list('', { limit: 1 });
    
    if (error) {
      addLog('test', 'Storage í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨', error.message);
    } else {
      addLog('test', 'Storage í…ŒìŠ¤íŠ¸ ì„±ê³µ', `ë²„í‚· ì ‘ê·¼ ê°€ëŠ¥ (${data?.length || 0}ê°œ íŒŒì¼)`);
    }
  } catch (error) {
    addLog('test', 'Storage í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜', error.message);
  }
};

const clamp = (num, min, max) => Math.min(Math.max(num, min), max);

const formatNow = () => {
  const now = new Date();
  const pad = (value) => String(value).padStart(2, '0');
  return `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} Â· ${pad(now.getHours())}:${pad(now.getMinutes())}`;
};

const loadLogs = () => {
  if (!ENABLE_LOGS) return;
  try {
    logs = JSON.parse(localStorage.getItem(LOG_STORAGE_KEY) || '[]');
    if (!Array.isArray(logs)) logs = [];
  } catch (error) {
    logs = [];
  }
};

const persistLogs = () => {
  if (!ENABLE_LOGS) return;
  try {
    localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(logs));
  } catch (error) {
    console.error('ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨', error);
  }
};

const renderLogs = () => {
  if (!ENABLE_LOGS || !logListEl) return;
  logListEl.innerHTML = '';
  if (!logs.length) {
    const empty = document.createElement('p');
    empty.className = 'upload-empty';
    empty.textContent = 'ì•„ì§ ì—…ë¡œë“œ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
    logListEl.append(empty);
    return;
  }
  logs.slice().reverse().forEach((log) => {
    const item = document.createElement('article');
    item.className = 'upload-item';
    const info = document.createElement('div');
    info.className = 'upload-info';
    const strong = document.createElement('strong');
    strong.textContent = `[${log.section.toUpperCase()}] ${log.event}`;
    const span = document.createElement('span');
    span.textContent = `${log.time} Â· ${log.message}`;
    info.append(strong, span);
    item.append(info);
    if (log.details) {
      const pre = document.createElement('pre');
      pre.style.margin = '0';
      pre.style.maxWidth = '100%';
      pre.style.whiteSpace = 'pre-wrap';
      pre.style.wordBreak = 'break-all';
      pre.textContent = log.details;
      item.append(pre);
    }
    logListEl.append(item);
  });
};

const addLog = (sectionId, event, message, details) => {
  if (!ENABLE_LOGS) return;
  logs.push({ section: sectionId, event, message, details, time: new Date().toISOString() });
  if (logs.length > LOG_LIMIT) {
    logs = logs.slice(logs.length - LOG_LIMIT);
  }
  persistLogs();
  renderLogs();
};

const fallbackPoster = (section, title) => {
  const safe = encodeURIComponent((title || section.title).slice(0, 18));
  return `https://dummyimage.com/320x180/${section.posterColor}/ffffff&text=${safe}`;
};

const sanitizeFileName = (name) => {
  return name
    .toLowerCase()
    .replace(/[^a-z0-9._-]+/g, '-')
    .replace(/-+/g, '-')
    .replace(/^-|-$/g, '')
    .slice(0, 80) || 'upload';
};

const createUuid = () => {
  if (window.crypto && typeof window.crypto.randomUUID === 'function') {
    return window.crypto.randomUUID();
  }
  return `id-${Math.random().toString(36).slice(2, 11)}-${Date.now().toString(36)}`;
};

const createStoragePath = (archive, file) => {
  const extension = (file.name.split('.').pop() || 'mp4').toLowerCase();
  const base = sanitizeFileName(file.name.replace(/\.[^.]+$/, ''));
  const folder = `${archive.section.id}`;
  return `${folder}/${createUuid()}-${base}.${extension}`;
};

const mapRowToUpload = (row) => ({
  id: row.id,
  title: row.title,
  subtitle: row.subtitle,
  src: row.src,
  poster: row.poster,
  created_at: row.created_at
});

const uploadToSupabaseStorage = async (archive, file) => {
  try {
    const path = createStoragePath(archive, file);
    
    // Supabase Storageì— íŒŒì¼ ì—…ë¡œë“œ
    const { data, error } = await supabase
      .storage
      .from(SUPABASE_BUCKET)
      .upload(path, file, { cacheControl: '3600', upsert: false });
    
    if (error) {
      addLog(archive.section.id, 'Storage ì—…ë¡œë“œ ì‹¤íŒ¨', error.message);
      // ë²„í‚·ì´ ì—†ëŠ” ê²½ìš° Base64ë¡œ ëŒ€ì²´
      console.warn('Supabase Storage ì˜¤ë¥˜, Base64ë¡œ ëŒ€ì²´:', error);
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          resolve({
            publicUrl: reader.result,
            path: `base64_${Date.now()}_${file.name}`
          });
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    
    // ê³µê°œ URL ê°€ì ¸ì˜¤ê¸°
    const { data: urlData } = supabase
      .storage
      .from(SUPABASE_BUCKET)
      .getPublicUrl(path);
    
    addLog(archive.section.id, 'Storage ì—…ë¡œë“œ ì„±ê³µ', 'Supabase Storageì— ì €ì¥ë¨');
    return { publicUrl: urlData.publicUrl, path };
  } catch (error) {
    addLog(archive.section.id, 'Storage ì—…ë¡œë“œ ì‹¤íŒ¨', error.message);
    console.error('Storage ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
    throw error;
  }
};

const fetchUploadsFromCloud = async (archive, { addLogEntry = true } = {}) => {
  try {
    // Supabase Databaseì—ì„œë§Œ ë°ì´í„° ë¡œë“œ
    const { data, error } = await supabase
      .from(SUPABASE_TABLE)
      .select('id,title,subtitle,src,poster,created_at')
      .order('created_at', { ascending: false })
      .limit(MAX_UPLOADS);
    
    if (error) {
      console.warn('Supabase Database ì˜¤ë¥˜:', error);
      addLog(archive.section.id, 'í´ë¼ìš°ë“œ ë¡œë“œ ì‹¤íŒ¨', error.message);
      archive.uploads = [];
    } else {
      archive.uploads = (data || []).map(mapRowToUpload);
      if (addLogEntry) {
        addLog(archive.section.id, 'í´ë¼ìš°ë“œ ë¡œë“œ', `${archive.uploads.length}ê°œ ì˜ìƒ ë¡œë“œ`);
      }
    }
  } catch (error) {
    addLog(archive.section.id, 'í´ë¼ìš°ë“œ ë¡œë“œ ì‹¤íŒ¨', error.message);
    archive.uploads = [];
  }
};

const insertUploadRecord = async (archive, item) => {
  try {
    // Supabase Databaseì—ë§Œ ì €ì¥
    const { data, error } = await supabase
      .from(SUPABASE_TABLE)
      .insert([{
        title: item.title,
        subtitle: item.subtitle,
        src: item.src,
        poster: item.poster
      }])
      .select('id,title,subtitle,src,poster,created_at')
      .single();
    
    if (error) {
      addLog(archive.section.id, 'Supabase ì €ì¥ ì‹¤íŒ¨', error.message);
      throw error;
    }
    
    addLog(archive.section.id, 'Supabase ì €ì¥', 'Supabase Databaseì— ì €ì¥ë¨');
    return mapRowToUpload(data);
  } catch (error) {
    addLog(archive.section.id, 'ì—…ë¡œë“œ ì €ì¥ ì‹¤íŒ¨', error.message);
    throw error;
  }
};

const removeUploadRecord = async (archive, upload) => {
  if (!upload?.id) return;
  try {
    // Supabase Databaseì—ì„œ ì‚­ì œ
    const { error } = await supabase
      .from(SUPABASE_TABLE)
      .delete()
      .eq('id', upload.id);
    
    if (error) {
      addLog(archive.section.id, 'Supabase ì‚­ì œ ì‹¤íŒ¨', error.message);
      throw error;
    }
    
    addLog(archive.section.id, 'Supabase ì‚­ì œ', 'Supabase Databaseì—ì„œ ì‚­ì œë¨');
  } catch (error) {
    addLog(archive.section.id, 'ì‚­ì œ ì‹¤íŒ¨', error.message);
    throw error;
  }
};

// ì§€ëª©ëœ ì‚¬ëŒë“¤ ì¶”ì¶œ ë° ë Œë”ë§
const extractNominatedPeople = (archives) => {
  const nominated = new Map(); // ì¤‘ë³µ ì œê±°ë¥¼ ìœ„í•´ Map ì‚¬ìš©
  
  archives.forEach(archive => {
    archive.uploads.forEach(upload => {
      if (upload.subtitle && upload.subtitle.includes('ë‹¤ìŒ ì§€ëª©:')) {
        const match = upload.subtitle.match(/ë‹¤ìŒ ì§€ëª©:\s*(.+?)(?:\s*Â·\s*|$)/);
        if (match && match[1]) {
          const nominationText = match[1].trim();
          // "ì…€ / ì´ë¦„" í˜•ì‹ íŒŒì‹±
          const parts = nominationText.split('/').map(s => s.trim()).filter(s => s);
          if (parts.length >= 2) {
            const cell = parts[0] || '';
            const name = parts[1] || '';
            const key = `${cell}::${name}`;
            if (!nominated.has(key)) {
              nominated.set(key, { cell, name, count: 0 });
            }
            nominated.get(key).count++;
          } else if (parts.length === 1) {
            // ì´ë¦„ë§Œ ìˆëŠ” ê²½ìš°
            const name = parts[0];
            const key = `::${name}`;
            if (!nominated.has(key)) {
              nominated.set(key, { cell: '', name, count: 0 });
            }
            nominated.get(key).count++;
          }
        }
      }
    });
  });
  
  return Array.from(nominated.values()).sort((a, b) => b.count - a.count);
};

const renderNominatedList = (archives) => {
  const nominatedListEl = document.getElementById('nominated-list');
  if (!nominatedListEl) return;
  
  const nominated = extractNominatedPeople(archives);
  
  nominatedListEl.innerHTML = '';
  
  if (nominated.length === 0) {
    const empty = document.createElement('p');
    empty.style.margin = '0';
    empty.style.textAlign = 'center';
    empty.style.color = 'rgba(255,255,255,0.6)';
    empty.style.fontSize = '0.9rem';
    empty.textContent = 'ì•„ì§ ì§€ëª©ëœ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤.';
    nominatedListEl.appendChild(empty);
    return;
  }
  
  nominated.forEach(({ cell, name, count }) => {
    const item = document.createElement('div');
    item.style.display = 'flex';
    item.style.justifyContent = 'space-between';
    item.style.alignItems = 'center';
    item.style.padding = '0.6rem 0.8rem';
    item.style.background = 'rgba(255,255,255,0.05)';
    item.style.borderRadius = '0.6rem';
    item.style.border = '1px solid rgba(255,255,255,0.1)';
    item.style.gap = '0.6rem';
    item.style.flexWrap = 'wrap';
    item.style.maxWidth = '100%';

    const leftGroup = document.createElement('div');
    leftGroup.style.display = 'flex';
    leftGroup.style.gap = '0.8rem';
    leftGroup.style.alignItems = 'center';
    leftGroup.style.flex = '1 1 auto';
    leftGroup.style.minWidth = '0';

    const info = document.createElement('div');
    info.style.display = 'flex';
    info.style.gap = '0.6rem';
    info.style.alignItems = 'center';
    info.style.flex = '1 1 auto';
    info.style.minWidth = '0';
    info.style.overflow = 'hidden';
    info.style.flexWrap = 'wrap';
    info.style.wordBreak = 'break-word';

    const cellSpan = document.createElement('span');
    cellSpan.style.color = '#f5f2ff';
    cellSpan.style.fontWeight = '600';
    cellSpan.textContent = cell || 'ë¯¸ì§€ì •';

    const nameSpan = document.createElement('span');
    nameSpan.style.color = 'rgba(255,255,255,0.8)';
    nameSpan.textContent = name;

    if (cell) {
      info.appendChild(cellSpan);
      if (name) {
        const separator = document.createElement('span');
        separator.style.color = 'rgba(255,255,255,0.5)';
        separator.textContent = ' / ';
        info.appendChild(separator);
        info.appendChild(nameSpan);
      }
    } else if (name) {
      info.appendChild(nameSpan);
    }

    const countBadge = document.createElement('span');
    countBadge.style.background = 'rgba(255,154,158,0.3)';
    countBadge.style.color = '#ff9a9e';
    countBadge.style.padding = '0.2rem 0.5rem';
    countBadge.style.borderRadius = '999px';
    countBadge.style.fontSize = '0.75rem';
    countBadge.style.fontWeight = '600';
    countBadge.textContent = `${count}íšŒ`;

    const registerBtn = document.createElement('button');
    registerBtn.type = 'button';
    registerBtn.textContent = 'ë“±ë¡í•˜ê¸°';
    registerBtn.style.padding = '0.4rem 0.9rem';
    registerBtn.style.border = 'none';
    registerBtn.style.borderRadius = '999px';
    registerBtn.style.background = 'linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%)';
    registerBtn.style.color = '#341d2f';
    registerBtn.style.fontSize = '0.85rem';
    registerBtn.style.fontWeight = '600';
    registerBtn.style.cursor = 'pointer';
    registerBtn.style.transition = 'filter 0.15s ease';
    registerBtn.style.flexShrink = '0';
    registerBtn.style.marginLeft = 'auto';
    registerBtn.style.marginTop = '0.2rem';
    registerBtn.onmouseover = function() { this.style.filter = 'brightness(1.05)'; };
    registerBtn.onmouseout = function() { this.style.filter = 'none'; };
    registerBtn.dataset.cell = cell || '';
    registerBtn.dataset.name = name || '';
    registerBtn.addEventListener('click', function() {
      const targetCell = this.dataset.cell || '';
      const targetName = this.dataset.name || '';
      
      console.log('ë“±ë¡í•˜ê¸° ë²„íŠ¼ í´ë¦­:', { targetCell, targetName });
      
      // ë“±ë¡ í¼ ì°¾ê¸°
      if (!archives || archives.length === 0) {
        console.error('archivesê°€ ì—†ìŠµë‹ˆë‹¤.');
        alert('ë“±ë¡ í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const archive = archives[0];
      if (!archive || !archive.elements) {
        console.error('archive ë˜ëŠ” elementsê°€ ì—†ìŠµë‹ˆë‹¤.');
        alert('ë“±ë¡ í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const cellInput = archive.elements.cellInput;
      const nameInput = archive.elements.nameInput;
      if (!cellInput || !nameInput) {
        console.error('ì…€ ë˜ëŠ” ì´ë¦„ ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', archive.elements);
        alert('ë“±ë¡ì ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      console.log('ë“±ë¡ì ì…ë ¥ í•„ë“œì— ê°’ ì„¤ì •:', { targetCell, targetName });
      cellInput.value = targetCell;
      nameInput.value = targetName;
      
      // í¼ìœ¼ë¡œ ìŠ¤í¬ë¡¤
      archive.elements.form.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      // ì œëª© ì…ë ¥ í•„ë“œë¡œ í¬ì»¤ìŠ¤
      setTimeout(() => {
        if (archive.elements.titleInput) {
          archive.elements.titleInput.focus();
        }
      }, 300);
    });
    
    leftGroup.appendChild(info);
    leftGroup.appendChild(countBadge);
    
    item.appendChild(leftGroup);
    item.appendChild(registerBtn);
    nominatedListEl.appendChild(item);
  });
};

const renderUploads = (archive) => {
  const list = archive.elements.list;
  list.innerHTML = '';
  if (!archive.uploads.length) {
    const empty = document.createElement('p');
    empty.className = 'upload-empty';
    empty.textContent = 'ë“±ë¡ëœ ì˜ìƒì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤. ìœ„ í¼ì„ ì‚¬ìš©í•´ ì¶”ê°€í•´ ë³´ì„¸ìš”.';
    list.append(empty);
    return;
  }
  archive.uploads.forEach((item, index) => {
    const article = document.createElement('article');
    article.className = 'upload-item';

    const mediaWrap = document.createElement('div');
    mediaWrap.className = 'upload-video';
    const isImage = /\.(png|jpe?g|gif|webp|bmp|svg)(\?|$)/i.test(item.src || '');
    if (isImage) {
      const img = document.createElement('img');
      img.loading = 'lazy';
      img.decoding = 'async';
      img.src = item.src;
      img.alt = item.title || 'ì´ë¯¸ì§€';
      img.style.display = 'block';
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'cover';
      img.style.background = 'rgba(0,0,0,0.3)';
      mediaWrap.append(img);
    } else {
      const video = document.createElement('video');
      video.controls = true;
      video.preload = 'metadata';
      video.src = item.src;
      video.poster = item.poster;
      mediaWrap.append(video);
    }

    const info = document.createElement('div');
    info.className = 'upload-info';
    const title = document.createElement('strong');
    title.textContent = item.title;
    
    // subtitle íŒŒì‹±: "ë“±ë¡ì Â· ì‹œê°„ Â· ë‹¤ìŒ ì§€ëª©: ì…€ / ì´ë¦„" í˜•ì‹
    let authorInfo = '';
    let timeInfo = '';
    let nominationInfo = '';
    
    if (item.subtitle) {
      // ì§€ëª© ì •ë³´ ë¶„ë¦¬
      const nomMatch = item.subtitle.match(/ë‹¤ìŒ ì§€ëª©:\s*(.+?)(?:\s*Â·\s*|$)/);
      if (nomMatch) {
        nominationInfo = nomMatch[1].trim();
      }
      
      // ì§€ëª© ì •ë³´ë¥¼ ì œì™¸í•œ ë¶€ë¶„ì—ì„œ ë“±ë¡ìì™€ ì‹œê°„ ì¶”ì¶œ
      let remainingSubtitle = item.subtitle;
      if (nomMatch) {
        remainingSubtitle = item.subtitle.replace(/Â·\s*ë‹¤ìŒ ì§€ëª©:.*$/, '').trim();
      }
      
      // "ë“±ë¡ì Â· ì‹œê°„" í˜•ì‹ íŒŒì‹±
      const parts = remainingSubtitle.split('Â·').map(s => s.trim()).filter(s => s);
      if (parts.length >= 2) {
        authorInfo = parts[0];
        timeInfo = parts[1];
      } else if (parts.length === 1) {
        // ì‹œê°„ í˜•ì‹ í™•ì¸ (YYYY-MM-DD Â· HH:MM í˜•ì‹)
        if (/\d{4}-\d{2}-\d{2}/.test(parts[0])) {
          timeInfo = parts[0];
        } else {
          authorInfo = parts[0];
        }
      }
    }
    
    const subtitleContainer = document.createElement('div');
    subtitleContainer.style.display = 'flex';
    subtitleContainer.style.flexDirection = 'column';
    subtitleContainer.style.gap = '0.3rem';
    subtitleContainer.style.marginTop = '0.4rem';
    
    if (authorInfo || timeInfo) {
      const authorTime = document.createElement('span');
      authorTime.style.fontSize = '0.9rem';
      authorTime.style.color = 'rgba(255,255,255,0.7)';
      if (authorInfo && timeInfo) {
        authorTime.textContent = `${authorInfo} Â· ${timeInfo}`;
      } else if (authorInfo) {
        authorTime.textContent = authorInfo;
      } else if (timeInfo) {
        authorTime.textContent = timeInfo;
      }
      subtitleContainer.appendChild(authorTime);
    }
    
    if (nominationInfo) {
      const nomination = document.createElement('span');
      nomination.style.fontSize = '0.85rem';
      nomination.style.color = '#ff9a9e';
      nomination.style.fontWeight = '500';
      nomination.textContent = `ğŸ‘‰ ë‹¤ìŒ ì§€ëª©: ${nominationInfo}`;
      subtitleContainer.appendChild(nomination);
    }
    
    info.append(title);
    if (subtitleContainer.children.length > 0) {
      info.appendChild(subtitleContainer);
    }

    const actions = document.createElement('div');
    actions.className = 'upload-actions';
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.textContent = 'ì‚­ì œ';
    removeBtn.dataset.remove = index;
    if (item.id) {
      removeBtn.dataset.id = item.id;
    }
    actions.append(removeBtn);

    article.append(mediaWrap, info, actions);
    list.append(article);
  });
  
  // ì§€ëª©ëœ ì‚¬ëŒë“¤ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
  renderNominatedList(archives);
};

const resetSelectedFile = (archive) => {
  archive.selectedFile = null;
  archive.elements.dropzone.classList.remove('has-file', 'uploading');
  archive.elements.dropzoneStatus.textContent = 'ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.';
};

const setSelectedFile = (archive, file) => {
  if (!file) return;
  if (!file.type.startsWith('video/') && !file.type.startsWith('image/')) {
    alert('ì˜ìƒ ë˜ëŠ” ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    return;
  }
  archive.selectedFile = file;
  archive.elements.dropzone.classList.add('has-file');
  archive.elements.dropzoneStatus.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(1)}MB)`;
};

const uploadToCloud = async (archive, file) => {
  archive.elements.dropzone.classList.add('uploading');
  archive.elements.dropzoneStatus.textContent = 'ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤â€¦';
  archive.elements.submitButton.disabled = true;

  addLog(archive.section.id, 'ì—…ë¡œë“œ ì‹œì‘', file.name, `size=${(file.size / 1024 / 1024).toFixed(2)}MB`);

  try {
    archive.elements.dropzoneStatus.textContent = 'í´ë¼ìš°ë“œ ì—…ë¡œë“œ ì¤‘...';
    const { publicUrl, path } = await uploadToSupabaseStorage(archive, file);
    addLog(archive.section.id, 'í´ë¼ìš°ë“œ ì—…ë¡œë“œ', publicUrl, path);
    return { publicUrl, path };
  } catch (error) {
    addLog(archive.section.id, 'í´ë¼ìš°ë“œ ì—…ë¡œë“œ ì‹¤íŒ¨', error.message);
    throw error;
  }
};

const seedUploads = async (archive) => {
  try {
    await fetchUploadsFromCloud(archive);
  } catch (error) {
    console.error('í´ë¼ìš°ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
    addLog(archive.section.id, 'í´ë¼ìš°ë“œ ë¡œë“œ ì‹¤íŒ¨', error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
    archive.uploads = [...archive.section.defaults];
  }
  renderUploads(archive);
  // ì§€ëª©ëœ ì‚¬ëŒë“¤ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
  renderNominatedList(archives);
};

const handleRemove = async (event, archive) => {
  const target = event.target.closest('button[data-remove]');
  if (!target) return;
  const index = Number(target.dataset.remove);
  if (Number.isNaN(index)) return;
  const upload = archive.uploads[index];
  if (!upload) return;
  if (!confirm('ì´ ì˜ìƒì„ ì‚­ì œí• ê¹Œìš”?')) return;

  try {
    await removeUploadRecord(archive, upload);
    archive.uploads.splice(index, 1);
    renderUploads(archive);
    addLog(archive.section.id, 'ì˜ìƒ ì‚­ì œ', upload.title, upload.id ? `id=${upload.id}` : undefined);
  } catch (error) {
    console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
    addLog(archive.section.id, 'ì‚­ì œ ì‹¤íŒ¨', error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
    alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  }
};

const handleSubmit = async (event, archive) => {
  event.preventDefault();
  const cell = archive.elements.cellInput.value.trim();
  const name = archive.elements.nameInput.value.trim();
  if (!cell || !name) {
    alert('ë“±ë¡ìì˜ ì…€ëª…ê³¼ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    if (!cell) {
      archive.elements.cellInput.focus();
    } else {
      archive.elements.nameInput.focus();
    }
    return;
  }
  const author = `${cell} / ${name}`;
  const title = archive.elements.titleInput.value.trim();
  if (!title) {
    alert('ì˜ìƒ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    archive.elements.titleInput.focus();
    return;
  }
  if (!archive.selectedFile) {
    alert('ì—…ë¡œë“œí•  ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  let uploadMetadata = null;
  try {
    uploadMetadata = await uploadToCloud(archive, archive.selectedFile);
    const newItem = {
      title,
      subtitle: `${author} Â· ${formatNow()}`,
      src: uploadMetadata.publicUrl,
      poster: fallbackPoster(archive.section, title)
    };
    const saved = await insertUploadRecord(archive, newItem);
    archive.uploads.unshift(saved);
    archive.uploads = archive.uploads.slice(0, MAX_UPLOADS);
    renderUploads(archive);
    archive.elements.form.reset();
    resetSelectedFile(archive);
    archive.elements.dropzoneStatus.textContent = 'ì—…ë¡œë“œ ì™„ë£Œ! ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.';
    addLog(archive.section.id, 'ì—…ë¡œë“œ ì™„ë£Œ', saved.title, saved.id ? `id=${saved.id}` : undefined);

    // ì—…ë¡œë“œ ì™„ë£Œ í›„ ì§€ëª© ëª¨ë‹¬ í‘œì‹œ
    lastUploadedItem = saved;
    if (nominateModal && nominateCellInput && nominateNameInput) {
      nominateCellInput.value = '';
      nominateNameInput.value = '';
      nominateModal.style.display = 'flex';
      // ì…€ ì…ë ¥ í•„ë“œë¡œ í¬ì»¤ìŠ¤
      setTimeout(() => {
        if (nominateCellInput) nominateCellInput.focus();
      }, 100);
    }
  } catch (error) {
    console.error(error);
    archive.elements.dropzoneStatus.textContent = 'ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    addLog(archive.section.id, 'ì—…ë¡œë“œ ì‹¤íŒ¨', error.message || String(error));
    alert('ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    if (uploadMetadata?.path) {
      try {
        await supabase.storage.from(SUPABASE_BUCKET).remove([uploadMetadata.path]);
        addLog(archive.section.id, 'ì •ë¦¬ ì™„ë£Œ', 'ë¶€ë¶„ ì—…ë¡œë“œ íŒŒì¼ ì‚­ì œ', uploadMetadata.path);
      } catch (cleanupError) {
        console.warn('ì„ì‹œ íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨:', cleanupError);
      }
    }
  } finally {
    archive.elements.dropzone.classList.remove('uploading');
    archive.elements.submitButton.disabled = false;
  }
};

const createArchive = (section) => {
  const fragment = template.content.cloneNode(true);
  const archiveEl = fragment.querySelector('.archive');
  archiveEl.dataset.section = section.id;
  archiveEl.querySelector('.archive-title').textContent = section.title;
  archiveEl.querySelector('.archive-description').textContent = section.description;

  const list = archiveEl.querySelector('.upload-list');
  const form = archiveEl.querySelector('.upload-form');
  const cellInput = archiveEl.querySelector('.upload-cell');
  const nameInput = archiveEl.querySelector('.upload-name');
  const titleInput = archiveEl.querySelector('.upload-title');
  const dropzone = archiveEl.querySelector('.dropzone');
  const dropzoneStatus = archiveEl.querySelector('.dropzone-status');
  const selectButton = archiveEl.querySelector('.select-button');
  const fileInput = archiveEl.querySelector('.upload-file');
  const submitButton = archiveEl.querySelector('.submit-button');

  const archive = {
    section,
    elements: { list, form, cellInput, nameInput, titleInput, dropzone, dropzoneStatus, selectButton, fileInput, submitButton },
    uploads: [],
    selectedFile: null,
  };

  selectButton.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (event) => {
    setSelectedFile(archive, event.target.files?.[0]);
    fileInput.value = '';
  });
  ['dragenter', 'dragover'].forEach((type) => {
    dropzone.addEventListener(type, (event) => {
      event.preventDefault();
      dropzone.classList.add('hover');
    });
  });
  ['dragleave', 'drop'].forEach((type) => {
    dropzone.addEventListener(type, (event) => {
      event.preventDefault();
      dropzone.classList.remove('hover');
    });
  });
  dropzone.addEventListener('drop', (event) => {
    setSelectedFile(archive, event.dataTransfer.files?.[0]);
  });
  form.addEventListener('submit', (event) => handleSubmit(event, archive));
  list.addEventListener('click', (event) => handleRemove(event, archive));
  resetSelectedFile(archive);

  container.appendChild(fragment);
  // archive.elementsëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì„¤ì •í–ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì—…ë°ì´íŠ¸ë§Œ í•„ìš”í•˜ë©´ ì—…ë°ì´íŠ¸
  return archive;
};

const archives = sections.map(createArchive);
loadLogs();
renderLogs();
archives.forEach(async (archive) => await seedUploads(archive));

if (ENABLE_LOGS && logCopyBtn) {
  logCopyBtn.addEventListener('click', async () => {
    const payload = JSON.stringify(logs, null, 2);
    try {
      await navigator.clipboard.writeText(payload);
      alert('ë¡œê·¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } catch (error) {
      alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  });
}

if (ENABLE_LOGS && logClearBtn) {
  logClearBtn.addEventListener('click', () => {
    if (!logs.length) return;
    if (!confirm('ë¡œê·¸ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
    logs = [];
    persistLogs();
    renderLogs();
  });
}

// ì§€ëª© ëª¨ë‹¬ ì´ë²¤íŠ¸
if (nominateConfirmBtn && nominateCellInput && nominateNameInput) {
  nominateConfirmBtn.addEventListener('click', async () => {
    const cell = (nominateCellInput?.value || '').trim();
    const name = (nominateNameInput?.value || '').trim();
    if (!lastUploadedItem) {
      nominateModal.style.display = 'none';
      return;
    }
    
    let mention = '';
    if (cell && name) {
      mention = `ë‹¤ìŒ ì§€ëª©: ${cell} / ${name}`;
    } else if (cell || name) {
      // ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì…ë ¥ëœ ê²½ìš°ë„ ì²˜ë¦¬
      mention = `ë‹¤ìŒ ì§€ëª©: ${cell || name}`;
    }
    
    if (mention) {
      // ë¡œì»¬ ë°˜ì˜
      lastUploadedItem.subtitle = `${lastUploadedItem.subtitle} Â· ${mention}`;
      // ì›ê²© ì—…ë°ì´íŠ¸ ì‹œë„
      try {
        if (lastUploadedItem.id) {
          const { error } = await supabase
            .from(SUPABASE_TABLE)
            .update({ subtitle: lastUploadedItem.subtitle })
            .eq('id', lastUploadedItem.id);
          if (error) console.warn('ì§€ëª© ì €ì¥ ì‹¤íŒ¨:', error.message);
        }
      } catch (e) {
        console.warn('ì§€ëª© ì €ì¥ ì˜¤ë¥˜:', e);
      }
      // í™”ë©´ ê°±ì‹ 
      renderUploads(archives[0]);
    }
    nominateModal.style.display = 'none';
    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    if (nominateCellInput) nominateCellInput.value = '';
    if (nominateNameInput) nominateNameInput.value = '';
    lastUploadedItem = null;
  });
}

if (nominateSkipBtn) {
  nominateSkipBtn.addEventListener('click', () => {
    if (nominateModal) nominateModal.style.display = 'none';
    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    if (nominateCellInput) nominateCellInput.value = '';
    if (nominateNameInput) nominateNameInput.value = '';
    lastUploadedItem = null;
  });
}

if (syncCloudBtn) {
  syncCloudBtn.addEventListener('click', async () => {
    if (!archives.length) return;
    const archive = archives[0];

    syncCloudBtn.disabled = true;
    syncCloudBtn.textContent = 'ë™ê¸°í™” ì¤‘...';

    try {
      await fetchUploadsFromCloud(archive, { addLogEntry: true });
      renderUploads(archive);
      alert('í´ë¼ìš°ë“œì—ì„œ ìµœì‹  ëª©ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
    } catch (error) {
      console.error('ë™ê¸°í™” ì‹¤íŒ¨:', error);
      addLog(archive.section.id, 'ë™ê¸°í™” ì‹¤íŒ¨', error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
      alert('ë™ê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } finally {
      syncCloudBtn.disabled = false;
      syncCloudBtn.textContent = 'í´ë¼ìš°ë“œ ë™ê¸°í™”';
    }
  });
}

// í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
if (testSupabaseBtn) {
  testSupabaseBtn.addEventListener('click', testSupabaseConnection);
}
if (testDatabaseBtn) {
  testDatabaseBtn.addEventListener('click', testDatabase);
}
if (testStorageBtn) {
  testStorageBtn.addEventListener('click', testStorage);
}

// QR ì½”ë“œ ìƒì„± (í˜ì´ì§€ ë¡œë“œ í›„ ì‹¤í–‰)
(function() {
  function generateQRCode() {
    const qrImg = document.getElementById('qr-code-img');
    if (!qrImg) {
      console.error('QR ì½”ë“œ ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    try {
      const currentUrl = window.location.href;
      console.log('QR ì½”ë“œ ìƒì„± ì‹œì‘:', currentUrl);
      
      // ì™¸ë¶€ APIë¥¼ ì‚¬ìš©í•˜ì—¬ QR ì½”ë“œ ìƒì„±
      const apiUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=120x120&margin=1&data=' + encodeURIComponent(currentUrl);
      qrImg.src = apiUrl;
      qrImg.onload = function() {
        console.log('QR ì½”ë“œ ë¡œë“œ ì„±ê³µ');
      };
      qrImg.onerror = function() {
        console.error('QR ì½”ë“œ ë¡œë“œ ì‹¤íŒ¨');
        // ëŒ€ì²´: ë¡œì»¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© ì‹œë„
        if (typeof QRCode !== 'undefined') {
          const canvas = document.createElement('canvas');
          QRCode.toCanvas(canvas, currentUrl, {
            width: 120,
            margin: 1,
            color: {
              dark: '#000000',
              light: '#FFFFFF'
            }
          }, function(error) {
            if (!error) {
              qrImg.src = canvas.toDataURL();
            } else {
              console.error('QR ì½”ë“œ ìƒì„± ì‹¤íŒ¨:', error);
            }
          });
        }
      };
    } catch (error) {
      console.error('QR ì½”ë“œ ìƒì„± ì˜¤ë¥˜:', error);
    }
  }
  
  // DOM ë¡œë“œ ì™„ë£Œ í›„ ì‹¤í–‰
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', generateQRCode);
  } else {
    generateQRCode();
  }
})();
    </script>
  </body>
</html>

