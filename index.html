<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8">
    <title>감다살 영상 아카이브</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style id="gemini-new-design">
      :root {
        --primary: #6c63ff;
        --primary-dark: #4a3ecf;
        --accent: #ff8aa2;
        --background-start: #f6f7ff;
        --background-end: #eef3ff;
        --surface: rgba(255, 255, 255, 0.88);
        --surface-solid: #ffffff;
        --border: rgba(108, 99, 255, 0.14);
        --text-strong: #1c1f3b;
        --text-muted: #5c5f7f;
        --text-soft: #8d93b5;
        --shadow-soft: 0 24px 60px rgba(28, 31, 59, 0.12);
        --shadow-small: 0 14px 32px rgba(28, 31, 59, 0.08);
        --radius-large: 24px;
      }
      * { box-sizing: border-box; }
      html, body { -webkit-text-size-adjust: 100%; }
      img, video { max-width: 100%; height: auto; display: block; }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: 'Pretendard', 'Apple SD Gothic Neo', 'Segoe UI', sans-serif;
        color: var(--text-muted);
        background:
          radial-gradient(circle at 20% 20%, rgba(125, 115, 255, 0.12), transparent 60%),
          linear-gradient(160deg, var(--background-start), var(--background-end));
      }

      main {
        width: min(960px, 100%);
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: clamp(2.8rem, 6vw, 3.8rem);
        padding: clamp(2.4rem, 6vw, 3.6rem) clamp(1.8rem, 4vw, 3rem);
      }

      button { font-family: inherit; cursor: pointer; }

      header {
        position: relative;
        display: grid;
        gap: clamp(1.8rem, 4vw, 2.6rem);
        text-align: center;
        padding: clamp(2.8rem, 6vw, 3.6rem) clamp(1.6rem, 4vw, 2.8rem);
        border-radius: var(--radius-large);
        background: var(--surface);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-soft);
        overflow: hidden;
      }
      header::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(108, 99, 255, 0.2), rgba(255, 138, 162, 0.18));
        filter: blur(48px);
        opacity: 0.7;
        z-index: 0;
      }
      header > * { position: relative; z-index: 1; }
      .hero-copy {
        display: grid;
        gap: 1.2rem;
        justify-items: center;
      }
      header h1 {
        margin: 0;
        font-size: clamp(2.6rem, 6vw, 3.4rem);
        color: var(--text-strong);
        font-weight: 800;
        letter-spacing: -0.03em;
      }
      header p {
        margin: 1rem auto 0;
        max-width: 48ch;
        font-size: clamp(1.05rem, 2vw, 1.25rem);
        color: var(--text-soft);
        line-height: 1.6;
      }
      .qr-wrapper {
        margin-top: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
      }
      .hero-visual {
        margin: 0;
        justify-self: center;
      }
      .hero-visual img {
        width: min(260px, 100%);
        border-radius: 20px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-small);
      }
      #qr-code-container {
        padding: 0.75rem;
        border-radius: 16px;
        background: var(--surface-solid);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-small);
      }
      #qr-code-img { width: 120px; height: 120px; }
      .qr-hint { margin: 0; font-size: 0.9rem; color: var(--text-soft); }

      .intro-section {
        background: var(--surface);
        border-radius: var(--radius-large);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-small);
        padding: clamp(2.2rem, 5vw, 3.2rem);
      }
      .intro-layout {
        display: grid;
        gap: clamp(1.6rem, 4vw, 2.4rem);
        align-items: center;
      }
      .intro-copy {
        display: grid;
        gap: 1rem;
        text-align: center;
        justify-items: center;
      }
      .intro-title { margin: 0; font-size: clamp(1.8rem, 4.5vw, 2.4rem); color: var(--text-strong); font-weight: 800; letter-spacing: -0.02em; }
      .intro-sub { margin: 0; font-size: clamp(1rem, 2.5vw, 1.15rem); color: var(--text-soft); line-height: 1.65; }
      .intro-steps {
        margin: 0;
        padding-left: 1.2rem;
        display: grid;
        gap: 0.6rem;
        color: var(--text-muted);
        font-size: 0.95rem;
        line-height: 1.6;
        text-align: left;
        list-style-position: outside;
      }
      .intro-steps li::marker { color: var(--accent); font-weight: 600; }
      .intro-card {
        position: relative;
        border-radius: 18px;
        overflow: hidden;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-small);
        min-width: 220px;
        background: var(--surface-solid);
        transition: transform 0.25s ease, box-shadow 0.25s ease;
      }
      .intro-card img {
        width: 100%;
        height: 100%;
        aspect-ratio: 4 / 5;
        object-fit: cover;
        display: block;
      }
      .intro-card:hover { transform: translateY(-6px); box-shadow: 0 26px 40px rgba(108, 99, 255, 0.25); }
      .intro-visual {
        margin: 0;
        justify-self: center;
      }
      .intro-visual img { max-width: 320px; }
      .intro-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
        justify-content: center;
      }
      .intro-badges span {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.45rem 0.85rem;
        border-radius: 999px;
        background: rgba(108, 99, 255, 0.12);
        color: var(--primary-dark);
        font-size: 0.85rem;
        font-weight: 600;
      }

      .thanks-highlight {
        background: var(--surface);
        border-radius: var(--radius-large);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-small);
        padding: clamp(2.2rem, 5vw, 3rem);
      }
      .thanks-highlight-inner {
        display: grid;
        gap: 1.1rem;
        text-align: center;
        justify-items: center;
      }
      .thanks-highlight h3 {
        margin: 0;
        font-size: clamp(1.6rem, 4vw, 2.1rem);
        color: var(--text-strong);
        font-weight: 700;
      }
      .thanks-highlight p {
        margin: 0;
        color: var(--text-soft);
        line-height: 1.6;
      }
      .thanks-highlight-card {
        margin: 0;
        width: 100%;
      }
      .thanks-highlight-card img {
        width: min(280px, 100%);
        margin: 0 auto;
        display: block;
        border-radius: 18px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-small);
      }

      #nominated-list-section {
        background: var(--surface);
        border-radius: var(--radius-large);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-small);
        padding: clamp(2rem, 5vw, 2.6rem);
        display: grid;
        gap: 1.8rem;
      }
      #nominated-list-section h3 {
        margin: 0;
        font-size: 1.5rem;
        color: var(--text-strong);
        font-weight: 700;
        text-align: center;
      }
      #nominated-list { display: grid; gap: 1rem; }
      #nominated-list p {
        margin: 0;
        padding: 1.5rem;
        border-radius: 16px;
        background: var(--surface-solid);
        border: 1px solid var(--border);
        color: var(--text-soft);
        text-align: center;
      }
      .nominated-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        padding: 1.1rem 1.4rem;
        border-radius: 18px;
        background: var(--surface-solid);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-small);
        flex-wrap: wrap;
      }
      .nominated-item-left { display: flex; align-items: center; gap: 1rem; flex: 1 1 auto; min-width: 200px; }
      .nominated-item-info { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; color: var(--text-strong); font-weight: 600; }
      .nominated-item-cell { color: var(--text-strong); }
      .nominated-item-name { color: var(--text-soft); font-weight: 500; }
      .nominated-item-separator { color: rgba(92, 95, 127, 0.4); }
      .nominated-item-button {
        background: linear-gradient(135deg, var(--primary), var(--accent));
        color: #fff;
        padding: 0.65rem 1.4rem;
        border-radius: 999px;
        border: none;
        font-weight: 600;
        box-shadow: 0 12px 24px rgba(108, 99, 255, 0.3);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .nominated-item-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 28px rgba(108, 99, 255, 0.35);
      }

      .archive {
        background: var(--surface);
        border-radius: var(--radius-large);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-soft);
        padding: clamp(2rem, 5vw, 3rem);
        display: grid;
        gap: 2.5rem;
      }
      .archive-header { text-align: center; display: grid; gap: 0.6rem; margin: 0; }
      .archive-title { margin: 0; font-size: clamp(1.8rem, 5vw, 2.3rem); color: var(--text-strong); font-weight: 700; }
      .archive-description { margin: 0; color: var(--text-soft); max-width: 58ch; justify-self: center; }

      .upload-list { display: grid; gap: 2rem; }
      .upload-empty {
        margin: 0;
        text-align: center;
        padding: 2rem;
        border-radius: 18px;
        background: var(--surface-solid);
        border: 1px solid var(--border);
        color: var(--text-soft);
      }
      .upload-item {
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        grid-template-areas:
          'video'
          'info';
        gap: 1.4rem;
        justify-items: center;
        text-align: center;
        padding: 1.5rem;
        border-radius: 20px;
        background: var(--surface-solid);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-small);
      }
      .upload-item.has-actions {
        grid-template-areas:
          'video'
          'info'
          'actions';
      }
      .upload-video {
        grid-area: video;
        width: 100%;
        max-width: clamp(300px, 80vw, 520px);
        border-radius: 20px;
        overflow: hidden;
        background: rgba(108, 99, 255, 0.08);
        box-shadow: var(--shadow-soft);
        justify-self: center;
        aspect-ratio: 16 / 9;
      }
      .upload-video video,
      .upload-video img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .upload-info {
        grid-area: info;
        width: min(520px, 100%);
        display: grid;
        gap: 1rem;
        justify-items: stretch;
      }
      .upload-info-meta { font-size: 0.95rem; color: var(--text-soft); }
      .upload-meta {
        display: grid;
        gap: 0.65rem;
      }
      .upload-meta-row {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 0.6rem;
        align-items: baseline;
      }
      .upload-meta-label {
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        background: rgba(108, 99, 255, 0.12);
        color: var(--primary-dark);
        font-size: 0.8rem;
        font-weight: 700;
        letter-spacing: 0.02em;
      }
      .upload-meta-value {
        font-size: 1.05rem;
        color: var(--text-strong);
        font-weight: 600;
      }
      .upload-meta-timestamp { color: var(--text-soft); font-weight: 500; font-size: 0.95rem; }
      .upload-meta-nomination {
        color: var(--accent);
        font-weight: 600;
      }
      .upload-actions {
        grid-area: actions;
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        justify-content: center;
      }
      .upload-actions button {
        background: rgba(108, 99, 255, 0.12);
        color: var(--primary-dark);
        border: none;
        border-radius: 999px;
        padding: 0.55rem 1.4rem;
        font-weight: 600;
        transition: background 0.2s ease, transform 0.2s ease;
      }
      .upload-actions button:hover {
        background: rgba(108, 99, 255, 0.2);
        transform: translateY(-2px);
      }

      .upload-form {
        display: grid;
        gap: 1.4rem;
        padding: 1.6rem;
        border-radius: 20px;
        background: var(--surface-solid);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-small);
      }
      .upload-form label { font-weight: 700; color: var(--text-strong); font-size: 1rem; }
      .two-inputs { display: grid; gap: 1rem; grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .upload-form input {
        width: 100%;
        border-radius: 14px;
        padding: 0.85rem 1rem;
        border: 1px solid rgba(108, 99, 255, 0.18);
        background: rgba(255, 255, 255, 0.9);
        color: var(--text-strong);
        font-size: 1rem;
        transition: border 0.2s ease, box-shadow 0.2s ease;
      }
      .upload-form input::placeholder { color: rgba(92, 95, 127, 0.5); }
      .upload-form input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.15);
      }
      .dropzone {
        border: 1.5px dashed rgba(108, 99, 255, 0.35);
        border-radius: 20px;
        padding: 1.8rem;
        display: grid;
        gap: 0.8rem;
        justify-items: center;
        background: rgba(108, 99, 255, 0.05);
        transition: border-color 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
        text-align: center;
      }
      .dropzone strong { font-size: 1.05rem; color: var(--text-strong); }
      .dropzone .dropzone-status { font-size: 0.95rem; color: var(--text-soft); }
      .dropzone.hover,
      .dropzone.has-file {
        border-color: var(--primary);
        background: rgba(108, 99, 255, 0.1);
        box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.15);
      }
      .dropzone.uploading { opacity: 0.8; }
      .select-button {
        background: rgba(255, 255, 255, 0.85);
        border-radius: 999px;
        padding: 0.55rem 1.6rem;
        border: 1px solid rgba(108, 99, 255, 0.25);
        color: var(--primary-dark);
        font-weight: 600;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .select-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 20px rgba(108, 99, 255, 0.18);
      }
      .upload-hint { color: var(--text-soft); font-size: 0.9rem; text-align: center; display: block; }
      .submit-button {
        background: linear-gradient(135deg, var(--primary), var(--accent));
        border: none;
        border-radius: 999px;
        color: #fff;
        padding: 0.85rem 2.4rem;
        font-size: 1.05rem;
        font-weight: 700;
        cursor: pointer;
        justify-self: center;
        box-shadow: 0 18px 36px rgba(108, 99, 255, 0.35);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .submit-button:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 22px 40px rgba(108, 99, 255, 0.38);
      }
      .submit-button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }

      #nominate-modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(27, 29, 59, 0.45);
        backdrop-filter: blur(18px);
        padding: 1.5rem;
        z-index: 50;
      }
      #nominate-modal > div {
        width: min(440px, 100%);
        background: var(--surface-solid);
        border-radius: 20px;
        padding: 2rem;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-soft);
        display: grid;
        gap: 1.4rem;
      }
      #nominate-modal h3 { margin: 0; color: var(--text-strong); font-size: 1.4rem; font-weight: 700; }
      #nominate-modal p { margin: 0; color: var(--text-soft); font-size: 1rem; line-height: 1.5; }
      #nominate-modal label { font-weight: 600; color: var(--text-strong); }
      #nominate-modal input {
        width: 100%;
        border-radius: 14px;
        padding: 0.85rem 1rem;
        border: 1px solid rgba(108, 99, 255, 0.2);
        background: rgba(255, 255, 255, 0.95);
        font-size: 1rem;
      }
      #nominate-modal input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.15);
      }
      #nominate-modal .two-inputs { display: grid; gap: 1rem; grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .nominate-actions { display: flex; justify-content: flex-end; gap: 0.8rem; }
      #nominate-skip {
        background: rgba(108, 99, 255, 0.08);
        border: none;
        color: var(--primary-dark);
        border-radius: 999px;
        padding: 0.6rem 1.4rem;
        font-weight: 600;
      }
      #nominate-skip:hover { background: rgba(108, 99, 255, 0.15); }
      #nominate-confirm {
        background: linear-gradient(135deg, var(--primary), var(--accent));
        border: none;
        color: #fff;
        border-radius: 999px;
        padding: 0.6rem 1.6rem;
        font-weight: 700;
        box-shadow: 0 14px 28px rgba(108, 99, 255, 0.35);
      }
      #nominate-confirm:hover { transform: translateY(-2px); }

      @media (min-width: 880px) {
        header {
          grid-template-columns: minmax(0, 1.1fr) minmax(220px, 0.9fr);
          text-align: left;
          align-items: center;
        }
        .hero-copy { justify-items: flex-start; }
        header p { margin-left: 0; margin-right: 0; }
        .qr-wrapper { align-items: flex-start; }
        .hero-visual { justify-self: end; }

        .intro-layout {
          grid-template-columns: minmax(0, 1.1fr) minmax(240px, 0.9fr);
          align-items: center;
        }
        .intro-copy {
          text-align: left;
          justify-items: flex-start;
          gap: 1.2rem;
        }
        .intro-badges { justify-content: flex-start; }
        .intro-visual { justify-self: end; }

        .thanks-highlight-inner {
          text-align: left;
          justify-items: flex-start;
        }
        .thanks-highlight-card img { margin: 0; }

        .intro-video-container {
          grid-template-columns: minmax(0, 1fr) minmax(0, 0.9fr);
          align-items: center;
          text-align: left;
          justify-items: stretch;
        }
        .intro-video-frame { justify-self: center; }
        .feature-cards { width: 100%; }

        .upload-item {
          grid-template-columns: minmax(320px, 380px) minmax(0, 1fr);
          grid-template-areas: 'video info';
          text-align: left;
          justify-items: stretch;
          align-items: center;
        }
        .upload-item.has-actions {
          grid-template-areas:
            'video info'
            'video actions';
        }
        .upload-info { width: 100%; }
        .upload-meta { gap: 0.75rem; }
        .upload-actions { justify-content: flex-start; }
      }

      @media (max-width: 720px) {
        main { gap: 2rem; padding: 2rem 1.4rem 2.6rem; }
        header,
        .intro-section,
        .thanks-highlight,
        #nominated-list-section,
        .archive { border-radius: 20px; padding: 1.8rem; }
        .two-inputs,
        #nominate-modal .two-inputs { grid-template-columns: 1fr; }
        .nominated-item { justify-content: center; text-align: center; }
        .nominated-item-left { justify-content: center; }
        .upload-form { padding: 1.3rem; }
        .upload-item { padding: 1.3rem; }
        .upload-video { max-width: 100%; }
      }
    </style>
  </head>
  <body>
    <main>
      <header class="hero">
        <div class="hero-copy">
          <h1>감다살 챌린지</h1>
          <p>예배와 삶의 회복을 위한 감다살 챌린지, 함께해요!</p>
          <div class="qr-wrapper">
            <div id="qr-code-container">
              <img id="qr-code-img" alt="QR Code">
            </div>
            <p class="qr-hint">📱 QR 코드로 모바일에서 접속</p>
          </div>
        </div>
        <figure class="hero-visual">
          <img src="assets/thanks1.png" alt="감사 카드 1">
        </figure>
      </header>

      <!-- 인트로 섹션 -->
      <section class="intro-section">
        <div class="intro-layout">
          <div class="intro-copy">
            <h3 class="intro-title">감다살 챌린지 참여 방법</h3>
            <p class="intro-sub">
              감사한 순간을 기록하고 영상을 나누어 다음 셀을 지목하면, 공동체 모두가 은혜를 나누는 감사 릴레이가 완성됩니다.
            </p>
            <ol class="intro-steps">
              <li>하루 동안 발견한 감사 제목을 떠올리고 준비해요.</li>
              <li>영상 또는 이미지를 업로드하며 다음 셀을 지목해요.</li>
              <li>감사 이야기가 이어지도록 함께 응원해요.</li>
            </ol>
            <div class="intro-badges">
              <span>🙏 하루 감사 기록</span>
              <span>📹 영상 업로드</span>
              <span>🤝 다음 셀 지목</span>
            </div>
          </div>
          <figure class="intro-card intro-visual">
            <img src="assets/thanks2.png" alt="감사 카드 2">
          </figure>
        </div>
      </section>

      <section class="thanks-highlight">
        <div class="thanks-highlight-inner">
          <h3>함께 이어지는 감사 이야기</h3>
          <p>감사 릴레이의 다음 장면을 기다리며, 서로의 이야기에 귀 기울여 주세요.</p>
          <figure class="thanks-highlight-card">
            <img src="assets/thanks3.png" alt="감사 카드 3">
          </figure>
        </div>
      </section>

      <!-- 지목된 사람들 리스트 -->
      <section id="nominated-list-section">
        <h3>📋 챌린지 지목된 사람들</h3>
        <div id="nominated-list">
          <p>아직 지목된 사람이 없습니다.</p>
        </div>
      </section>

      <!-- 영상 업로드 섹션 -->
      <section>
        <div id="archives"></div>
      </section>


      <!-- 업로드 로그 섹션 제거됨 -->

      <template id="archive-template">
        <section class="archive">
          <div class="archive-header">
            <h2 class="archive-title"></h2>
            <p class="archive-description"></p>
          </div>
          <div class="upload-list"></div>
          <form class="upload-form" autocomplete="off">
            <label>등록자</label>
            <div class="two-inputs">
              <input class="upload-cell" type="text" maxlength="40" placeholder="셀명 (예: 감다살 셀)" required>
              <input class="upload-name" type="text" maxlength="40" placeholder="이름 (예: 이하연)" required>
            </div>
            <div class="dropzone">
              <strong>영상 또는 이미지 파일을 끌어다 놓거나 아래 버튼을 눌러 선택하세요.</strong>
              <span class="dropzone-status">선택된 파일이 없습니다.</span>
              <button type="button" class="select-button">파일 선택</button>
              <input class="upload-file" type="file" accept="video/*,image/*">
            </div>
            <button type="submit" class="submit-button">업로드</button>
          </form>
        </section>
      </template>
 
      <!-- 지목 모달 -->
      <div id="nominate-modal">
        <div>
          <h3>다음 챌린지 참여자를 지목하세요</h3>
          <p>셀명과 이름을 각각 입력해주세요. 업로드 항목에 함께 표시됩니다.</p>
          <div class="nominate-form-grid">
            <label>지목할 사람</label>
            <div class="two-inputs">
              <input id="nominate-cell-input" type="text" placeholder="셀명 (예: 감다살 셀)" maxlength="40">
              <input id="nominate-name-input" type="text" placeholder="이름 (예: 이하연)" maxlength="40">
            </div>
          </div>
          <div class="nominate-actions">
            <button id="nominate-skip" type="button">나중에</button>
            <button id="nominate-confirm" type="button">확인</button>
          </div>
        </div>
      </div>
    </main>

    <script>
const ENABLE_LOGS = false;
const MAX_UPLOADS = 12;
const sections = [
  {
    id: 'challenge',
    title: '감다살 챌린지',
    description: '예배와 삶의 회복을 위한 감다살 챌린지, 함께해요!',
    storageKey: 'gamdasal-challenge-uploads',
    storageVersion: '2025-10-24-challenge-v2',
    posterColor: '211d44',
    defaults: [
      {
        title: '감사 카드 1',
        subtitle: '감다살 셀 / 운영팀 · 2025-02-05 10:00 · 다음 지목: 하늘 셀 / 민수',
        src: 'assets/thanks1.png',
        poster: 'assets/thanks1.png'
      },
      {
        title: '감사 카드 2',
        subtitle: '하늘 셀 / 민수 · 2025-02-05 11:00 · 다음 지목: 기쁨 셀 / 지은',
        src: 'assets/thanks2.png',
        poster: 'assets/thanks2.png'
      },
      {
        title: '감사 카드 3',
        subtitle: '기쁨 셀 / 지은 · 2025-02-05 12:00 · 다음 지목: 사랑 셀 / 하람',
        src: 'assets/thanks3.png',
        poster: 'assets/thanks3.png'
      }
    ]
  }
];

const LOG_STORAGE_KEY = 'gamdasal-upload-logs';
const LOG_LIMIT = 40;

const SUPABASE_URL = 'https://ykdmlgrlpwkqyyemcefz.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlrZG1sZ3JscHdrcXl5ZW1jZWZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNDI3NTMsImV4cCI6MjA3NjgxODc1M30.pRfCXTTXZHfp5Fohy4LLrHNujqds4Tir3pSMQIZLCvI';
const SUPABASE_BUCKET = 'videos';
const SUPABASE_TABLE = 'video_uploads';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const pathSegments = window.location.pathname.replace(/\/index\.html$/, '').split('/').filter(Boolean);
const isDeletePage = pathSegments[pathSegments.length - 1] === 'delete';

const template = document.getElementById('archive-template');
const container = document.getElementById('archives');
const logListEl = null;
const logCopyBtn = null;
const logClearBtn = null;
const syncCloudBtn = null;
const testSupabaseBtn = null;
const testDatabaseBtn = null;
const testStorageBtn = null;

// Nomination modal elements
const nominateModal = document.getElementById('nominate-modal');
const nominateCellInput = document.getElementById('nominate-cell-input');
const nominateNameInput = document.getElementById('nominate-name-input');
const nominateConfirmBtn = document.getElementById('nominate-confirm');
const nominateSkipBtn = document.getElementById('nominate-skip');

/** 업로드 완료 후 지목을 연결하기 위한 마지막 업로드 항목 참조 */
let lastUploadedItem = null;

let logs = [];

// 익명 로그인 없이 직접 API 호출
const SUPABASE_HEADERS = {
  'Content-Type': 'application/json',
  'apikey': SUPABASE_ANON_KEY,
  'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
  'Prefer': 'return=minimal'
};

// 간단한 클라우드 동기화

// Supabase 테스트 함수들
const testSupabaseConnection = async () => {
  try {
    addLog('test', 'Supabase 연결 테스트', '연결 시도 중...');
    const { data, error } = await supabase.from('video_uploads').select('count').limit(1);
    if (error) {
      addLog('test', 'Supabase 연결 실패', error.message);
    } else {
      addLog('test', 'Supabase 연결 성공', 'Database 접근 가능');
    }
  } catch (error) {
    addLog('test', 'Supabase 연결 오류', error.message);
  }
};

const testDatabase = async () => {
  try {
    addLog('test', 'Database 테스트', '테이블 존재 확인 중...');
    const { data, error } = await supabase
      .from(SUPABASE_TABLE)
      .select('*')
      .limit(1);
    
    if (error) {
      addLog('test', 'Database 테스트 실패', error.message);
    } else {
      addLog('test', 'Database 테스트 성공', `테이블 접근 가능 (${data?.length || 0}개 레코드)`);
    }
  } catch (error) {
    addLog('test', 'Database 테스트 오류', error.message);
  }
};

const testStorage = async () => {
  try {
    addLog('test', 'Storage 테스트', '버킷 접근 확인 중...');
    const { data, error } = await supabase
      .storage
      .from(SUPABASE_BUCKET)
      .list('', { limit: 1 });
    
    if (error) {
      addLog('test', 'Storage 테스트 실패', error.message);
    } else {
      addLog('test', 'Storage 테스트 성공', `버킷 접근 가능 (${data?.length || 0}개 파일)`);
    }
  } catch (error) {
    addLog('test', 'Storage 테스트 오류', error.message);
  }
};

const clamp = (num, min, max) => Math.min(Math.max(num, min), max);

const formatNow = () => {
  const now = new Date();
  const pad = (value) => String(value).padStart(2, '0');
  return `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} · ${pad(now.getHours())}:${pad(now.getMinutes())}`;
};

const loadLogs = () => {
  if (!ENABLE_LOGS) return;
  try {
    logs = JSON.parse(localStorage.getItem(LOG_STORAGE_KEY) || '[]');
    if (!Array.isArray(logs)) logs = [];
  } catch (error) {
    logs = [];
  }
};

const persistLogs = () => {
  if (!ENABLE_LOGS) return;
  try {
    localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(logs));
  } catch (error) {
    console.error('로그 저장 실패', error);
  }
};

const renderLogs = () => {
  if (!ENABLE_LOGS || !logListEl) return;
  logListEl.innerHTML = '';
  if (!logs.length) {
    const empty = document.createElement('p');
    empty.className = 'upload-empty';
    empty.textContent = '아직 업로드 로그가 없습니다.';
    logListEl.append(empty);
    return;
  }
  logs.slice().reverse().forEach((log) => {
    const item = document.createElement('article');
    item.className = 'upload-item';
    const info = document.createElement('div');
    info.className = 'upload-info';
    const strong = document.createElement('strong');
    strong.textContent = `[${log.section.toUpperCase()}] ${log.event}`;
    const span = document.createElement('span');
    span.textContent = `${log.time} · ${log.message}`;
    info.append(strong, span);
    item.append(info);
    if (log.details) {
      const pre = document.createElement('pre');
      pre.style.margin = '0';
      pre.style.maxWidth = '100%';
      pre.style.whiteSpace = 'pre-wrap';
      pre.style.wordBreak = 'break-all';
      pre.textContent = log.details;
      item.append(pre);
    }
    logListEl.append(item);
  });
};

const addLog = (sectionId, event, message, details) => {
  if (!ENABLE_LOGS) return;
  logs.push({ section: sectionId, event, message, details, time: new Date().toISOString() });
  if (logs.length > LOG_LIMIT) {
    logs = logs.slice(logs.length - LOG_LIMIT);
  }
  persistLogs();
  renderLogs();
};

const fallbackPoster = (section, title) => {
  const safe = encodeURIComponent((title || section.title).slice(0, 18));
  return `https://dummyimage.com/320x180/${section.posterColor}/ffffff&text=${safe}`;
};

const deriveUploadTitle = (file, uploaderName) => {
  if (file?.name) {
    const base = file.name.replace(/\.[^.]+$/, '').trim();
    if (base) {
      return base.slice(0, 80);
    }
  }
  if (uploaderName) {
    return `${uploaderName}님의 영상`;
  }
  return '무제 영상';
};

const sanitizeFileName = (name) => {
  return name
    .toLowerCase()
    .replace(/[^a-z0-9._-]+/g, '-')
    .replace(/-+/g, '-')
    .replace(/^-|-$/g, '')
    .slice(0, 80) || 'upload';
};

const createUuid = () => {
  if (window.crypto && typeof window.crypto.randomUUID === 'function') {
    return window.crypto.randomUUID();
  }
  return `id-${Math.random().toString(36).slice(2, 11)}-${Date.now().toString(36)}`;
};

const createStoragePath = (archive, file) => {
  const extension = (file.name.split('.').pop() || 'mp4').toLowerCase();
  const base = sanitizeFileName(file.name.replace(/\.[^.]+$/, ''));
  const folder = `${archive.section.id}`;
  return `${folder}/${createUuid()}-${base}.${extension}`;
};

const mapRowToUpload = (row) => ({
  id: row.id,
  title: row.title || '무제 영상',
  subtitle: row.subtitle,
  src: row.src,
  poster: row.poster,
  created_at: row.created_at
});

const uploadToSupabaseStorage = async (archive, file) => {
  try {
    const path = createStoragePath(archive, file);
    
    // Supabase Storage에 파일 업로드
    const { data, error } = await supabase
      .storage
      .from(SUPABASE_BUCKET)
      .upload(path, file, { cacheControl: '3600', upsert: false });
    
    if (error) {
      addLog(archive.section.id, 'Storage 업로드 실패', error.message);
      // 버킷이 없는 경우 Base64로 대체
      console.warn('Supabase Storage 오류, Base64로 대체:', error);
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          resolve({
            publicUrl: reader.result,
            path: `base64_${Date.now()}_${file.name}`
          });
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    
    // 공개 URL 가져오기
    const { data: urlData } = supabase
      .storage
      .from(SUPABASE_BUCKET)
      .getPublicUrl(path);
    
    addLog(archive.section.id, 'Storage 업로드 성공', 'Supabase Storage에 저장됨');
    return { publicUrl: urlData.publicUrl, path };
  } catch (error) {
    addLog(archive.section.id, 'Storage 업로드 실패', error.message);
    console.error('Storage 업로드 실패:', error);
    throw error;
  }
};

const fetchUploadsFromCloud = async (archive, { addLogEntry = true } = {}) => {
  try {
    // Supabase Database에서만 데이터 로드
    const { data, error } = await supabase
      .from(SUPABASE_TABLE)
      .select('id,title,subtitle,src,poster,created_at')
      .order('created_at', { ascending: false })
      .limit(MAX_UPLOADS);
    
    if (error) {
      console.warn('Supabase Database 오류:', error);
      addLog(archive.section.id, '클라우드 로드 실패', error.message);
      archive.uploads = [];
    } else {
      archive.uploads = (data || []).map(mapRowToUpload);
      if (!archive.uploads.length && Array.isArray(archive.section.defaults) && archive.section.defaults.length) {
        archive.uploads = archive.section.defaults.map((item) => ({ ...item }));
      }
      if (addLogEntry) {
        addLog(archive.section.id, '클라우드 로드', `${archive.uploads.length}개 영상 로드`);
      }
    }
  } catch (error) {
    addLog(archive.section.id, '클라우드 로드 실패', error.message);
    archive.uploads = [];
  }
};

const insertUploadRecord = async (archive, item) => {
  try {
    // Supabase Database에만 저장
    const { data, error } = await supabase
      .from(SUPABASE_TABLE)
      .insert([{
        title: item.title,
        subtitle: item.subtitle,
        src: item.src,
        poster: item.poster
      }])
      .select('id,title,subtitle,src,poster,created_at')
      .single();
    
    if (error) {
      addLog(archive.section.id, 'Supabase 저장 실패', error.message);
      throw error;
    }
    
    addLog(archive.section.id, 'Supabase 저장', 'Supabase Database에 저장됨');
    return mapRowToUpload(data);
  } catch (error) {
    addLog(archive.section.id, '업로드 저장 실패', error.message);
    throw error;
  }
};

const removeUploadRecord = async (archive, upload) => {
  if (!upload?.id) return;
  try {
    // Supabase Database에서 삭제
    const { error } = await supabase
      .from(SUPABASE_TABLE)
      .delete()
      .eq('id', upload.id);
    
    if (error) {
      addLog(archive.section.id, 'Supabase 삭제 실패', error.message);
      throw error;
    }
    
    addLog(archive.section.id, 'Supabase 삭제', 'Supabase Database에서 삭제됨');
  } catch (error) {
    addLog(archive.section.id, '삭제 실패', error.message);
    throw error;
  }
};

// 지목된 사람들 추출 및 렌더링
const extractNominatedPeople = (archives) => {
  const nominated = new Map(); // 중복 제거를 위해 Map 사용
  
  archives.forEach(archive => {
    archive.uploads.forEach(upload => {
      if (upload.subtitle && upload.subtitle.includes('다음 지목:')) {
        const match = upload.subtitle.match(/다음 지목:\s*(.+?)(?:\s*·\s*|$)/);
        if (match && match[1]) {
          const nominationText = match[1].trim();
          // "셀 / 이름" 형식 파싱
          const parts = nominationText.split('/').map(s => s.trim()).filter(s => s);
          if (parts.length >= 2) {
            const cell = parts[0] || '';
            const name = parts[1] || '';
            const key = `${cell}::${name}`;
            if (!nominated.has(key)) {
              nominated.set(key, { cell, name, count: 0 });
            }
            nominated.get(key).count++;
          } else if (parts.length === 1) {
            // 이름만 있는 경우
            const name = parts[0];
            const key = `::${name}`;
            if (!nominated.has(key)) {
              nominated.set(key, { cell: '', name, count: 0 });
            }
            nominated.get(key).count++;
          }
        }
      }
    });
  });
  
  return Array.from(nominated.values()).sort((a, b) => b.count - a.count);
};

const renderNominatedList = (archives) => {
  const nominatedListEl = document.getElementById('nominated-list');
  if (!nominatedListEl) return;
  
  const nominated = extractNominatedPeople(archives);
  
  nominatedListEl.innerHTML = '';
  
  if (nominated.length === 0) {
    const empty = document.createElement('p');
    empty.textContent = '아직 지목된 사람이 없습니다.';
    nominatedListEl.appendChild(empty);
    return;
  }
  
  nominated.forEach(({ cell, name, count }) => {
    const item = document.createElement('div');
    item.className = 'nominated-item';

    const leftGroup = document.createElement('div');
    leftGroup.className = 'nominated-item-left';

    const info = document.createElement('div');
    info.className = 'nominated-item-info';

    const cellSpan = document.createElement('span');
    cellSpan.className = 'nominated-item-cell';
    cellSpan.textContent = cell || '미지정';

    const nameSpan = document.createElement('span');
    nameSpan.className = 'nominated-item-name';
    nameSpan.textContent = name;

    if (cell) {
      info.appendChild(cellSpan);
      if (name) {
        const separator = document.createElement('span');
        separator.className = 'nominated-item-separator';
        separator.textContent = ' / ';
        info.appendChild(separator);
        info.appendChild(nameSpan);
      }
    } else if (name) {
      info.appendChild(nameSpan);
    }


    const registerBtn = document.createElement('button');
    registerBtn.type = 'button';
    registerBtn.textContent = '등록하기';
    registerBtn.className = 'nominated-item-button';
    registerBtn.dataset.cell = cell || '';
    registerBtn.dataset.name = name || '';
    registerBtn.addEventListener('click', function() {
      const targetCell = this.dataset.cell || '';
      const targetName = this.dataset.name || '';
      
      // 등록 폼 찾기
      if (!archives || archives.length === 0) {
        alert('등록 폼을 찾을 수 없습니다. 페이지를 새로고침해주세요.');
        return;
      }
      
      const archive = archives[0];
      if (!archive || !archive.elements) {
        alert('등록 폼을 찾을 수 없습니다. 페이지를 새로고침해주세요.');
        return;
      }
      
      const cellInput = archive.elements.cellInput;
      const nameInput = archive.elements.nameInput;
      if (!cellInput || !nameInput) {
        alert('등록자 입력 필드를 찾을 수 없습니다. 페이지를 새로고침해주세요.');
        return;
      }
      
      cellInput.value = targetCell;
      nameInput.value = targetName;
      
      // 폼으로 스크롤
      archive.elements.form.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      // 파일 선택 버튼에 포커스를 맞춰 업로드를 이어가도록 안내
      setTimeout(() => {
        if (archive.elements.selectButton) {
          archive.elements.selectButton.focus();
        }
      }, 300);
    });
    
    leftGroup.appendChild(info);
    item.appendChild(leftGroup);
    item.appendChild(registerBtn);
    nominatedListEl.appendChild(item);
  });
};

const renderUploads = (archive) => {
  const list = archive.elements.list;
  list.innerHTML = '';
  if (!archive.uploads.length) {
    const empty = document.createElement('p');
    empty.className = 'upload-empty';
    empty.textContent = '등록된 영상이 아직 없습니다. 위 폼을 사용해 추가해 보세요.';
    list.append(empty);
    return;
  }
  archive.uploads.forEach((item, index) => {
    const article = document.createElement('article');
    article.className = 'upload-item';
    if (isDeletePage) {
      article.classList.add('has-actions');
    }

    const mediaWrap = document.createElement('div');
    mediaWrap.className = 'upload-video';
    const isImage = /\.(png|jpe?g|gif|webp|bmp|svg)(\?|$)/i.test(item.src || '');
    
    if (isImage) {
      const img = document.createElement('img');
      img.loading = 'lazy';
      img.decoding = 'async';
      img.src = item.src;
      img.alt = item.title || '이미지';
      mediaWrap.append(img);
    } else {
      const video = document.createElement('video');
      video.controls = true;
      video.preload = 'metadata';
      video.src = item.src;
      // Use a poster if available, otherwise the browser will show the first frame.
      if (item.poster) {
        video.poster = item.poster;
      }
      mediaWrap.append(video);
    }

    const info = document.createElement('div');
    info.className = 'upload-info';
    
    const metaList = document.createElement('div');
    metaList.className = 'upload-meta';

    if (item.subtitle) {
      const nomMatch = item.subtitle.match(/다음 지목:\s*(.+?)(?:\s*·\s*|$)/);
      const nominationInfo = nomMatch ? nomMatch[1].trim() : '';
      const baseSubtitle = nomMatch ? item.subtitle.replace(/·\s*다음 지목:.*$/, '').trim() : item.subtitle;

      const parts = baseSubtitle
        .split('·')
        .map((part) => part.trim())
        .filter(Boolean);

      const uploaderText = parts.length ? parts[0] : '';
      const timestampText = parts.length > 1 ? parts.slice(1).join(' · ') : '';

      if (uploaderText) {
        const row = document.createElement('div');
        row.className = 'upload-meta-row';
        const label = document.createElement('span');
        label.className = 'upload-meta-label';
        label.textContent = '등록자';
        const value = document.createElement('span');
        value.className = 'upload-meta-value';
        value.textContent = uploaderText;
        row.append(label, value);
        metaList.appendChild(row);
      }

      if (timestampText) {
        const row = document.createElement('div');
        row.className = 'upload-meta-row';
        const label = document.createElement('span');
        label.className = 'upload-meta-label';
        label.textContent = '업로드';
        const value = document.createElement('span');
        value.className = 'upload-meta-value upload-meta-timestamp';
        value.textContent = timestampText;
        row.append(label, value);
        metaList.appendChild(row);
      }

      if (nominationInfo) {
        const row = document.createElement('div');
        row.className = 'upload-meta-row';
        const label = document.createElement('span');
        label.className = 'upload-meta-label';
        label.textContent = '다음 지목';
        const value = document.createElement('span');
        value.className = 'upload-meta-value upload-meta-nomination';
        value.textContent = nominationInfo;
        row.append(label, value);
        metaList.appendChild(row);
      }
    }

    if (!metaList.children.length) {
      const fallback = document.createElement('div');
      fallback.className = 'upload-meta-row';
      const label = document.createElement('span');
      label.className = 'upload-meta-label';
      label.textContent = '정보';
      const value = document.createElement('span');
      value.className = 'upload-meta-value';
      value.textContent = '등록 정보가 없습니다.';
      fallback.append(label, value);
      metaList.appendChild(fallback);
    }

    info.appendChild(metaList);

    const nodes = [mediaWrap, info];
    if (isDeletePage) {
      const actions = document.createElement('div');
      actions.className = 'upload-actions';
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.textContent = '삭제';
      removeBtn.dataset.remove = index;
      if (item.id) {
        removeBtn.dataset.id = item.id;
      }
      actions.append(removeBtn);
      nodes.push(actions);
    }

    article.append(...nodes);
    list.append(article);
  });
  
  // Update nominated people list
  renderNominatedList(archives);
};

const resetSelectedFile = (archive) => {
  archive.selectedFile = null;
  archive.elements.dropzone.classList.remove('has-file', 'uploading');
  archive.elements.dropzoneStatus.textContent = '선택된 파일이 없습니다.';
};

const setSelectedFile = (archive, file) => {
  if (!file) return;
  if (!file.type.startsWith('video/') && !file.type.startsWith('image/')) {
    alert('영상 또는 이미지 파일만 업로드할 수 있습니다.');
    return;
  }
  archive.selectedFile = file;
  archive.elements.dropzone.classList.add('has-file');
  archive.elements.dropzoneStatus.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(1)}MB)`;
};

const uploadToCloud = async (archive, file) => {
  archive.elements.dropzone.classList.add('uploading');
  archive.elements.dropzoneStatus.textContent = '업로드 중입니다…';
  archive.elements.submitButton.disabled = true;

  addLog(archive.section.id, '업로드 시작', file.name, `size=${(file.size / 1024 / 1024).toFixed(2)}MB`);

  try {
    archive.elements.dropzoneStatus.textContent = '클라우드 업로드 중...';
    const { publicUrl, path } = await uploadToSupabaseStorage(archive, file);
    addLog(archive.section.id, '클라우드 업로드', publicUrl, path);
    return { publicUrl, path };
  } catch (error) {
    addLog(archive.section.id, '클라우드 업로드 실패', error.message);
    throw error;
  }
};

const seedUploads = async (archive) => {
  try {
    await fetchUploadsFromCloud(archive);
  } catch (error) {
    console.error('클라우드 로드 실패:', error);
    addLog(archive.section.id, '클라우드 로드 실패', error.message || '알 수 없는 오류');
    archive.uploads = [...archive.section.defaults];
  }
  renderUploads(archive);
  // 지목된 사람들 리스트 업데이트
  renderNominatedList(archives);
};

const handleRemove = async (event, archive) => {
  const target = event.target.closest('button[data-remove]');
  if (!target) return;
  const index = Number(target.dataset.remove);
  if (Number.isNaN(index)) return;
  const upload = archive.uploads[index];
  if (!upload) return;
  if (!confirm('이 영상을 삭제할까요?')) return;

  try {
    await removeUploadRecord(archive, upload);
    archive.uploads.splice(index, 1);
    renderUploads(archive);
    addLog(archive.section.id, '영상 삭제', upload.title, upload.id ? `id=${upload.id}` : undefined);
  } catch (error) {
    console.error('삭제 실패:', error);
    addLog(archive.section.id, '삭제 실패', error.message || '알 수 없는 오류');
    alert('삭제에 실패했습니다. 잠시 후 다시 시도해주세요.');
  }
};

const handleSubmit = async (event, archive) => {
  event.preventDefault();
  const cell = archive.elements.cellInput.value.trim();
  const name = archive.elements.nameInput.value.trim();
  if (!cell || !name) {
    alert('등록자의 셀명과 이름을 모두 입력해주세요.');
    if (!cell) {
      archive.elements.cellInput.focus();
    } else {
      archive.elements.nameInput.focus();
    }
    return;
  }
  const author = `${cell} / ${name}`;
  if (!archive.selectedFile) {
    alert('업로드할 영상 파일을 선택해주세요.');
    return;
  }
  const title = deriveUploadTitle(archive.selectedFile, name);
  let uploadMetadata = null;
  try {
    uploadMetadata = await uploadToCloud(archive, archive.selectedFile);
    const newItem = {
      title,
      subtitle: `${author} · ${formatNow()}`,
      src: uploadMetadata.publicUrl,
      poster: fallbackPoster(archive.section, title)
    };
    const saved = await insertUploadRecord(archive, newItem);
    archive.uploads.unshift(saved);
    archive.uploads = archive.uploads.slice(0, MAX_UPLOADS);
    renderUploads(archive);
    archive.elements.form.reset();
    resetSelectedFile(archive);
    archive.elements.dropzoneStatus.textContent = '업로드 완료! 목록에 추가되었습니다.';
    addLog(archive.section.id, '업로드 완료', saved.title, saved.id ? `id=${saved.id}` : undefined);

    // 업로드 완료 후 지목 모달 표시
    lastUploadedItem = saved;
    if (nominateModal && nominateCellInput && nominateNameInput) {
      nominateCellInput.value = '';
      nominateNameInput.value = '';
      nominateModal.style.display = 'flex';
      // 셀 입력 필드로 포커스
      setTimeout(() => {
        if (nominateCellInput) nominateCellInput.focus();
      }, 100);
    }
  } catch (error) {
    console.error(error);
    archive.elements.dropzoneStatus.textContent = '업로드에 실패했습니다. 잠시 후 다시 시도해주세요.';
    addLog(archive.section.id, '업로드 실패', error.message || String(error));
    alert('업로드에 실패했습니다. 잠시 후 다시 시도해주세요.');
    if (uploadMetadata?.path) {
      try {
        await supabase.storage.from(SUPABASE_BUCKET).remove([uploadMetadata.path]);
        addLog(archive.section.id, '정리 완료', '부분 업로드 파일 삭제', uploadMetadata.path);
      } catch (cleanupError) {
        console.warn('임시 파일 삭제 실패:', cleanupError);
      }
    }
  } finally {
    archive.elements.dropzone.classList.remove('uploading');
    archive.elements.submitButton.disabled = false;
  }
};

const createArchive = (section) => {
  const fragment = template.content.cloneNode(true);
  const archiveEl = fragment.querySelector('.archive');
  archiveEl.dataset.section = section.id;
  archiveEl.querySelector('.archive-title').textContent = section.title;
  archiveEl.querySelector('.archive-description').textContent = section.description;

  const list = archiveEl.querySelector('.upload-list');
  const form = archiveEl.querySelector('.upload-form');
  const cellInput = archiveEl.querySelector('.upload-cell');
  const nameInput = archiveEl.querySelector('.upload-name');
  const dropzone = archiveEl.querySelector('.dropzone');
  const dropzoneStatus = archiveEl.querySelector('.dropzone-status');
  const selectButton = archiveEl.querySelector('.select-button');
  const fileInput = archiveEl.querySelector('.upload-file');
  const submitButton = archiveEl.querySelector('.submit-button');

  const archive = {
    section,
    elements: { list, form, cellInput, nameInput, dropzone, dropzoneStatus, selectButton, fileInput, submitButton },
    uploads: [],
    selectedFile: null,
  };

  selectButton.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (event) => {
    setSelectedFile(archive, event.target.files?.[0]);
    fileInput.value = '';
  });
  ['dragenter', 'dragover'].forEach((type) => {
    dropzone.addEventListener(type, (event) => {
      event.preventDefault();
      dropzone.classList.add('hover');
    });
  });
  ['dragleave', 'drop'].forEach((type) => {
    dropzone.addEventListener(type, (event) => {
      event.preventDefault();
      dropzone.classList.remove('hover');
    });
  });
  dropzone.addEventListener('drop', (event) => {
    setSelectedFile(archive, event.dataTransfer.files?.[0]);
  });
  form.addEventListener('submit', (event) => handleSubmit(event, archive));
  if (isDeletePage) {
    list.addEventListener('click', (event) => handleRemove(event, archive));
  }
  resetSelectedFile(archive);

  container.appendChild(fragment);
  // archive.elements는 이미 위에서 설정했으므로 여기서는 업데이트만 필요하면 업데이트
  return archive;
};

const archives = sections.map(createArchive);
loadLogs();
renderLogs();
archives.forEach(async (archive) => await seedUploads(archive));

if (ENABLE_LOGS && logCopyBtn) {
  logCopyBtn.addEventListener('click', async () => {
    const payload = JSON.stringify(logs, null, 2);
    try {
      await navigator.clipboard.writeText(payload);
      alert('로그가 클립보드에 복사되었습니다.');
    } catch (error) {
      alert('클립보드 복사에 실패했습니다.');
    }
  });
}

if (ENABLE_LOGS && logClearBtn) {
  logClearBtn.addEventListener('click', () => {
    if (!logs.length) return;
    if (!confirm('로그를 초기화할까요?')) return;
    logs = [];
    persistLogs();
    renderLogs();
  });
}

// 지목 모달 이벤트
if (nominateConfirmBtn && nominateCellInput && nominateNameInput) {
  nominateConfirmBtn.addEventListener('click', async () => {
    const cell = (nominateCellInput?.value || '').trim();
    const name = (nominateNameInput?.value || '').trim();
    if (!lastUploadedItem) {
      nominateModal.style.display = 'none';
      return;
    }
    
    let mention = '';
    if (cell && name) {
      mention = `다음 지목: ${cell} / ${name}`;
    } else if (cell || name) {
      // 둘 중 하나만 입력된 경우도 처리
      mention = `다음 지목: ${cell || name}`;
    }
    
    if (mention) {
      // 로컬 반영
      lastUploadedItem.subtitle = `${lastUploadedItem.subtitle} · ${mention}`;
      // 원격 업데이트 시도
      try {
        if (lastUploadedItem.id) {
          const { error } = await supabase
            .from(SUPABASE_TABLE)
            .update({ subtitle: lastUploadedItem.subtitle })
            .eq('id', lastUploadedItem.id);
          if (error) console.warn('지목 저장 실패:', error.message);
        }
      } catch (e) {
        console.warn('지목 저장 오류:', e);
      }
      // 화면 갱신
      renderUploads(archives[0]);
    }
    nominateModal.style.display = 'none';
    // 입력 필드 초기화
    if (nominateCellInput) nominateCellInput.value = '';
    if (nominateNameInput) nominateNameInput.value = '';
    lastUploadedItem = null;
  });
}

if (nominateSkipBtn) {
  nominateSkipBtn.addEventListener('click', () => {
    if (nominateModal) nominateModal.style.display = 'none';
    // 입력 필드 초기화
    if (nominateCellInput) nominateCellInput.value = '';
    if (nominateNameInput) nominateNameInput.value = '';
    lastUploadedItem = null;
  });
}

if (syncCloudBtn) {
  syncCloudBtn.addEventListener('click', async () => {
    if (!archives.length) return;
    const archive = archives[0];

    syncCloudBtn.disabled = true;
    syncCloudBtn.textContent = '동기화 중...';

    try {
      await fetchUploadsFromCloud(archive, { addLogEntry: true });
      renderUploads(archive);
      alert('클라우드에서 최신 목록을 불러왔습니다.');
    } catch (error) {
      console.error('동기화 실패:', error);
      addLog(archive.section.id, '동기화 실패', error.message || '알 수 없는 오류');
      alert('동기화에 실패했습니다. 잠시 후 다시 시도해주세요.');
    } finally {
      syncCloudBtn.disabled = false;
      syncCloudBtn.textContent = '클라우드 동기화';
    }
  });
}

// 테스트 버튼 이벤트 리스너
if (testSupabaseBtn) {
  testSupabaseBtn.addEventListener('click', testSupabaseConnection);
}
if (testDatabaseBtn) {
  testDatabaseBtn.addEventListener('click', testDatabase);
}
if (testStorageBtn) {
  testStorageBtn.addEventListener('click', testStorage);
}

// QR 코드 생성 (페이지 로드 후 실행)
(function() {
  function generateQRCode() {
    const qrImg = document.getElementById('qr-code-img');
    if (!qrImg) {
      console.error('QR 코드 이미지를 찾을 수 없습니다.');
      return;
    }
    
    try {
      const currentUrl = window.location.href;
      console.log('QR 코드 생성 시작:', currentUrl);
      
      // 외부 API를 사용하여 QR 코드 생성
      const apiUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=120x120&margin=1&data=' + encodeURIComponent(currentUrl);
      qrImg.src = apiUrl;
      qrImg.onload = function() {
        console.log('QR 코드 로드 성공');
      };
      qrImg.onerror = function() {
        console.error('QR 코드 로드 실패');
        // 대체: 로컬 라이브러리 사용 시도
        if (typeof QRCode !== 'undefined') {
          const canvas = document.createElement('canvas');
          QRCode.toCanvas(canvas, currentUrl, {
            width: 120,
            margin: 1,
            color: {
              dark: '#000000',
              light: '#FFFFFF'
            }
          }, function(error) {
            if (!error) {
              qrImg.src = canvas.toDataURL();
            } else {
              console.error('QR 코드 생성 실패:', error);
            }
          });
        }
      };
    } catch (error) {
      console.error('QR 코드 생성 오류:', error);
    }
  }
  
  // DOM 로드 완료 후 실행
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', generateQRCode);
  } else {
    generateQRCode();
  }
})();
    </script>
  </body>
</html>
