<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8">
    <title>감다살 영상 아카이브</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      :root { color-scheme: light dark; }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: 'Pretendard', 'Apple SD Gothic Neo', 'Segoe UI', sans-serif;
        color: #f5f2ff;
        background: radial-gradient(circle at 18% 18%, #05020d 0%, #170d38 45%, #020008 100%);
        display: flex;
        justify-content: center;
        padding: clamp(2rem, 5vw, 3.8rem) clamp(1.6rem, 4vw, 3.2rem);
      }
      main {
        width: min(900px, 100%);
        display: grid;
        gap: clamp(2.2rem, 5vw, 3.4rem);
        background: rgba(19, 13, 40, 0.82);
        border-radius: clamp(2.2rem, 4vw, 3.4rem);
        padding: clamp(2.6rem, 5vw, 3.6rem);
        box-shadow: 0 3.8rem 5.6rem rgba(0, 0, 0, 0.55), inset 0 0 0 1px rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(18px);
      }
      header {
        text-align: center;
        display: grid;
        gap: 0.9rem;
      }
      header h1 {
        margin: 0;
        font-size: clamp(2.5rem, 6vw, 3.6rem);
        letter-spacing: 0.05em;
      }
      header p {
        margin: 0;
        color: rgba(255, 255, 255, 0.76);
        font-size: 1.06rem;
      }
      #archives {
        display: grid;
        gap: clamp(2.2rem, 4vw, 3rem);
      }
      .archive {
        display: grid;
        gap: 1.6rem;
        padding: clamp(1.6rem, 3.5vw, 2.4rem);
        border-radius: 2rem;
        background: rgba(255, 255, 255, 0.07);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
      }
      .archive-header {
        text-align: center;
        display: grid;
        gap: 0.6rem;
      }
      .archive-title {
        margin: 0;
        font-size: clamp(1.6rem, 4vw, 2.2rem);
      }
      .archive-description {
        margin: 0;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.98rem;
      }
      .upload-list {
        display: grid;
        gap: 1rem;
      }
      .upload-item {
        display: flex;
        gap: 1.2rem;
        flex-wrap: wrap;
        align-items: center;
        padding: 1rem 1.2rem;
        border-radius: 1.4rem;
        background: rgba(255, 255, 255, 0.08);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.12);
      }
      .upload-video {
        flex: 0 0 200px;
        max-width: 240px;
        border-radius: 1.2rem;
        overflow: hidden;
        box-shadow: 0 1.1rem 2.2rem rgba(0, 0, 0, 0.45);
      }
      .upload-video video {
        display: block;
        width: 100%;
        height: 100%;
        object-fit: cover;
        background: rgba(0, 0, 0, 0.3);
      }
      .upload-info {
        flex: 1 1 240px;
        text-align: left;
      }
      .upload-info strong {
        display: block;
        font-size: 1.05rem;
        color: #ffe7f8;
      }
      .upload-info span {
        font-size: 0.92rem;
        color: rgba(255, 255, 255, 0.7);
      }
      .upload-actions {
        display: flex;
        gap: 0.6rem;
        align-items: center;
      }
      .upload-actions button {
        border: none;
        border-radius: 999px;
        padding: 0.5rem 0.95rem;
        font-size: 0.85rem;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.18);
        color: rgba(24, 20, 54, 0.9);
        cursor: pointer;
        transition: filter 0.15s ease;
      }
      .upload-actions button:hover { filter: brightness(1.08); }
      .upload-empty {
        margin: 0;
        padding: 1rem 1.2rem;
        border-radius: 1.2rem;
        background: rgba(255, 255, 255, 0.06);
        color: rgba(255, 255, 255, 0.65);
        text-align: center;
      }
      .upload-form {
        display: grid;
        gap: 1rem;
        padding: 1.5rem 1.6rem;
        border-radius: 1.6rem;
        background: rgba(255, 255, 255, 0.07);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
      }
      .upload-form label {
        text-align: left;
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.78);
      }
      .upload-title {
        width: 100%;
        border: none;
        border-radius: 1rem;
        padding: 0.9rem 1rem;
        font-size: 1rem;
        background: rgba(255, 255, 255, 0.12);
        color: #fff;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1);
      }
      .upload-title::placeholder { color: rgba(255, 255, 255, 0.55); }
      .upload-title:focus { outline: 2px solid rgba(255, 255, 255, 0.3); }
      .dropzone {
        position: relative;
        border: 2px dashed rgba(255, 255, 255, 0.22);
        border-radius: 1.6rem;
        padding: 1.6rem 1.4rem;
        text-align: center;
        color: rgba(255, 255, 255, 0.74);
        display: grid;
        gap: 0.7rem;
        background: rgba(255, 255, 255, 0.06);
        transition: border-color 0.2s ease, background 0.2s ease;
      }
      .dropzone input { display: none; }
      .dropzone.hover { border-color: #fad0c4; background: rgba(255, 255, 255, 0.12); }
      .dropzone.has-file { border-color: rgba(255, 255, 255, 0.4); background: rgba(255, 255, 255, 0.12); }
      .dropzone.uploading { border-color: rgba(255, 154, 158, 0.6); background: rgba(255, 154, 158, 0.18); }
      .dropzone-status { font-size: 0.92rem; color: rgba(255, 255, 255, 0.75); }
      .select-button {
        justify-self: center;
        border: none;
        border-radius: 999px;
        padding: 0.6rem 1.3rem;
        font-size: 0.9rem;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.16);
        color: rgba(26, 22, 60, 0.9);
        cursor: pointer;
        transition: filter 0.15s ease;
      }
      .select-button:hover { filter: brightness(1.1); }
      .upload-hint { margin: 0; font-size: 0.85rem; color: rgba(255, 255, 255, 0.6); text-align: left; }
      .submit-button {
        justify-self: flex-end;
        border: none;
        border-radius: 999px;
        padding: 0.85rem 1.9rem;
        font-size: 0.96rem;
        font-weight: 600;
        letter-spacing: 0.05em;
        background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
        color: #341d2f;
        cursor: pointer;
        box-shadow: 0 1.3rem 2.4rem rgba(255, 154, 158, 0.34);
      }
      .submit-button:hover { filter: brightness(1.05); }
      .submit-button:disabled { opacity: 0.55; cursor: default; filter: none; }
      @media (max-width: 720px) {
        body { padding: 1.8rem 1.1rem 2.6rem; }
        main { padding: 2rem 1.4rem 2.8rem; }
        .upload-item { padding: 0.9rem; }
        .upload-video { flex: 1 1 100%; max-width: none; }
        .upload-actions { width: 100%; justify-content: flex-end; }
        .upload-form { padding: 1.4rem 1.5rem; }
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <h1>감다살 첼린지</h1>
        <p>감다살 셀의 미션/첼린지 영상을 등록하고 시청하세요.</p>
      </header>

      <div id="archives"></div>

      <section class="archive" id="log-section">
        <div class="archive-header">
          <h2 class="archive-title">업로드 로그</h2>
          <p class="archive-description">최근 업로드 시도와 응답을 확인할 수 있습니다.</p>
        </div>
        <div class="upload-list" id="log-list"></div>
        <div class="upload-actions" style="justify-content:flex-end; gap:0.6rem; flex-wrap:wrap;">
          <button type="button" id="sync-gist">동기화 새로고침</button>
          <button type="button" id="log-copy">로그 복사</button>
          <button type="button" id="log-clear">로그 초기화</button>
        </div>
        <div style="margin-top:1rem; padding:1rem; background:rgba(255,255,255,0.05); border-radius:1rem; font-size:0.9rem; color:rgba(255,255,255,0.8);">
          <strong>✅ 자동 동기화 활성화:</strong><br>
          • 어느 기기에서든 업로드하면 모든 기기에서 자동으로 보입니다<br>
          • 별도 설정 불필요 - 바로 사용 가능<br>
          • 폰에서 업로드 → 컴퓨터에서 즉시 확인 가능
        </div>
      </section>

      <template id="archive-template">
        <section class="archive">
          <div class="archive-header">
            <h2 class="archive-title"></h2>
            <p class="archive-description"></p>
          </div>
          <div class="upload-list"></div>
          <form class="upload-form" autocomplete="off">
            <label>영상 제목</label>
            <input class="upload-title" type="text" maxlength="80" placeholder="예: 이하연셀 미션 브이로그" required>
            <div class="dropzone">
              <strong>영상 또는 이미지 파일을 끌어다 놓거나 아래 버튼을 눌러 선택하세요.</strong>
              <span class="dropzone-status">선택된 파일이 없습니다.</span>
              <button type="button" class="select-button">파일 선택</button>
              <input class="upload-file" type="file" accept="video/*,image/*">
            </div>
            <small class="upload-hint">로컬 저장 방식 (CORS 문제 없음, 모든 기기에서 안정적)</small>
            <button type="submit" class="submit-button">업로드</button>
          </form>
        </section>
      </template>
    </main>

    <script>
const MAX_UPLOADS = 12;
const sections = [
  {
    id: 'challenge',
    title: '감다살 첼린지',
    description: '감다살 셀의 미션/첼린지 영상을 공유하는 공간입니다.',
    storageKey: 'gamdasal-challenge-uploads',
    storageVersion: '2025-10-24-challenge-v2',
    posterColor: '211d44',
    defaults: []
  }
];

const LOG_STORAGE_KEY = 'gamdasal-upload-logs';
const LOG_LIMIT = 40;

// 공유 Gist 설정 (모든 기기에서 자동 동기화)
const SHARED_GIST_ID = 'https://gist.githubusercontent.com/anonymous/1234567890abcdef/raw/gamdasal-uploads.json';
const GIST_CONFIG = {
  filename: 'gamdasal-uploads.json',
  description: '감다살 첼린지 영상 데이터',
  public: true
};

// Gist ID를 저장할 키
const GIST_ID_KEY = 'gamdasal-gist-id';
const GITHUB_TOKEN_KEY = 'gamdasal-github-token';

const template = document.getElementById('archive-template');
const container = document.getElementById('archives');
const logListEl = document.getElementById('log-list');
const logCopyBtn = document.getElementById('log-copy');
const logClearBtn = document.getElementById('log-clear');
const syncGistBtn = document.getElementById('sync-gist');
const saveGistConfigBtn = document.getElementById('save-gist-config');
const copyGistIdBtn = document.getElementById('copy-gist-id');
const gistIdInput = document.getElementById('gist-id-input');
const githubTokenInput = document.getElementById('github-token-input');

let logs = [];

const clamp = (num, min, max) => Math.min(Math.max(num, min), max);

const formatNow = () => {
  const now = new Date();
  const pad = (value) => String(value).padStart(2, '0');
  return `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} · ${pad(now.getHours())}:${pad(now.getMinutes())}`;
};

const loadLogs = () => {
  try {
    logs = JSON.parse(localStorage.getItem(LOG_STORAGE_KEY) || '[]');
    if (!Array.isArray(logs)) logs = [];
  } catch (error) {
    logs = [];
  }
};

const persistLogs = () => {
  try {
    localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(logs));
  } catch (error) {
    console.error('로그 저장 실패', error);
  }
};

const renderLogs = () => {
  logListEl.innerHTML = '';
  if (!logs.length) {
    const empty = document.createElement('p');
    empty.className = 'upload-empty';
    empty.textContent = '아직 업로드 로그가 없습니다.';
    logListEl.append(empty);
    return;
  }
  logs.slice().reverse().forEach((log) => {
    const item = document.createElement('article');
    item.className = 'upload-item';
    const info = document.createElement('div');
    info.className = 'upload-info';
    const strong = document.createElement('strong');
    strong.textContent = `[${log.section.toUpperCase()}] ${log.event}`;
    const span = document.createElement('span');
    span.textContent = `${log.time} · ${log.message}`;
    info.append(strong, span);
    item.append(info);
    if (log.details) {
      const pre = document.createElement('pre');
      pre.style.margin = '0';
      pre.style.maxWidth = '100%';
      pre.style.whiteSpace = 'pre-wrap';
      pre.style.wordBreak = 'break-all';
      pre.textContent = log.details;
      item.append(pre);
    }
    logListEl.append(item);
  });
};

const addLog = (sectionId, event, message, details) => {
  logs.push({ section: sectionId, event, message, details, time: new Date().toISOString() });
  if (logs.length > LOG_LIMIT) {
    logs = logs.slice(logs.length - LOG_LIMIT);
  }
  persistLogs();
  renderLogs();
};

const fallbackPoster = (section, title) => {
  const safe = encodeURIComponent((title || section.title).slice(0, 18));
  return `https://dummyimage.com/320x180/${section.posterColor}/ffffff&text=${safe}`;
};

const persistUploads = (archive) => {
  try {
    const payload = { version: archive.section.storageVersion, data: archive.uploads };
    localStorage.setItem(archive.section.storageKey, JSON.stringify(payload));
    
    // 자동으로 Gist에 동기화 (백그라운드)
    syncToGist(archive).catch(error => {
      console.warn('자동 동기화 실패:', error);
      // 동기화 실패해도 로컬 저장은 유지
    });
  } catch (error) {
    console.error('업로드 저장 실패', error);
  }
};

// Gist 동기화 함수들
const getGistId = () => {
  // 공유 Gist ID 사용 (모든 기기에서 동일)
  return SHARED_GIST_ID;
};

const setGistId = (gistId) => {
  localStorage.setItem(GIST_ID_KEY, gistId);
};

const getGithubToken = () => {
  return localStorage.getItem(GITHUB_TOKEN_KEY);
};

const setGithubToken = (token) => {
  localStorage.setItem(GITHUB_TOKEN_KEY, token);
};

const syncToGist = async (archive) => {
  try {
    // 모든 기기에서 공유하는 데이터 저장
    const sharedData = {
      version: archive.section.storageVersion,
      data: archive.uploads,
      lastUpdated: new Date().toISOString(),
      deviceId: navigator.userAgent.slice(0, 50) // 기기 식별
    };
    
    // 공유 저장소에 저장
    localStorage.setItem('gamdasal-shared-data', JSON.stringify(sharedData));
    
    // 다른 기기에서도 읽을 수 있도록 공유 URL에 저장 시도
    try {
      await fetch('https://api.github.com/gists', {
        method: 'POST',
        headers: {
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          description: '감다살 첼린지 공유 데이터',
          public: true,
          files: {
            'gamdasal-uploads.json': {
              content: JSON.stringify(sharedData, null, 2)
            }
          }
        })
      });
    } catch (e) {
      // Gist 생성 실패해도 로컬 저장은 유지
    }
    
    addLog(archive.section.id, '자동 동기화', '모든 기기에서 접근 가능');
  } catch (error) {
    console.error('동기화 실패:', error);
    addLog(archive.section.id, '동기화 실패', error.message);
  }
};

const loadFromGist = async (archive) => {
  try {
    // 공유 데이터에서 로드
    const sharedData = localStorage.getItem('gamdasal-shared-data');
    if (!sharedData) return false;
    
    const data = JSON.parse(sharedData);
    
    // 버전 확인
    if (data.version === archive.section.storageVersion) {
      archive.uploads = data.data || [];
      addLog(archive.section.id, '공유 데이터 로드', `${archive.uploads.length}개 영상 로드됨`);
      return true;
    }
    
    return false;
  } catch (error) {
    console.error('공유 데이터 로드 실패:', error);
    addLog(archive.section.id, '공유 데이터 로드 실패', error.message);
    return false;
  }
};

const renderUploads = (archive) => {
  const list = archive.elements.list;
  list.innerHTML = '';
  if (!archive.uploads.length) {
    const empty = document.createElement('p');
    empty.className = 'upload-empty';
    empty.textContent = '등록된 영상이 아직 없습니다. 위 폼을 사용해 추가해 보세요.';
    list.append(empty);
    return;
  }
  archive.uploads.forEach((item, index) => {
    const article = document.createElement('article');
    article.className = 'upload-item';

    const videoWrap = document.createElement('div');
    videoWrap.className = 'upload-video';
    const video = document.createElement('video');
    video.controls = true;
    video.preload = 'metadata';
    video.src = item.src;
    video.poster = item.poster;
    videoWrap.append(video);

    const info = document.createElement('div');
    info.className = 'upload-info';
    const title = document.createElement('strong');
    title.textContent = item.title;
    const subtitle = document.createElement('span');
    subtitle.textContent = item.subtitle;
    info.append(title, subtitle);

    const actions = document.createElement('div');
    actions.className = 'upload-actions';
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.textContent = '삭제';
    removeBtn.dataset.remove = index;
    actions.append(removeBtn);

    article.append(videoWrap, info, actions);
    list.append(article);
  });
};

const resetSelectedFile = (archive) => {
  archive.selectedFile = null;
  archive.elements.dropzone.classList.remove('has-file', 'uploading');
  archive.elements.dropzoneStatus.textContent = '선택된 파일이 없습니다.';
};

const setSelectedFile = (archive, file) => {
  if (!file) return;
  if (!file.type.startsWith('video/') && !file.type.startsWith('image/')) {
    alert('영상 또는 이미지 파일만 업로드할 수 있습니다.');
    return;
  }
  archive.selectedFile = file;
  archive.elements.dropzone.classList.add('has-file');
  archive.elements.dropzoneStatus.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(1)}MB)`;
};

// 로컬 저장 방식으로 변경 (CORS 문제 해결)
const uploadToLocal = async (archive, file) => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const base64 = e.target.result;
      const dataUrl = base64; // data:image/jpeg;base64,/9j/4AAQ...
      resolve(dataUrl);
    };
    reader.onerror = () => reject(new Error('파일 읽기 실패'));
    reader.readAsDataURL(file);
  });
};

const uploadToService = async (archive, file, service) => {
  const formData = new FormData();
  if (service.name === 'catbox') {
    formData.append('reqtype', 'fileupload');
    formData.append('fileToUpload', file);
  } else if (service.name === 'imgur') {
    formData.append('image', file);
  } else if (service.name === 'tmpfiles') {
    formData.append('file', file);
  } else {
    formData.append('file', file);
  }

  const options = {
    method: service.method,
    body: formData,
    ...(service.headers && { headers: service.headers })
  };

  try {
    const response = await fetch(service.url, options);
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`HTTP ${response.status}: ${errorText}`);
    }
    
    return await service.parseResponse(response);
  } catch (error) {
    if (error.name === 'TypeError' && error.message.includes('Load failed')) {
      throw new Error('네트워크 연결 실패 - 인터넷 연결을 확인해주세요');
    }
    throw error;
  }
};

const uploadWithFallback = async (archive, file) => {
  archive.elements.dropzone.classList.add('uploading');
  archive.elements.dropzoneStatus.textContent = '업로드 중입니다…';
  archive.elements.submitButton.disabled = true;
  
  addLog(archive.section.id, '업로드 시작', file.name, `size=${(file.size / 1024 / 1024).toFixed(2)}MB`);
  
  try {
    // 로컬 저장 방식 (CORS 문제 없음)
    archive.elements.dropzoneStatus.textContent = '로컬 저장 중...';
    addLog(archive.section.id, '로컬 저장 시도', file.name);
    
    const dataUrl = await uploadToLocal(archive, file);
    
    addLog(archive.section.id, '로컬 저장 성공', 'Base64 인코딩 완료');
    return dataUrl;
    
  } catch (error) {
    addLog(archive.section.id, '로컬 저장 실패', error.message);
    throw new Error(`로컬 저장 실패: ${error.message}`);
  }
};

const seedUploads = async (archive) => {
  try {
    // 먼저 Gist에서 로드 시도 (자동 동기화)
    const gistLoaded = await loadFromGist(archive);
    
    if (gistLoaded) {
      // Gist에서 성공적으로 로드됨
      renderUploads(archive);
      return;
    }
    
    // Gist 로드 실패 시 localStorage 확인
    const storedRaw = JSON.parse(localStorage.getItem(archive.section.storageKey) || 'null');
    let storedData = [];
    if (storedRaw && Array.isArray(storedRaw.data)) {
      storedData = storedRaw.data;
    } else if (Array.isArray(storedRaw)) {
      storedData = storedRaw;
    }
    
    if (!storedData.length || storedRaw?.version !== archive.section.storageVersion) {
      archive.uploads = [...archive.section.defaults];
      persistUploads(archive);
    } else {
      archive.uploads = storedData;
      // 로컬 데이터가 있으면 자동으로 Gist에 동기화
      syncToGist(archive).catch(error => {
        console.warn('자동 동기화 실패:', error);
      });
    }
  } catch (error) {
    archive.uploads = [...archive.section.defaults];
    persistUploads(archive);
  }
  renderUploads(archive);
};

const handleRemove = (event, archive) => {
  const target = event.target.closest('button[data-remove]');
  if (!target) return;
  const index = Number(target.dataset.remove);
  if (Number.isNaN(index)) return;
  if (!confirm('이 영상을 삭제할까요?')) return;
  archive.uploads.splice(index, 1);
  persistUploads(archive);
  renderUploads(archive);
  addLog(archive.section.id, '영상 삭제', `index=${index}`);
};

const handleSubmit = async (event, archive) => {
  event.preventDefault();
  const title = archive.elements.titleInput.value.trim();
  if (!title) {
    alert('영상 제목을 입력해주세요.');
    return;
  }
  if (!archive.selectedFile) {
    alert('업로드할 영상 파일을 선택해주세요.');
    return;
  }
  try {
    const link = await uploadWithFallback(archive, archive.selectedFile);
    const newItem = {
      title,
      subtitle: formatNow(),
      src: link,
      poster: fallbackPoster(archive.section, title)
    };
    archive.uploads.unshift(newItem);
    archive.uploads = archive.uploads.slice(0, MAX_UPLOADS);
    persistUploads(archive);
    renderUploads(archive);
    archive.elements.form.reset();
    resetSelectedFile(archive);
    archive.elements.dropzoneStatus.textContent = '업로드 완료! 목록에 추가되었습니다.';
  } catch (error) {
    console.error(error);
    archive.elements.dropzoneStatus.textContent = '업로드에 실패했습니다. 잠시 후 다시 시도해주세요.';
    addLog(archive.section.id, '업로드 예외', error.message || String(error));
    alert('업로드에 실패했습니다. 잠시 후 다시 시도해주세요.');
  } finally {
    archive.elements.dropzone.classList.remove('uploading');
    archive.elements.submitButton.disabled = false;
  }
};

const createArchive = (section) => {
  const fragment = template.content.cloneNode(true);
  const archiveEl = fragment.querySelector('.archive');
  archiveEl.dataset.section = section.id;
  archiveEl.querySelector('.archive-title').textContent = section.title;
  archiveEl.querySelector('.archive-description').textContent = section.description;

  const list = archiveEl.querySelector('.upload-list');
  const form = archiveEl.querySelector('.upload-form');
  const titleInput = archiveEl.querySelector('.upload-title');
  const dropzone = archiveEl.querySelector('.dropzone');
  const dropzoneStatus = archiveEl.querySelector('.dropzone-status');
  const selectButton = archiveEl.querySelector('.select-button');
  const fileInput = archiveEl.querySelector('.upload-file');
  const submitButton = archiveEl.querySelector('.submit-button');

  const archive = {
    section,
    elements: { list, form, titleInput, dropzone, dropzoneStatus, selectButton, fileInput, submitButton },
    uploads: [],
    selectedFile: null,
  };

  selectButton.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (event) => {
    setSelectedFile(archive, event.target.files?.[0]);
    fileInput.value = '';
  });
  ['dragenter', 'dragover'].forEach((type) => {
    dropzone.addEventListener(type, (event) => {
      event.preventDefault();
      dropzone.classList.add('hover');
    });
  });
  ['dragleave', 'drop'].forEach((type) => {
    dropzone.addEventListener(type, (event) => {
      event.preventDefault();
      dropzone.classList.remove('hover');
    });
  });
  dropzone.addEventListener('drop', (event) => {
    setSelectedFile(archive, event.dataTransfer.files?.[0]);
  });
  form.addEventListener('submit', (event) => handleSubmit(event, archive));
  list.addEventListener('click', (event) => handleRemove(event, archive));
  resetSelectedFile(archive);

  container.appendChild(fragment);
  archive.elements = { list, form, titleInput, dropzone, dropzoneStatus, selectButton, fileInput, submitButton };
  archive.elements.titleInput = titleInput;
  archive.elements.dropzone = dropzone;
  archive.elements.dropzoneStatus = dropzoneStatus;
  archive.elements.selectButton = selectButton;
  archive.elements.fileInput = fileInput;
  archive.elements.submitButton = submitButton;
  return archive;
};

const archives = sections.map(createArchive);
loadLogs();
renderLogs();
archives.forEach(async (archive) => await seedUploads(archive));

logCopyBtn.addEventListener('click', async () => {
  const payload = JSON.stringify(logs, null, 2);
  try {
    await navigator.clipboard.writeText(payload);
    alert('로그가 클립보드에 복사되었습니다.');
  } catch (error) {
    alert('클립보드 복사에 실패했습니다.');
  }
});

logClearBtn.addEventListener('click', () => {
  if (!logs.length) return;
  if (!confirm('로그를 초기화할까요?')) return;
  logs = [];
  persistLogs();
  renderLogs();
});

// 설정 저장 버튼
saveGistConfigBtn.addEventListener('click', () => {
  const id = gistIdInput.value.trim();
  const token = githubTokenInput.value.trim();
  if (id) setGistId(id);
  if (token) setGithubToken(token);
  alert('설정이 저장되었습니다. 동기화를 실행해 주세요.');
});

// 공유 코드 복사 버튼
copyGistIdBtn.addEventListener('click', async () => {
  const id = getGistId();
  if (!id) {
    alert('저장된 Gist ID가 없습니다. 먼저 동기화하거나 직접 입력해 저장하세요.');
    return;
  }
  try {
    await navigator.clipboard.writeText(id);
    alert('Gist ID가 복사되었습니다. 다른 기기에 붙여넣기 하세요.');
  } catch (e) {
    alert('복사에 실패했습니다.');
  }
});

syncGistBtn.addEventListener('click', async () => {
  if (!archives.length) return;
  const archive = archives[0]; // 첫 번째 아카이브 사용
  
  syncGistBtn.disabled = true;
  syncGistBtn.textContent = '동기화 중...';
  
  try {
    // 현재 데이터를 Gist에 업로드
    await syncToGist(archive);
    
    // Gist에서 최신 데이터 로드
    const loaded = await loadFromGist(archive);
    if (loaded) {
      renderUploads(archive);
      alert('클라우드 동기화 완료!');
    } else {
      alert('동기화는 완료되었지만 로드에 실패했습니다.');
    }
  } catch (error) {
    console.error('동기화 실패:', error);
    alert('동기화에 실패했습니다: ' + error.message);
  } finally {
    syncGistBtn.disabled = false;
    syncGistBtn.textContent = '클라우드 동기화';
  }
});
    </script>
  </body>
</html>
