<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8">
    <title>ê°ë‹¤ì‚´ ì˜ìƒ ì•„ì¹´ì´ë¸Œ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style id="gemini-new-design">
      :root {
        --primary: #5b6d8a;
        --primary-dark: #3d4b61;
        --accent: #f2c15d;
        --accent-soft: #f7d894;
        --background-start: #b9d3ec;
        --background-end: #eef2f8;
        --surface: rgba(255, 255, 255, 0.9);
        --surface-solid: #fdfbf6;
        --border: rgba(91, 109, 138, 0.18);
        --text-strong: #2f3747;
        --text-muted: #4e5a6e;
        --text-soft: #6d7b90;
        --shadow-soft: 0 24px 60px rgba(63, 86, 120, 0.12);
        --shadow-small: 0 14px 32px rgba(63, 86, 120, 0.09);
        --radius-large: 24px;
      }
      .nominated-story.delete-mode .nominated-story-delete { display: inline-flex; align-items: center; justify-content: center; }
      * { box-sizing: border-box; }
      html, body { -webkit-text-size-adjust: 100%; }
      img, video { max-width: 100%; height: auto; display: block; }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: 'Pretendard', 'Apple SD Gothic Neo', 'Segoe UI', sans-serif;
        color: var(--text-muted);
        background:
          radial-gradient(circle at 80% 10%, rgba(255, 255, 255, 0.45), transparent 55%),
          radial-gradient(circle at 15% 25%, rgba(255, 255, 255, 0.35), transparent 50%),
          linear-gradient(180deg, var(--background-start), var(--background-end));
      }

      main {
        width: min(960px, 100%);
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: clamp(2.8rem, 6vw, 3.8rem);
        padding: clamp(2.4rem, 6vw, 3.6rem) clamp(1.8rem, 4vw, 3rem);
      }

      button { font-family: inherit; cursor: pointer; }

      header {
        position: relative;
        display: grid;
        gap: clamp(1.8rem, 4vw, 2.6rem);
        text-align: center;
        padding: clamp(2.8rem, 6vw, 3.6rem) clamp(1.6rem, 4vw, 2.8rem);
        border-radius: var(--radius-large);
        background: linear-gradient(150deg, rgba(255, 255, 255, 0.82), rgba(255, 255, 255, 0.95));
        border: 1px solid var(--border);
        box-shadow: var(--shadow-soft);
        overflow: hidden;
      }
      header::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(91, 109, 138, 0.25), rgba(242, 193, 93, 0.18));
        filter: blur(48px);
        opacity: 0.7;
        z-index: 0;
      }
      header > * { position: relative; z-index: 1; }
      .hero-copy { display: grid; gap: 1.2rem; justify-items: center; }
      header h1 {
        margin: 0;
        font-size: clamp(2.6rem, 6vw, 3.4rem);
        color: var(--text-strong);
        font-weight: 800;
        letter-spacing: -0.03em;
      }
      header p {
        margin: 1rem auto 0;
        max-width: 48ch;
        font-size: clamp(1.05rem, 2vw, 1.25rem);
        color: rgba(63, 78, 100, 0.85);
        line-height: 1.65;
      }
      .hero-visual {
        width: min(720px, 100%);
        margin: clamp(1.6rem, 4vw, 2.4rem) auto 0;
        border-radius: 24px;
        overflow: hidden;
        box-shadow: 0 24px 48px rgba(63, 86, 120, 0.18);
      }
      .hero-visual img { width: 100%; display: block; }
      .hero-notes {
        width: min(720px, 100%);
        margin: clamp(1.2rem, 4vw, 2rem) auto 0;
        display: grid;
        justify-items: center;
        gap: 0.8rem;
        color: rgba(63, 78, 100, 0.78);
        font-size: clamp(1rem, 1.8vw, 1.1rem);
        line-height: 1.6;
        text-align: center;
      }
      .hero-notes h2 { margin: 0; font-size: clamp(1.32rem, 3vw, 1.72rem); color: var(--text-strong); }
      .hero-notes ol {
        margin: 0;
        padding-left: clamp(1rem, 3vw, 1.4rem);
        display: grid;
        gap: 0.5rem;
        list-style-position: outside;
        width: 100%;
        text-align: left;
        font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
        font-weight: 700;
        letter-spacing: -0.015em;
        max-width: 42ch;
      }
      .hero-notes ol li { max-width: 42ch; font-size: clamp(0.98rem, 2.4vw, 1.08rem); }
      .hero-notes p {
        margin: 0;
        color: rgba(63, 78, 100, 0.7);
        max-width: 42ch;
        font-family: 'Pretendard', 'Apple SD Gothic Neo', 'Segoe UI', sans-serif;
        font-weight: 400;
        letter-spacing: -0.005em;
        line-height: 1.55;
      }
      .qr-wrapper {
        margin-top: clamp(1.4rem, 3vw, 2rem);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
      }
      #qr-code-container {
        padding: 0.75rem;
        border-radius: 16px;
        background: var(--surface-solid);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-small);
      }
      #qr-code-img { width: 120px; height: 120px; }
      .qr-hint { margin: 0; font-size: 0.9rem; color: var(--text-soft); }

      .intro-section,
      .intro-layout,
      .intro-copy,
      .intro-title,
      .intro-sub,
      .intro-steps,
      .intro-badges { display: none; }
      .hero-visual {
        width: min(720px, 100%);
        margin: clamp(1.6rem, 4vw, 2.4rem) auto 0;
      }
      .hero-visual img {
        width: 100%;
        border-radius: 24px;
        box-shadow: 0 24px 48px rgba(63, 86, 120, 0.18);
      }

      #nominated-list-section {
        background: linear-gradient(160deg, rgba(255, 255, 255, 0.94), rgba(253, 251, 246, 0.88));
        border-radius: 32px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-small);
        padding: clamp(2rem, 5vw, 2.6rem);
        display: grid;
        gap: 1.8rem;
      }
      #nominated-list-section h3 {
        margin: 0;
        font-size: 1.5rem;
        color: var(--text-strong);
        font-weight: 700;
        text-align: center;
      }
      #nominated-list {
        display: flex;
        gap: 1rem;
        padding: 0.4rem 0.2rem;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
      }
      #nominated-list::-webkit-scrollbar { display: none; }
      #nominated-list .nominated-empty {
        margin: 0;
        padding: 1.2rem 1.6rem;
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.85);
        border: 1px dashed rgba(91, 109, 138, 0.24);
        color: rgba(63, 78, 100, 0.7);
        text-align: center;
        width: 100%;
      }
      .nominated-story {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.55rem;
        min-width: 78px;
        scroll-snap-align: start;
        color: var(--text-muted);
        position: relative;
      }
      .nominated-story-button {
        position: relative;
        width: 86px;
        height: 86px;
        border-radius: 50%;
        border: 0;
        padding: 0;
        background: none;
        box-shadow: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.2s ease;
      }
      .nominated-story-button:focus-visible {
        outline: 2px solid var(--accent);
        outline-offset: 3px;
      }
      .nominated-story-button:hover { transform: translateY(-3px); }
      .nominated-story-avatar {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 74px;
        height: 74px;
        border-radius: 50%;
        background: #ffffff;
        border: 2px solid rgba(91, 109, 138, 0.18);
        color: var(--primary-dark);
        font-weight: 700;
        font-size: 1.05rem;
        letter-spacing: -0.01em;
        text-align: center;
        padding: 0 6px;
        line-height: 1.2;
      }
      .nominated-story.is-active .nominated-story-avatar {
        border: 3px solid var(--accent);
        background: rgba(255, 245, 219, 0.95);
      }
      .nominated-story.is-active .nominated-story-caption {
        color: var(--text-strong);
        font-weight: 600;
      }
      .nominated-story-count { display: none; }
      .nominated-story-caption {
        font-size: 0.82rem;
        color: rgba(63, 78, 100, 0.6);
        text-align: center;
        max-width: 94px;
        line-height: 1.3;
        letter-spacing: -0.005em;
      }
      .nominated-story-delete {
        display: none;
        position: absolute;
        top: -4px;
        right: -4px;
        background: rgba(255, 82, 82, 0.92);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 26px;
        height: 26px;
        cursor: pointer;
        box-shadow: 0 8px 16px rgba(255, 82, 82, 0.25);
        font-size: 0.9rem;
        font-weight: 700;
        line-height: 1;
      }

      .archive {
        --archive-pad: clamp(2rem, 5vw, 3rem);
        background: linear-gradient(165deg, rgba(255, 255, 255, 0.94), rgba(253, 251, 246, 0.9));
        border-radius: 32px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-soft);
        padding: var(--archive-pad);
        display: grid;
        gap: 2.5rem;
      }
      .archive-header { text-align: center; display: grid; gap: 0.6rem; margin: 0; }
      .archive-title { margin: 0; font-size: clamp(1.8rem, 5vw, 2.3rem); color: var(--text-strong); font-weight: 700; }
      .archive-description { margin: 0; color: var(--text-soft); max-width: 58ch; justify-self: center; }

      .upload-list {
        display: grid;
        gap: clamp(1.6rem, 4vw, 2.2rem);
      }
      .upload-empty {
        margin: 0;
        text-align: center;
        padding: 2rem;
        border-radius: 18px;
        background: var(--surface-solid);
        border: 1px dashed rgba(91, 109, 138, 0.24);
        color: rgba(63, 78, 100, 0.7);
      }
      .upload-item {
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        grid-template-areas:
          'header'
          'video';
        gap: 0.85rem;
        justify-items: stretch;
        align-items: start;
        text-align: left;
        padding: 0;
        border-radius: 0;
        background: none;
        border: none;
        box-shadow: none;
      }
      .upload-item.has-actions {
        grid-template-areas:
          'header'
          'video'
          'actions';
      }
      .upload-header {
        grid-area: header;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        padding: 0 var(--archive-pad);
      }
      .upload-header-main { display: flex; align-items: center; gap: 0.75rem; }
      .upload-avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: rgba(91, 109, 138, 0.12);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: var(--primary-dark);
        font-size: 0.95rem;
        letter-spacing: -0.01em;
      }
      .upload-header-text {
        display: flex;
        flex-direction: column;
        gap: 0.1rem;
        align-items: flex-start;
      }
      .upload-header-text .upload-time { font-size: 0.78rem; color: rgba(63, 78, 100, 0.55); }
      .upload-header-text .upload-nomination { font-size: 0.86rem; color: var(--accent); font-weight: 600; letter-spacing: 0.01em; }
      .upload-video {
        grid-area: video;
        width: calc(100% + var(--archive-pad) * 2);
        margin-inline: calc(var(--archive-pad) * -1);
        border-radius: 18px;
        overflow: hidden;
        background: none;
        box-shadow: none;
        justify-self: stretch;
        aspect-ratio: 1 / 1;
      }
      .upload-video video,
      .upload-video img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        background: #11141f;
      }
      .upload-author { color: var(--text-strong); font-weight: 600; letter-spacing: -0.01em; font-size: clamp(0.98rem, 2vw, 1.12rem); }
      .upload-share {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 26px;
        height: 26px;
        border-radius: 50%;
        border: none;
        background: rgba(91, 109, 138, 0.12);
        color: var(--primary-dark);
        font-size: 0.9rem;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.2s ease;
      }
      .upload-share:hover { background: rgba(91, 109, 138, 0.18); transform: translateY(-1px); }
      .upload-share svg { width: 14px; height: 14px; fill: currentColor; }
      .upload-nomination {
        color: var(--accent);
        font-size: 0.9rem;
        font-weight: 600;
        letter-spacing: 0.01em;
      }
      .upload-actions {
        grid-area: actions;
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        justify-content: flex-start;
        padding: 0 var(--archive-pad);
      }
      .upload-actions button {
        background: rgba(91, 109, 138, 0.1);
        color: var(--primary-dark);
        border: none;
        border-radius: 999px;
        padding: 0.6rem 1.6rem;
        font-weight: 600;
        transition: background 0.2s ease, transform 0.2s ease;
      }
      .upload-actions button:hover {
        background: rgba(91, 109, 138, 0.18);
        transform: translateY(-2px);
      }

      .upload-form {
        display: grid;
        gap: 1.4rem;
        padding: 1.6rem;
        border-radius: 20px;
        background: var(--surface-solid);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-small);
      }
      .upload-form label { font-weight: 700; color: var(--text-strong); font-size: 1rem; }
      .two-inputs { display: grid; gap: 1rem; grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .upload-form input {
        width: 100%;
        border-radius: 14px;
        padding: 0.85rem 1rem;
        border: 1px solid rgba(91, 109, 138, 0.18);
        background: rgba(255, 255, 255, 0.92);
        color: var(--text-strong);
        font-size: 1rem;
        transition: border 0.2s ease, box-shadow 0.2s ease;
      }
      .upload-form input[readonly] {
        background: rgba(255, 255, 255, 0.7);
        color: rgba(31, 42, 68, 0.6);
        cursor: not-allowed;
      }
      .upload-form input[readonly]:focus {
        outline: none;
        border-color: rgba(91, 109, 138, 0.2);
        box-shadow: none;
      }
      .upload-form input::placeholder { color: rgba(92, 95, 127, 0.5); }
      .upload-form input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(91, 109, 138, 0.16);
      }
      .dropzone {
        border: none;
        padding: 0;
        display: grid;
        gap: 0.75rem;
        justify-items: center;
        text-align: center;
      }
      .dropzone.hover { transform: translateY(-1px); }
      .dropzone .dropzone-status {
        display: none;
        font-size: 0.9rem;
        color: var(--text-soft);
      }
      .dropzone.has-file .dropzone-status,
      .dropzone.uploading .dropzone-status,
      .dropzone.status-message .dropzone-status { display: block; }
      .select-button {
        background: rgba(255, 255, 255, 0.92);
        border-radius: 999px;
        padding: 0.55rem 1.6rem;
        border: 1px solid rgba(91, 109, 138, 0.2);
        color: var(--primary-dark);
        font-weight: 600;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .select-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 20px rgba(91, 109, 138, 0.18);
      }
      .upload-hint { color: var(--text-soft); font-size: 0.9rem; text-align: center; display: block; }
      .selected-nomination {
        margin: 0;
        font-size: 0.92rem;
        color: rgba(63, 78, 100, 0.65);
        font-weight: 500;
      }
      .selected-nomination.has-selection {
        color: var(--text-strong);
        font-weight: 700;
      }
      .submit-button {
        background: linear-gradient(135deg, var(--primary), var(--accent));
        border: none;
        border-radius: 999px;
        color: #fff;
        padding: 0.85rem 2.4rem;
        font-size: 1.05rem;
        font-weight: 700;
        cursor: pointer;
        justify-self: center;
        box-shadow: 0 18px 36px rgba(91, 109, 138, 0.28);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .submit-button:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 22px 40px rgba(91, 109, 138, 0.32);
      }
      .submit-button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }

      .contact {
        background: linear-gradient(160deg, rgba(255, 255, 255, 0.96), rgba(253, 251, 246, 0.88));
        border: 1px solid var(--border);
        box-shadow: var(--shadow-small);
        border-radius: 28px;
        padding: clamp(2rem, 5vw, 2.8rem);
        display: grid;
        gap: 1.2rem;
        text-align: center;
        align-items: center;
      }
      .contact h3 {
        margin: 0;
        font-size: clamp(1.4rem, 4vw, 1.8rem);
        color: var(--text-strong);
      }
      .contact p {
        margin: 0 auto;
        color: rgba(63, 78, 100, 0.72);
        max-width: 46ch;
        line-height: 1.6;
      }
      .contact-actions {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.75rem;
      }
      .contact-actions a {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        gap: 0.45rem;
        padding: 0.75rem 1.6rem;
        border-radius: 999px;
        font-weight: 600;
        text-decoration: none;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      }
      .contact-email-address {
        font-size: 0.82rem;
        font-weight: 500;
        opacity: 0.9;
      }
      .contact-email {
        background: linear-gradient(120deg, #5f8cff, #477dff);
        color: #fff;
        box-shadow: 0 18px 32px rgba(83, 118, 255, 0.25);
      }
      .contact-email:hover { transform: translateY(-1px); box-shadow: 0 22px 40px rgba(83, 118, 255, 0.32); }
      #nominate-modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(27, 29, 59, 0.45);
        backdrop-filter: blur(18px);
        padding: 1.5rem;
        z-index: 50;
      }
      #nominate-modal > div {
        width: min(440px, 100%);
        background: var(--surface-solid);
        border-radius: 20px;
        padding: 2rem;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-soft);
        display: grid;
        gap: 1.4rem;
      }
      #nominate-modal h3 { margin: 0; color: var(--text-strong); font-size: 1.4rem; font-weight: 700; }
      #nominate-modal p { margin: 0; color: var(--text-soft); font-size: 1rem; line-height: 1.5; }
      #nominate-modal label { font-weight: 600; color: var(--text-strong); }
      #nominate-modal input {
        width: 100%;
        border-radius: 14px;
        padding: 0.85rem 1rem;
        border: 1px solid rgba(91, 109, 138, 0.2);
        background: rgba(255, 255, 255, 0.95);
        font-size: 1rem;
      }
      #nominate-modal input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(91, 109, 138, 0.16);
      }
      #nominate-modal .two-inputs { display: grid; gap: 1rem; grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .nominate-actions { display: flex; justify-content: flex-end; gap: 0.8rem; }
      #nominate-skip {
        background: rgba(91, 109, 138, 0.12);
        border: none;
        color: var(--primary-dark);
        border-radius: 999px;
        padding: 0.6rem 1.4rem;
        font-weight: 600;
      }
      #nominate-skip:hover { background: rgba(91, 109, 138, 0.18); }
      #nominate-confirm {
        background: linear-gradient(135deg, var(--primary), var(--accent));
        border: none;
        color: #fff;
        border-radius: 999px;
        padding: 0.6rem 1.6rem;
        font-weight: 700;
        box-shadow: 0 14px 28px rgba(93, 116, 150, 0.32);
      }
      #nominate-confirm:hover { transform: translateY(-2px); }

      @media (min-width: 880px) {
        .intro-layout {
          grid-template-columns: minmax(0, 1.1fr) minmax(240px, 0.9fr);
          align-items: center;
        }
        .intro-copy {
          text-align: left;
          justify-items: flex-start;
          gap: 1.2rem;
        }
        .intro-badges { justify-content: flex-start; }

        .intro-video-container {
          grid-template-columns: minmax(0, 1fr) minmax(0, 0.9fr);
          align-items: center;
          text-align: left;
          justify-items: stretch;
        }
        .intro-video-frame { justify-self: center; }
        .feature-cards { width: 100%; }
      }

      @media (max-width: 720px) {
        main { gap: 1.8rem; padding: clamp(1.5rem, 5vw, 2rem) 0 clamp(2.4rem, 6vw, 3rem); }
        header,
        .intro-section,
        #nominated-list-section {
          border-radius: clamp(1.4rem, 6vw, 2rem);
          padding: clamp(2.2rem, 6vw, 3rem) clamp(1.2rem, 5vw, 1.8rem);
        }
        .archive {
          border-radius: clamp(1.4rem, 6vw, 2rem);
          --archive-pad: clamp(1.2rem, 5vw, 1.6rem);
          padding: clamp(1.8rem, 5vw, 2.4rem) 0 clamp(2.2rem, 6vw, 2.8rem);
        }
        .hero-visual { width: 100%; margin: clamp(1.6rem, 4vw, 2.4rem) 0 0; border-radius: clamp(1.2rem, 5vw, 1.8rem); overflow: hidden; }
        .hero-notes {
          width: 100%;
          margin: clamp(1rem, 4vw, 2rem) 0 0;
          padding: 0 clamp(1.2rem, 5vw, 1.8rem);
          justify-items: center;
          text-align: center;
          gap: 0.9rem;
        }
        .hero-notes ol { padding-left: clamp(1.2rem, 5vw, 2rem); text-align: left; }
        .hero-notes p { margin: 0; line-height: 1.55; }
        .two-inputs,
        #nominate-modal .two-inputs { grid-template-columns: 1fr; }
        #nominated-list { gap: 0.75rem; padding: 0 clamp(1.2rem, 5vw, 1.8rem); }
        .nominated-story { min-width: 78px; }
        .nominated-story-button { width: 72px; height: 72px; }
        .nominated-story-avatar { width: 62px; height: 62px; font-size: 1rem; }
        .nominated-story-caption { font-size: 0.75rem; max-width: 76px; }
        .upload-header { padding: 0 var(--archive-pad); }
        .upload-header-main { gap: 0.6rem; }
        .upload-avatar { width: 36px; height: 36px; font-size: 0.86rem; }
        .upload-video { width: 100%; margin: 0; border-radius: clamp(1rem, 5vw, 1.6rem); overflow: hidden; aspect-ratio: 1 / 1; }
        .upload-actions { padding: 0 var(--archive-pad) clamp(1.6rem, 5vw, 2rem); }
        .upload-form { padding: clamp(1.6rem, 5vw, 2rem); }
        .contact {
          border-radius: clamp(1.4rem, 6vw, 2rem);
          padding: clamp(2rem, 6vw, 2.6rem) clamp(1.2rem, 5vw, 1.8rem);
        }
        .contact-actions { flex-direction: column; }
        .contact-actions a { width: 100%; justify-content: center; }
      }
    </style>
  </head>
  <body>
    <main>
      <header class="hero">
        <div class="hero-copy">
          <h1>ê°ë‹¤ì‚´ ì±Œë¦°ì§€</h1>
          <p>ì˜ˆë°°ì™€ ì‚¶ì˜ íšŒë³µì„ ìœ„í•œ<br>ê°ë‹¤ì‚´ ì±Œë¦°ì§€, í•¨ê»˜í•´ìš”!</p>
          <figure class="hero-visual">
            <img src="assets/thanks1.png" alt="ê°ë‹¤ì‚´ ì±Œë¦°ì§€ ì†Œê°œ ì´ë¯¸ì§€">
          </figure>
          <div class="hero-notes">
            <h2>ğŸ“Œ ê°ë‹¤ì‚´ ì±Œë¦°ì§€ ì§„í–‰ ë°©ë²•</h2>
            <ol>
              <li>1ï¸âƒ£ ê°ì‚¬í•œ ë§ˆìŒì„ í‘œí˜„í•˜ê³  ì‹¶ì€ ëŒ€ìƒì„ ì„ íƒí•©ë‹ˆë‹¤.</li>
              <li>2ï¸âƒ£ ì˜ìƒ, ì‚¬ì§„ ë“± ììœ ë¡­ê²Œ ê°ì‚¬í•œ ë§ˆìŒì„ í‘œí˜„í•˜ê³  ë‹¤ìŒ ê°ë‹¤ì‚´ ì±Œë¦°ì§€ë¥¼ ì´ì–´ê°ˆ ì£¼ìë¥¼ ì§€ëª©í•´ì£¼ì„¸ìš”.</li>
              <li>3ï¸âƒ£ ê°ë‹¤ì‚´ ì±Œë¦°ì§€ ë‚´ìš©ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!</li>
            </ol>
            <p>ğŸ’Œ í•˜ë£¨ì˜ ì‘ì€ ê°ì‚¬ê°€ ë‚´ ë§ˆìŒì„ ì‚´ë¦¬ê³ ,<br>ê³µë™ì²´ë¥¼ ì‚´ë¦¬ë©° ì˜ˆë°°ë¥¼ ë‹¤ì‹œ ì„¸ì›ë‹ˆë‹¤.</p>
            <p>ì‚¶ì˜ ì˜ˆë°° íšŒë³µì´ í•„ìš”í•œ ë‹¹ì‹ ì„ ìœ„í•œ<br>ê°ë‹¤ì‚´ ì±Œë¦°ì§€!<br>ì£¼ì¸ê³µì€ ë°”ë¡œ ë‹¹ì‹ ì…ë‹ˆë‹¤!ğŸ™Œ</p>
          </div>
          <div class="qr-wrapper">
            <div id="qr-code-container">
              <img id="qr-code-img" alt="QR Code">
            </div>
            <p class="qr-hint">ğŸ“± QR ì½”ë“œë¡œ ëª¨ë°”ì¼ì—ì„œ ì ‘ì†</p>
          </div>
        </div>
      </header>

      <!-- ë‹¤ìŒ ì±Œë¦°ì§€ ëŒ€ìƒì ë¦¬ìŠ¤íŠ¸ -->
      <section id="nominated-list-section">
        <h3>ğŸ“‹ ë‹¤ìŒ ì±Œë¦°ì§€ ì°¸ì—¬ì</h3>
        <div id="nominated-list">
          <p>ì•„ì§ ì§€ëª©ëœ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      </section>

      <!-- ì˜ìƒ ì—…ë¡œë“œ ì„¹ì…˜ -->
      <section>
        <div id="archives"></div>
      </section>

      <footer class="contact" id="contact">
        <h3>ğŸ“¬ ì´ìŠˆ Â· ê±´ì˜ ì‚¬í•­</h3>
        <p>ì„œë¹„ìŠ¤ ì´ìš© ì¤‘ ê¶ê¸ˆí•œ ì ì´ë‚˜ ê°œì„  ì•„ì´ë””ì–´ê°€ ìˆë‹¤ë©´ ì–¸ì œë“ ì§€ ì—°ë½ ì£¼ì„¸ìš”.</p>
        <div class="contact-actions">
          <a class="contact-email" data-contact-email href="mailto:iddaumid@naver.com">ë©”ì¼ ë³´ë‚´ê¸°<span class="contact-email-address">iddaumid@naver.com</span></a>
        </div>
      </footer>


      <!-- ì—…ë¡œë“œ ë¡œê·¸ ì„¹ì…˜ ì œê±°ë¨ -->

      <template id="archive-template">
        <section class="archive">
          <div class="archive-header">
            <h2 class="archive-title"></h2>
            <p class="archive-description"></p>
          </div>
          <div class="upload-list"></div>
          <form class="upload-form" autocomplete="off">
            <label>ë“±ë¡ì</label>
            <p class="selected-nomination" data-selected-nomination>ë‹¤ìŒ ì±Œë¦°ì§€ ì°¸ì—¬ì ë¦¬ìŠ¤íŠ¸ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
            <div class="two-inputs">
              <input class="upload-cell" type="text" maxlength="40" placeholder="ì…€ëª… (ì˜ˆ: ê°ë‹¤ì‚´ ì…€)" required>
              <input class="upload-name" type="text" maxlength="40" placeholder="ì´ë¦„ (ì˜ˆ: ì´í•˜ì—°)" required>
            </div>
            <div class="dropzone">
              <button type="button" class="select-button">íŒŒì¼ ì„ íƒ</button>
              <input class="upload-file" type="file" accept="video/*,image/*">
              <span class="dropzone-status" aria-live="polite"></span>
            </div>
            <button type="submit" class="submit-button">ì—…ë¡œë“œ</button>
          </form>
        </section>
      </template>
 
      <!-- ì§€ëª© ëª¨ë‹¬ -->
      <div id="nominate-modal">
        <div>
          <h3>ë‹¤ìŒ ì±Œë¦°ì§€ ì°¸ì—¬ìë¥¼ ì§€ëª©í•˜ì„¸ìš”</h3>
          <p>ì…€ëª…ê³¼ ì´ë¦„ì„ ê°ê° ì…ë ¥í•´ì£¼ì„¸ìš”. ì—…ë¡œë“œ í•­ëª©ì— í•¨ê»˜ í‘œì‹œë©ë‹ˆë‹¤.</p>
          <div class="nominate-form-grid">
            <label>ì§€ëª©í•  ì‚¬ëŒ</label>
            <div class="two-inputs">
              <input id="nominate-cell-input" type="text" placeholder="ì…€ëª… (ì˜ˆ: ê°ë‹¤ì‚´ ì…€)" maxlength="40">
              <input id="nominate-name-input" type="text" placeholder="ì´ë¦„ (ì˜ˆ: ì´í•˜ì—°)" maxlength="40">
            </div>
          </div>
          <div class="nominate-actions">
            <button id="nominate-skip" type="button">ë‚˜ì¤‘ì—</button>
            <button id="nominate-confirm" type="button">í™•ì¸</button>
          </div>
        </div>
      </div>
    </main>

    <script>
const ENABLE_LOGS = false;
const MAX_UPLOADS = 12;
const sections = [
  {
    id: 'challenge',
    title: 'ê°ë‹¤ì‚´ ì±Œë¦°ì§€',
    description: 'ì˜ˆë°°ì™€ ì‚¶ì˜ íšŒë³µì„ ìœ„í•œ ê°ë‹¤ì‚´ ì±Œë¦°ì§€, í•¨ê»˜í•´ìš”!',
    storageKey: 'gamdasal-challenge-uploads',
    storageVersion: '2025-10-24-challenge-v2',
    posterColor: '211d44',
    defaults: []
  }
];

const CONTACT_CONFIG = {
  email: 'iddaumid@naver.com',
  kakao: ''
};

const OWN_UPLOAD_STORAGE_KEY = 'gamdasal-own-upload-ids';
const remotePosterCache = new Map();
const loadOwnUploads = () => {
  try {
    const raw = localStorage.getItem(OWN_UPLOAD_STORAGE_KEY);
    if (!raw) return new Set();
    const parsed = JSON.parse(raw);
    return new Set(Array.isArray(parsed) ? parsed : []);
  } catch (error) {
    console.warn('ë‚´ ì—…ë¡œë“œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:', error);
    return new Set();
  }
};

const ownUploads = loadOwnUploads();

const persistOwnUploads = () => {
  try {
    localStorage.setItem(OWN_UPLOAD_STORAGE_KEY, JSON.stringify([...ownUploads]));
  } catch (error) {
    console.warn('ë‚´ ì—…ë¡œë“œ ëª©ë¡ì„ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:', error);
  }
};

const rememberOwnUpload = (id) => {
  if (!id) return;
  ownUploads.add(id);
  persistOwnUploads();
};

const forgetOwnUpload = (id) => {
  if (!id) return;
  if (ownUploads.delete(id)) persistOwnUploads();
};

const LOG_STORAGE_KEY = 'gamdasal-upload-logs';
const LOG_LIMIT = 40;

const SUPABASE_URL = 'https://ykdmlgrlpwkqyyemcefz.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlrZG1sZ3JscHdrcXl5ZW1jZWZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNDI3NTMsImV4cCI6MjA3NjgxODc1M30.pRfCXTTXZHfp5Fohy4LLrHNujqds4Tir3pSMQIZLCvI';
const SUPABASE_BUCKET = 'videos';
const SUPABASE_TABLE = 'video_uploads';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const pathSegments = window.location.pathname.replace(/\/index\.html$/, '').split('/').filter(Boolean);
const query = new URLSearchParams(window.location.search);
const isDeleteMode = query.get('mode') === 'delete';

const contactEmailLink = document.querySelector('[data-contact-email]');
if (contactEmailLink && CONTACT_CONFIG.email) {
  contactEmailLink.href = `mailto:${CONTACT_CONFIG.email}`;
  contactEmailLink.setAttribute('title', CONTACT_CONFIG.email);
  const emailLabel = contactEmailLink.querySelector('span');
  if (emailLabel) {
    emailLabel.textContent = CONTACT_CONFIG.email;
  }
}

const template = document.getElementById('archive-template');
const container = document.getElementById('archives');
const logListEl = null;
const logCopyBtn = null;
const logClearBtn = null;
const syncCloudBtn = null;
const testSupabaseBtn = null;
const testDatabaseBtn = null;
const testStorageBtn = null;

// Nomination modal elements
const nominateModal = document.getElementById('nominate-modal');
const nominateCellInput = document.getElementById('nominate-cell-input');
const nominateNameInput = document.getElementById('nominate-name-input');
const nominateConfirmBtn = document.getElementById('nominate-confirm');
const nominateSkipBtn = document.getElementById('nominate-skip');

/** ì—…ë¡œë“œ ì™„ë£Œ í›„ ì§€ëª©ì„ ì—°ê²°í•˜ê¸° ìœ„í•œ ë§ˆì§€ë§‰ ì—…ë¡œë“œ í•­ëª© ì°¸ì¡° */
let lastUploadedItem = null;

let logs = [];

// ìµëª… ë¡œê·¸ì¸ ì—†ì´ ì§ì ‘ API í˜¸ì¶œ
const SUPABASE_HEADERS = {
  'Content-Type': 'application/json',
  'apikey': SUPABASE_ANON_KEY,
  'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
  'Prefer': 'return=minimal'
};

// ê°„ë‹¨í•œ í´ë¼ìš°ë“œ ë™ê¸°í™”

// Supabase í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
const testSupabaseConnection = async () => {
  try {
    addLog('test', 'Supabase ì—°ê²° í…ŒìŠ¤íŠ¸', 'ì—°ê²° ì‹œë„ ì¤‘...');
    const { data, error } = await supabase.from('video_uploads').select('count').limit(1);
    if (error) {
      addLog('test', 'Supabase ì—°ê²° ì‹¤íŒ¨', error.message);
    } else {
      addLog('test', 'Supabase ì—°ê²° ì„±ê³µ', 'Database ì ‘ê·¼ ê°€ëŠ¥');
    }
  } catch (error) {
    addLog('test', 'Supabase ì—°ê²° ì˜¤ë¥˜', error.message);
  }
};

const testDatabase = async () => {
  try {
    addLog('test', 'Database í…ŒìŠ¤íŠ¸', 'í…Œì´ë¸” ì¡´ì¬ í™•ì¸ ì¤‘...');
    const { data, error } = await supabase
      .from(SUPABASE_TABLE)
      .select('*')
      .limit(1);
    
    if (error) {
      addLog('test', 'Database í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨', error.message);
    } else {
      addLog('test', 'Database í…ŒìŠ¤íŠ¸ ì„±ê³µ', `í…Œì´ë¸” ì ‘ê·¼ ê°€ëŠ¥ (${data?.length || 0}ê°œ ë ˆì½”ë“œ)`);
    }
  } catch (error) {
    addLog('test', 'Database í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜', error.message);
  }
};

const testStorage = async () => {
  try {
    addLog('test', 'Storage í…ŒìŠ¤íŠ¸', 'ë²„í‚· ì ‘ê·¼ í™•ì¸ ì¤‘...');
    const { data, error } = await supabase
      .storage
      .from(SUPABASE_BUCKET)
      .list('', { limit: 1 });
    
    if (error) {
      addLog('test', 'Storage í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨', error.message);
    } else {
      addLog('test', 'Storage í…ŒìŠ¤íŠ¸ ì„±ê³µ', `ë²„í‚· ì ‘ê·¼ ê°€ëŠ¥ (${data?.length || 0}ê°œ íŒŒì¼)`);
    }
  } catch (error) {
    addLog('test', 'Storage í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜', error.message);
  }
};

const clamp = (num, min, max) => Math.min(Math.max(num, min), max);

const formatNow = () => {
  const now = new Date();
  const pad = (value) => String(value).padStart(2, '0');
  return `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} Â· ${pad(now.getHours())}:${pad(now.getMinutes())}`;
};

const loadLogs = () => {
  if (!ENABLE_LOGS) return;
  try {
    logs = JSON.parse(localStorage.getItem(LOG_STORAGE_KEY) || '[]');
    if (!Array.isArray(logs)) logs = [];
  } catch (error) {
    logs = [];
  }
};

const persistLogs = () => {
  if (!ENABLE_LOGS) return;
  try {
    localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(logs));
  } catch (error) {
    console.error('ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨', error);
  }
};

const renderLogs = () => {
  if (!ENABLE_LOGS || !logListEl) return;
  logListEl.innerHTML = '';
  if (!logs.length) {
    const empty = document.createElement('p');
    empty.className = 'upload-empty';
    empty.textContent = 'ì•„ì§ ì—…ë¡œë“œ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
    logListEl.append(empty);
    return;
  }
  logs.slice().reverse().forEach((log) => {
    const item = document.createElement('article');
    item.className = 'upload-item';
    const info = document.createElement('div');
    info.className = 'upload-info';
    const strong = document.createElement('strong');
    strong.textContent = `[${log.section.toUpperCase()}] ${log.event}`;
    const span = document.createElement('span');
    span.textContent = `${log.time} Â· ${log.message}`;
    info.append(strong, span);
    item.append(info);
    if (log.details) {
      const pre = document.createElement('pre');
      pre.style.margin = '0';
      pre.style.maxWidth = '100%';
      pre.style.whiteSpace = 'pre-wrap';
      pre.style.wordBreak = 'break-all';
      pre.textContent = log.details;
      item.append(pre);
    }
    logListEl.append(item);
  });
};

const addLog = (sectionId, event, message, details) => {
  if (!ENABLE_LOGS) return;
  logs.push({ section: sectionId, event, message, details, time: new Date().toISOString() });
  if (logs.length > LOG_LIMIT) {
    logs = logs.slice(logs.length - LOG_LIMIT);
  }
  persistLogs();
  renderLogs();
};

const posterPool = ['assets/thanks1.png', 'assets/thanks2.png', 'assets/thanks3.png'];
let posterCursor = 0;
const fallbackPoster = () => {
  const poster = posterPool[posterCursor % posterPool.length];
  posterCursor += 1;
  return poster;
};

const readFileAsDataUrl = (file) =>
  new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = (event) => reject(event?.target?.error || new Error('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'));
    reader.readAsDataURL(file);
  });

const captureVideoPoster = (file) =>
  new Promise((resolve) => {
    const url = URL.createObjectURL(file);
    const video = document.createElement('video');
    video.muted = true;
    video.playsInline = true;
    video.preload = 'metadata';

    let settled = false;
    const cleanUp = () => {
      URL.revokeObjectURL(url);
      video.src = '';
    };
    const finalize = (poster) => {
      if (settled) return;
      settled = true;
      cleanUp();
      resolve(poster || null);
    };

    const timeoutId = setTimeout(() => finalize(null), 4000);

    video.addEventListener('error', () => {
      clearTimeout(timeoutId);
      finalize(null);
    }, { once: true });

    video.addEventListener('loadeddata', () => {
      clearTimeout(timeoutId);
      const width = video.videoWidth || 640;
      const height = video.videoHeight || width;
      if (!width || !height) {
        finalize(null);
        return;
      }
      const maxWidth = 720;
      const scale = Math.min(1, maxWidth / width);
      const canvasWidth = Math.round(width * scale);
      const canvasHeight = Math.round(height * scale);
      const canvas = document.createElement('canvas');
      canvas.width = canvasWidth;
      canvas.height = canvasHeight;
      const ctx = canvas.getContext('2d');
      try {
        ctx.drawImage(video, 0, 0, canvasWidth, canvasHeight);
      } catch (drawError) {
        console.warn('í¬ìŠ¤í„° ìº¡ì²˜ ì‹¤íŒ¨:', drawError);
        finalize(null);
        return;
      }
      try {
        finalize(canvas.toDataURL('image/jpeg', 0.84));
      } catch (error) {
        console.warn('í¬ìŠ¤í„° ì¸ì½”ë”© ì‹¤íŒ¨:', error);
        finalize(null);
      }
    }, { once: true });

    video.src = url;
    try {
      video.load();
    } catch (error) {
      console.warn('ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨:', error);
      finalize(null);
    }
  });

const capturePosterFromVideoElement = (video) =>
  new Promise((resolve) => {
    try {
      const width = video.videoWidth || 640;
      const height = video.videoHeight || width;
      if (!width || !height) {
        resolve(null);
        return;
      }
      const maxWidth = 720;
      const scale = Math.min(1, maxWidth / width);
      const canvasWidth = Math.max(1, Math.round(width * scale));
      const canvasHeight = Math.max(1, Math.round(height * scale));

      const canvas = document.createElement('canvas');
      canvas.width = canvasWidth;
      canvas.height = canvasHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvasWidth, canvasHeight);
      resolve(canvas.toDataURL('image/jpeg', 0.82));
    } catch (error) {
      console.warn('ì˜ìƒì—ì„œ í¬ìŠ¤í„° ì¶”ì¶œ ì‹¤íŒ¨:', error);
      resolve(null);
    }
  });

const capturePosterFromRemoteSource = async (item) => {
  if (!item?.src) return null;
  if (remotePosterCache.has(item.src)) {
    return remotePosterCache.get(item.src);
  }

  const posterPromise = (async () => {
    try {
      const response = await fetch(item.src, {
        headers: { Range: 'bytes=0-1048575' },
      });
      if (!response.ok) {
        throw new Error(`ì›ê²© ì˜ìƒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${response.status}`);
      }
      const blob = await response.blob();
      const poster = await captureVideoPoster(blob);
      return poster;
    } catch (error) {
      console.warn('ì›ê²© í¬ìŠ¤í„° ì¶”ì¶œ ì‹¤íŒ¨:', error);
      return null;
    } finally {
      remotePosterCache.delete(item.src);
    }
  })();

  remotePosterCache.set(item.src, posterPromise);
  return posterPromise;
};

const updatePosterRecord = async (id, poster) => {
  if (!id || !poster) return;
  try {
    const { error } = await supabase
      .from(SUPABASE_TABLE)
      .update({ poster })
      .eq('id', id);
    if (error) throw error;
    addLog('poster', 'í¬ìŠ¤í„° ì €ì¥', `id=${id}`);
  } catch (error) {
    console.warn('í¬ìŠ¤í„° ì €ì¥ ì‹¤íŒ¨:', error);
  }
};

const primeVideoFrame = (video) => {
  const offset = Math.min(0.12, Math.max(0, video.duration ? video.duration * 0.02 : 0.12));

  const seekHandler = () => {
    video.removeEventListener('seeked', seekHandler);
    try {
      if (!video.paused) video.pause();
    } catch (error) {}
  };

  video.addEventListener('seeked', seekHandler, { once: true });

  try {
    video.currentTime = offset;
  } catch (error) {
    video.removeEventListener('seeked', seekHandler);
  }
};

const ensurePosterForPlayback = (video, item) => {
  if (!video || !item || item.poster) {
    if (!video.paused) {
      try { video.pause(); } catch (error) {}
    }
    return;
  }

  const handleCapture = async () => {
    const posterData = await capturePosterFromVideoElement(video);
    if (!posterData) {
      const remotePoster = await capturePosterFromRemoteSource(item);
      if (remotePoster) {
        video.poster = remotePoster;
        item.poster = remotePoster;
        if (item.id) updatePosterRecord(item.id, remotePoster);
      }
      return;
    }
    video.poster = posterData;
    item.poster = posterData;
    if (item.id) updatePosterRecord(item.id, posterData);
  };

  const runPrime = () => primeVideoFrame(video);

  if (video.readyState >= 1) {
    runPrime();
    handleCapture();
  } else {
    video.addEventListener('loadedmetadata', () => {
      runPrime();
      handleCapture();
    }, { once: true });
  }

  try {
    const playPromise = video.play();
    if (playPromise?.then) {
      playPromise.then(() => {
        try { video.pause(); } catch (error) {}
      }).catch(() => primeVideoFrame(video));
    }
  } catch (error) {
    primeVideoFrame(video);
  }
};

let previewObserver = null;

const ensurePreviewObserver = () => {
  if (previewObserver !== null) return previewObserver;
  if (typeof IntersectionObserver === 'undefined') return null;

  previewObserver = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      const video = entry.target;
      if (!(video instanceof HTMLVideoElement)) return;

      if (entry.isIntersecting || entry.intersectionRatio >= 0.55) {
        video.dataset.previewActive = '1';
        try {
          const playPromise = video.play();
          if (playPromise?.catch) playPromise.catch(() => {});
        } catch (error) {
          console.warn('ë¯¸ë¦¬ë³´ê¸° ì¬ìƒ ì‹¤íŒ¨:', error);
        }
      } else {
        video.dataset.previewActive = '0';
        try { video.pause(); } catch (error) {}
      }
    });
  }, { threshold: 0.55, rootMargin: '0px 0px -15% 0px' });

  return previewObserver;
};

const registerVideoPreview = (video) => {
  if (!video) return;
  video.setAttribute('muted', '');
  video.setAttribute('playsinline', '');
  video.setAttribute('webkit-playsinline', '');
  video.muted = true;
  video.playsInline = true;
  video.loop = true;
  video.dataset.previewBound = '1';

  const observer = ensurePreviewObserver();
  if (observer) {
    observer.observe(video);
  } else {
    try {
      const playPromise = video.play();
      if (playPromise?.catch) playPromise.catch(() => {});
    } catch (error) {}
  }
};

const unregisterVideoPreview = (video) => {
  if (!video) return;
  if (previewObserver) previewObserver.unobserve(video);
  video.dataset.previewBound = '';
  try { video.pause(); } catch (error) {}
};

const cleanupVideoPreviews = (root) => {
  if (!root) return;
  root.querySelectorAll('video[data-preview-bound="1"]').forEach((video) => {
    unregisterVideoPreview(video);
  });
};

if (typeof document !== 'undefined') {
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      document.querySelectorAll('video[data-preview-bound="1"]').forEach((video) => {
        try { video.pause(); } catch (error) {}
      });
    }
  });
}

const deriveUploadTitle = (file, uploaderName) => {
  if (file?.name) {
    const base = file.name.replace(/\.[^.]+$/, '').trim();
    if (base) {
      return base.slice(0, 80);
    }
  }
  if (uploaderName) {
    return `${uploaderName}ë‹˜ì˜ ì˜ìƒ`;
  }
  return 'ë¬´ì œ ì˜ìƒ';
};

const sanitizeFileName = (name) => {
  return name
    .toLowerCase()
    .replace(/[^a-z0-9._-]+/g, '-')
    .replace(/-+/g, '-')
    .replace(/^-|-$/g, '')
    .slice(0, 80) || 'upload';
};

const createUuid = () => {
  if (window.crypto && typeof window.crypto.randomUUID === 'function') {
    return window.crypto.randomUUID();
  }
  return `id-${Math.random().toString(36).slice(2, 11)}-${Date.now().toString(36)}`;
};

const createStoragePath = (archive, file) => {
  const extension = (file.name.split('.').pop() || 'mp4').toLowerCase();
  const base = sanitizeFileName(file.name.replace(/\.[^.]+$/, ''));
  const folder = `${archive.section.id}`;
  return `${folder}/${createUuid()}-${base}.${extension}`;
};

const mapRowToUpload = (row) => ({
  id: row.id,
  title: row.title || 'ë¬´ì œ ì˜ìƒ',
  subtitle: row.subtitle,
  src: row.src,
  poster: row.poster,
  created_at: row.created_at
});

const uploadToSupabaseStorage = async (archive, file) => {
  try {
    const path = createStoragePath(archive, file);
    
    // Supabase Storageì— íŒŒì¼ ì—…ë¡œë“œ
    const { data, error } = await supabase
      .storage
      .from(SUPABASE_BUCKET)
      .upload(path, file, { cacheControl: '3600', upsert: false });
    
    if (error) {
      addLog(archive.section.id, 'Storage ì—…ë¡œë“œ ì‹¤íŒ¨', error.message);
      // ë²„í‚·ì´ ì—†ëŠ” ê²½ìš° Base64ë¡œ ëŒ€ì²´
      console.warn('Supabase Storage ì˜¤ë¥˜, Base64ë¡œ ëŒ€ì²´:', error);
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          resolve({
            publicUrl: reader.result,
            path: `base64_${Date.now()}_${file.name}`
          });
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    
    // ê³µê°œ URL ê°€ì ¸ì˜¤ê¸°
    const { data: urlData } = supabase
      .storage
      .from(SUPABASE_BUCKET)
      .getPublicUrl(path);
    
    addLog(archive.section.id, 'Storage ì—…ë¡œë“œ ì„±ê³µ', 'Supabase Storageì— ì €ì¥ë¨');
    return { publicUrl: urlData.publicUrl, path };
  } catch (error) {
    addLog(archive.section.id, 'Storage ì—…ë¡œë“œ ì‹¤íŒ¨', error.message);
    console.error('Storage ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
    throw error;
  }
};

const fetchUploadsFromCloud = async (archive, { addLogEntry = true } = {}) => {
  try {
    // Supabase Databaseì—ì„œë§Œ ë°ì´í„° ë¡œë“œ
    const { data, error } = await supabase
      .from(SUPABASE_TABLE)
      .select('id,title,subtitle,src,poster,created_at')
      .order('created_at', { ascending: false })
      .limit(MAX_UPLOADS);
    
    if (error) {
      console.warn('Supabase Database ì˜¤ë¥˜:', error);
      addLog(archive.section.id, 'í´ë¼ìš°ë“œ ë¡œë“œ ì‹¤íŒ¨', error.message);
      archive.uploads = [];
    } else {
      archive.uploads = (data || []).map(mapRowToUpload);
      if (addLogEntry) {
        addLog(archive.section.id, 'í´ë¼ìš°ë“œ ë¡œë“œ', `${archive.uploads.length}ê°œ ì˜ìƒ ë¡œë“œ`);
      }
    }
  } catch (error) {
    addLog(archive.section.id, 'í´ë¼ìš°ë“œ ë¡œë“œ ì‹¤íŒ¨', error.message);
    archive.uploads = [];
  }
};

const insertUploadRecord = async (archive, item) => {
  try {
    // Supabase Databaseì—ë§Œ ì €ì¥
    const { data, error } = await supabase
      .from(SUPABASE_TABLE)
      .insert([{
        title: item.title,
        subtitle: item.subtitle,
        src: item.src,
        poster: item.poster
      }])
      .select('id,title,subtitle,src,poster,created_at')
      .single();
    
    if (error) {
      addLog(archive.section.id, 'Supabase ì €ì¥ ì‹¤íŒ¨', error.message);
      throw error;
    }
    
    addLog(archive.section.id, 'Supabase ì €ì¥', 'Supabase Databaseì— ì €ì¥ë¨');
    return mapRowToUpload(data);
  } catch (error) {
    addLog(archive.section.id, 'ì—…ë¡œë“œ ì €ì¥ ì‹¤íŒ¨', error.message);
    throw error;
  }
};

const removeUploadRecord = async (archive, upload) => {
  if (!upload?.id) return;
  try {
    // Supabase Databaseì—ì„œ ì‚­ì œ
    const { error } = await supabase
      .from(SUPABASE_TABLE)
      .delete()
      .eq('id', upload.id);
    
    if (error) {
      addLog(archive.section.id, 'Supabase ì‚­ì œ ì‹¤íŒ¨', error.message);
      throw error;
    }
    
    addLog(archive.section.id, 'Supabase ì‚­ì œ', 'Supabase Databaseì—ì„œ ì‚­ì œë¨');
  } catch (error) {
    addLog(archive.section.id, 'ì‚­ì œ ì‹¤íŒ¨', error.message);
    throw error;
  }
};

const normalizeNomination = (text) =>
  text
    .split('/')
    .map((part) => part.trim())
    .filter(Boolean)
    .join(' / ')
    .toLowerCase();

const NOMINATION_HINT_MESSAGE = 'ë‹¤ìŒ ì±Œë¦°ì§€ ì°¸ì—¬ì ë¦¬ìŠ¤íŠ¸ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.';

const applySelectedNominationToForm = (archive, options = {}) => {
  const { setInputs = false } = options;
  const { cellInput, nameInput, selectedNominationLabel } = archive.elements;
  const selected = archive.selectedNomination;

  if (setInputs) {
    if (cellInput) cellInput.value = selected?.cell || '';
    if (nameInput) nameInput.value = selected?.name || '';
  }

  if (selectedNominationLabel) {
    if (selected) {
      const labelParts = [];
      if (selected.cell) labelParts.push(selected.cell);
      if (selected.name) labelParts.push(selected.name);
      selectedNominationLabel.textContent = labelParts.join(' / ') || NOMINATION_HINT_MESSAGE;
      selectedNominationLabel.classList.add('has-selection');
    } else {
      selectedNominationLabel.textContent = NOMINATION_HINT_MESSAGE;
      selectedNominationLabel.classList.remove('has-selection');
    }
  }
};

const setSelectedNomination = (archive, cell, name) => {
  const trimmedCell = (cell || '').trim();
  const trimmedName = (name || '').trim();
  archive.selectedNomination = {
    cell: trimmedCell,
    name: trimmedName,
  };
  archive.selectedNominationKey = normalizeNomination([trimmedCell, trimmedName].filter(Boolean).join(' / '));
  applySelectedNominationToForm(archive, { setInputs: true });
};

const clearSelectedNomination = (archive) => {
  archive.selectedNomination = null;
  archive.selectedNominationKey = null;
  applySelectedNominationToForm(archive, { setInputs: true });
};

const removeNomination = async (cell, name) => {
  if (!archives.length) return false;
  const archive = archives[0];
  if (!archive) return false;

  const targetKey = normalizeNomination([cell, name].filter(Boolean).join(' / '));
  if (!targetKey) return false;

  const matchIndex = archive.uploads.findIndex((upload) => {
    if (!upload?.subtitle || !upload.subtitle.includes('ë‹¤ìŒ ì§€ëª©:')) return false;
    const match = upload.subtitle.match(/ë‹¤ìŒ ì§€ëª©:\s*(.+?)(?:\s*Â·\s*|$)/);
    if (!match || !match[1]) return false;
    return normalizeNomination(match[1]) === targetKey;
  });

  if (matchIndex === -1) return false;

  const upload = archive.uploads[matchIndex];
  const updatedSubtitle = upload.subtitle
    .replace(/\s*Â·\s*ë‹¤ìŒ ì§€ëª©:[^Â·]*$/, '')
    .replace(/\s*ë‹¤ìŒ ì§€ëª©:[^Â·]*$/, '')
    .trim();

  try {
    if (upload.id) {
      const { error } = await supabase
        .from(SUPABASE_TABLE)
        .update({ subtitle: updatedSubtitle || null })
        .eq('id', upload.id);
      if (error) throw error;
    }
    archive.uploads[matchIndex] = { ...upload, subtitle: updatedSubtitle };
    addLog(archive.section.id, 'ì§€ëª© ì œê±°', `${cell || ''} ${name || ''}`.trim());
    renderUploads(archive);
    renderNominatedList(archives);
    return true;
  } catch (error) {
    console.error('ì§€ëª© ì œê±° ì‹¤íŒ¨:', error);
    addLog(archive.section.id, 'ì§€ëª© ì œê±° ì‹¤íŒ¨', error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
    throw error;
  }
};

const shareUpload = async (upload) => {
  if (!upload?.src) return;
  const shareData = {
    title: upload.title || 'ê°ì‚¬ ì´ì•¼ê¸°',
    url: upload.src
  };

  try {
    if (navigator.share) {
      await navigator.share(shareData);
    } else if (navigator.clipboard?.writeText) {
      await navigator.clipboard.writeText(upload.src);
      alert('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } else {
      prompt('ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•´ì£¼ì„¸ìš”.', upload.src);
    }
  } catch (error) {
    console.warn('ê³µìœ  ì‹¤íŒ¨:', error);
  }
};

// ì§€ëª©ëœ ì‚¬ëŒë“¤ ì¶”ì¶œ ë° ë Œë”ë§
const extractNominatedPeople = (archives) => {
  const nominated = new Map(); // ì¤‘ë³µ ì œê±°ë¥¼ ìœ„í•´ Map ì‚¬ìš©
  
  archives.forEach(archive => {
    archive.uploads.forEach(upload => {
      if (upload.subtitle && upload.subtitle.includes('ë‹¤ìŒ ì§€ëª©:')) {
        const match = upload.subtitle.match(/ë‹¤ìŒ ì§€ëª©:\s*(.+?)(?:\s*Â·\s*|$)/);
        if (match && match[1]) {
          const nominationText = match[1].trim();
          // "ì…€ / ì´ë¦„" í˜•ì‹ íŒŒì‹±
          const parts = nominationText.split('/').map(s => s.trim()).filter(s => s);
          if (parts.length >= 2) {
            const cell = parts[0] || '';
            const name = parts[1] || '';
            const key = `${cell}::${name}`;
            if (!nominated.has(key)) {
              nominated.set(key, { cell, name, count: 0 });
            }
            nominated.get(key).count++;
          } else if (parts.length === 1) {
            // ì´ë¦„ë§Œ ìˆëŠ” ê²½ìš°
            const name = parts[0];
            const key = `::${name}`;
            if (!nominated.has(key)) {
              nominated.set(key, { cell: '', name, count: 0 });
            }
            nominated.get(key).count++;
          }
        }
      }
    });
  });
  
  return Array.from(nominated.values()).sort((a, b) => b.count - a.count);
};

const renderNominatedList = (archives) => {
  const nominatedListEl = document.getElementById('nominated-list');
  if (!nominatedListEl) return;
  
  const nominated = extractNominatedPeople(archives);
  const archive = archives[0] || null;
  const activeKey = archive?.selectedNominationKey || '';
  
  nominatedListEl.innerHTML = '';
  
  if (nominated.length === 0) {
    const empty = document.createElement('p');
    empty.className = 'nominated-empty';
    empty.textContent = 'ì•„ì§ ì§€ëª©ëœ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤.';
    nominatedListEl.appendChild(empty);
    return;
  }
  
  const moveToUpload = (targetCell, targetName) => {
    if (!archives || archives.length === 0) {
      alert('ë“±ë¡ í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
      return;
    }

    const activeArchive = archives[0];
    if (!activeArchive || !activeArchive.elements) {
      alert('ë“±ë¡ í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
      return;
    }

    const cellInput = activeArchive.elements.cellInput;
    const nameInput = activeArchive.elements.nameInput;
    if (!cellInput || !nameInput) {
      alert('ë“±ë¡ì ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
      return;
    }

    setSelectedNomination(activeArchive, targetCell, targetName);

    activeArchive.elements.form.scrollIntoView({ behavior: 'smooth', block: 'center' });
    setTimeout(() => {
      if (activeArchive.elements.selectButton) {
        activeArchive.elements.selectButton.focus();
      }
    }, 300);
    renderNominatedList(archives);
  };

  nominated.forEach(({ cell, name, count }) => {
    const story = document.createElement('div');
    story.className = 'nominated-story';

    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'nominated-story-button';
    button.dataset.cell = cell || '';
    button.dataset.name = name || '';

    const initialsSource = name || cell || 'ê°ì‚¬';
    const avatar = document.createElement('span');
    avatar.className = 'nominated-story-avatar';
    avatar.textContent = initialsSource.slice(0, 3);
    button.appendChild(avatar);

    if (count > 1) {
      const badge = document.createElement('span');
      badge.className = 'nominated-story-count';
      badge.textContent = String(count);
      button.appendChild(badge);
    }

    const normalizedKey = normalizeNomination([cell, name].filter(Boolean).join(' / '));
    if (activeKey && normalizedKey === activeKey) {
      story.classList.add('is-active');
    }

    button.addEventListener('click', () => moveToUpload(cell || '', name || ''));

    const caption = document.createElement('span');
    caption.className = 'nominated-story-caption';
    caption.textContent = cell || 'ë¯¸ì§€ì •';

    if (isDeleteMode) {
      story.classList.add('delete-mode');
      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.className = 'nominated-story-delete';
      deleteBtn.textContent = 'Ã—';
      deleteBtn.addEventListener('click', async (event) => {
        event.stopPropagation();
        if (!confirm('ì´ ì§€ëª© ì •ë³´ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;

        try {
          await removeNomination(cell, name);
          renderNominatedList(archives);
        } catch (error) {
          console.error('ì§€ëª© ì‚­ì œ ì‹¤íŒ¨:', error);
          alert('ì§€ëª© ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
      });
      story.appendChild(deleteBtn);
    }

    story.append(button, caption);
    nominatedListEl.appendChild(story);
  });
};

const renderUploads = (archive) => {
  const list = archive.elements.list;
  cleanupVideoPreviews(list);
  list.innerHTML = '';
  if (!archive.uploads.length) {
    const empty = document.createElement('p');
    empty.className = 'upload-empty';
    empty.textContent = 'ë“±ë¡ëœ ì˜ìƒì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤. ìœ„ í¼ì„ ì‚¬ìš©í•´ ì¶”ê°€í•´ ë³´ì„¸ìš”.';
    list.append(empty);
    return;
  }
  archive.uploads.forEach((item, index) => {
    const article = document.createElement('article');
    article.className = 'upload-item';
    const isOwnUpload = item.id && ownUploads.has(item.id);
    if (isDeleteMode || isOwnUpload) {
      article.classList.add('has-actions');
    }

    const mediaWrap = document.createElement('div');
    mediaWrap.className = 'upload-video';
    const isImage = /\.(png|jpe?g|gif|webp|bmp|svg)(\?|$)/i.test(item.src || '');

    if (isImage) {
      const img = document.createElement('img');
      img.loading = 'lazy';
      img.decoding = 'async';
      img.src = item.src;
      img.alt = item.title || 'ì´ë¯¸ì§€';
      mediaWrap.append(img);
    } else {
      const video = document.createElement('video');
      video.controls = true;
      video.preload = 'auto';
      video.playsInline = true;
      video.setAttribute('playsinline', '');
      video.setAttribute('webkit-playsinline', '');
      video.muted = true;
      video.setAttribute('muted', '');
      video.loop = true;
      video.crossOrigin = 'anonymous';
      video.src = item.src;
      if (item.poster) {
        video.poster = item.poster;
      } else {
        video.poster = fallbackPoster();
        ensurePosterForPlayback(video, item);
      }

      mediaWrap.append(video);
      registerVideoPreview(video);
    }

    const headerEl = document.createElement('div');
    headerEl.className = 'upload-header';

    const headerMain = document.createElement('div');
    headerMain.className = 'upload-header-main';

    const avatar = document.createElement('span');
    avatar.className = 'upload-avatar';

    const headerText = document.createElement('div');
    headerText.className = 'upload-header-text';
    const authorSpan = document.createElement('span');
    authorSpan.className = 'upload-author';
    headerText.appendChild(authorSpan);

    const nominationRow = document.createElement('span');
    nominationRow.className = 'upload-nomination';
    headerText.appendChild(nominationRow);

    headerMain.append(avatar, headerText);

    const shareBtn = document.createElement('button');
    shareBtn.type = 'button';
    shareBtn.className = 'upload-share';
    shareBtn.title = 'ê³µìœ í•˜ê¸°';
    shareBtn.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M13.5 3a1.5 1.5 0 0 1 3 0v5.25a1.5 1.5 0 0 1-3 0V6.81l-6.97 6.97a1.5 1.5 0 0 1-2.12-2.12L11.38 4.7H9.75a1.5 1.5 0 0 1 0-3H13.5ZM5.25 10.5a1.5 1.5 0 0 1 0 3H4.5A1.5 1.5 0 0 0 3 15v4.5A1.5 1.5 0 0 0 4.5 21h12a1.5 1.5 0 0 0 1.5-1.5v-3.75a1.5 1.5 0 0 1 3 0V19.5A4.5 4.5 0 0 1 16.5 24h-12A4.5 4.5 0 0 1 0 19.5V15a4.5 4.5 0 0 1 4.5-4.5h.75Z"/></svg>';
    shareBtn.addEventListener('click', (event) => {
      event.stopPropagation();
      shareUpload(item);
    });

    headerEl.append(headerMain, shareBtn);

    if (item.subtitle) {
      const nomMatch = item.subtitle.match(/ë‹¤ìŒ ì§€ëª©:\s*(.+?)(?:\s*Â·\s*|$)/);
      const nominationInfo = nomMatch ? nomMatch[1].trim() : '';
      const baseSubtitle = nomMatch ? item.subtitle.replace(/Â·\s*ë‹¤ìŒ ì§€ëª©:.*$/, '').trim() : item.subtitle;

      const parts = baseSubtitle
        .split('Â·')
        .map((part) => part.trim())
        .filter(Boolean);

      const authorText = parts.length ? parts[0] : 'ìµëª… ì‚¬ìš©ì';
      authorSpan.textContent = authorText;
      avatar.textContent = authorText.replace(/[^\p{L}\p{N}]/gu, '').slice(0, 2) || 'ê°ì‚¬';
      nominationRow.textContent = nominationInfo ? `ë‹¤ìŒ ì§€ëª© ${nominationInfo}` : 'ë‹¤ìŒ ì§€ëª© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.';
    } else {
      authorSpan.textContent = 'ìµëª… ì‚¬ìš©ì';
      avatar.textContent = 'ê°ì‚¬';
      nominationRow.textContent = 'ë‹¤ìŒ ì§€ëª© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.';
    }

    const nodes = [headerEl, mediaWrap];
    if (isDeleteMode || isOwnUpload) {
      const actions = document.createElement('div');
      actions.className = 'upload-actions';
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.textContent = 'ì‚­ì œ';
      removeBtn.dataset.remove = index;
      if (item.id) {
        removeBtn.dataset.id = item.id;
      }
      actions.append(removeBtn);
      nodes.push(actions);
    }

    article.append(...nodes);
    list.append(article);
  });
  
  // Update nominated people list
  renderNominatedList(archives);
};

const resetSelectedFile = (archive) => {
  archive.selectedFile = null;
  archive.elements.dropzone.classList.remove('has-file', 'uploading', 'status-message');
  archive.elements.dropzoneStatus.textContent = '';
  archive.selectedPoster = null;
  archive.selectedPosterPromise = null;
};

const setSelectedFile = (archive, file) => {
  if (!file) return;
  if (!file.type.startsWith('video/') && !file.type.startsWith('image/')) {
    alert('ì˜ìƒ ë˜ëŠ” ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    return;
  }
  archive.selectedFile = file;
  archive.elements.dropzone.classList.remove('status-message');
  archive.elements.dropzone.classList.add('has-file');
  archive.elements.dropzoneStatus.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(1)}MB)`;

  archive.selectedPoster = null;
  archive.selectedPosterPromise = null;

  if (file.type.startsWith('image/')) {
    archive.selectedPosterPromise = readFileAsDataUrl(file)
      .then((dataUrl) => {
        archive.selectedPoster = dataUrl;
        return dataUrl;
      })
      .catch((error) => {
        console.warn('ì´ë¯¸ì§€ í¬ìŠ¤í„° ìƒì„± ì‹¤íŒ¨:', error);
        archive.selectedPoster = null;
      });
  } else if (file.type.startsWith('video/')) {
    archive.selectedPosterPromise = captureVideoPoster(file)
      .then((poster) => {
        archive.selectedPoster = poster;
        return poster;
      })
      .catch((error) => {
        console.warn('ë™ì˜ìƒ í¬ìŠ¤í„° ìƒì„± ì‹¤íŒ¨:', error);
        archive.selectedPoster = null;
      });
  }
};

const uploadToCloud = async (archive, file) => {
  archive.elements.dropzone.classList.remove('status-message');
  archive.elements.dropzone.classList.add('uploading');
  archive.elements.dropzoneStatus.textContent = 'ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤â€¦';
  archive.elements.submitButton.disabled = true;

  addLog(archive.section.id, 'ì—…ë¡œë“œ ì‹œì‘', file.name, `size=${(file.size / 1024 / 1024).toFixed(2)}MB`);

  try {
    archive.elements.dropzoneStatus.textContent = 'í´ë¼ìš°ë“œ ì—…ë¡œë“œ ì¤‘...';
    const { publicUrl, path } = await uploadToSupabaseStorage(archive, file);
    addLog(archive.section.id, 'í´ë¼ìš°ë“œ ì—…ë¡œë“œ', publicUrl, path);
    return { publicUrl, path };
  } catch (error) {
    addLog(archive.section.id, 'í´ë¼ìš°ë“œ ì—…ë¡œë“œ ì‹¤íŒ¨', error.message);
    throw error;
  }
};

const seedUploads = async (archive) => {
  try {
    await fetchUploadsFromCloud(archive);
  } catch (error) {
    console.error('í´ë¼ìš°ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
    addLog(archive.section.id, 'í´ë¼ìš°ë“œ ë¡œë“œ ì‹¤íŒ¨', error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
    archive.uploads = [];
  }
  renderUploads(archive);
  // ì§€ëª©ëœ ì‚¬ëŒë“¤ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
  renderNominatedList(archives);
};

const handleRemove = async (event, archive) => {
  const target = event.target.closest('button[data-remove]');
  if (!target) return;
  const index = Number(target.dataset.remove);
  if (Number.isNaN(index)) return;
  const upload = archive.uploads[index];
  if (!upload) return;
  if (!confirm('ì´ ì˜ìƒì„ ì‚­ì œí• ê¹Œìš”?')) return;

  try {
    await removeUploadRecord(archive, upload);
    archive.uploads.splice(index, 1);
    renderUploads(archive);
    forgetOwnUpload(upload.id);
    addLog(archive.section.id, 'ì˜ìƒ ì‚­ì œ', upload.title, upload.id ? `id=${upload.id}` : undefined);
  } catch (error) {
    console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
    addLog(archive.section.id, 'ì‚­ì œ ì‹¤íŒ¨', error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
    alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  }
};

const handleSubmit = async (event, archive) => {
  event.preventDefault();
  const cellInput = archive.elements.cellInput;
  const nameInput = archive.elements.nameInput;
  const cell = (cellInput?.value || '').trim();
  const name = (nameInput?.value || '').trim();
  if (!cell || !name) {
    alert('ë‹¤ìŒ ì±Œë¦°ì§€ ì°¸ì—¬ì ë¦¬ìŠ¤íŠ¸ì—ì„œ ì‚¬ëŒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }

  const author = `${cell} / ${name}`;
  const manualNominationKey = normalizeNomination([cell, name].join(' / '));
  const selectionMatches = archive.selectedNominationKey && manualNominationKey === archive.selectedNominationKey;
  if (!selectionMatches && archive.selectedNomination) {
    archive.selectedNomination = null;
    archive.selectedNominationKey = null;
    applySelectedNominationToForm(archive);
  }
  if (!archive.selectedFile) {
    alert('ì—…ë¡œë“œí•  ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  const title = deriveUploadTitle(archive.selectedFile, name);
  if (archive.selectedPosterPromise) {
    archive.elements.dropzone.classList.add('status-message');
    archive.elements.dropzoneStatus.textContent = 'ë¯¸ë¦¬ë³´ê¸° ì¤€ë¹„ ì¤‘...';
    try {
      await archive.selectedPosterPromise;
    } catch (error) {
      console.warn('í¬ìŠ¤í„° ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜:', error);
    }
  }
  let uploadMetadata = null;
  try {
    uploadMetadata = await uploadToCloud(archive, archive.selectedFile);
    const newItem = {
      title,
      subtitle: `${author} Â· ${formatNow()}`,
      src: uploadMetadata.publicUrl,
      poster: archive.selectedPoster || fallbackPoster()
    };
    const saved = await insertUploadRecord(archive, newItem);
    rememberOwnUpload(saved.id);
    archive.uploads.unshift(saved);
    archive.uploads = archive.uploads.slice(0, MAX_UPLOADS);

    let nominationRemoved = false;
    try {
      nominationRemoved = await removeNomination(cell, name);
    } catch (removeError) {
      console.warn('ì§€ëª© ì œê±° ì¤‘ ì˜¤ë¥˜:', removeError);
    }

    if (!nominationRemoved) {
      renderUploads(archive);
    }

    archive.elements.form.reset();
    resetSelectedFile(archive);
    clearSelectedNomination(archive);
    renderNominatedList(archives);

    archive.elements.dropzone.classList.add('status-message');
    archive.elements.dropzoneStatus.textContent = 'ì—…ë¡œë“œ ì™„ë£Œ! ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.';
    addLog(archive.section.id, 'ì—…ë¡œë“œ ì™„ë£Œ', saved.title, saved.id ? `id=${saved.id}` : undefined);

    // ì—…ë¡œë“œ ì™„ë£Œ í›„ ì§€ëª© ëª¨ë‹¬ í‘œì‹œ
    lastUploadedItem = saved;
    if (nominateModal && nominateCellInput && nominateNameInput) {
      nominateCellInput.value = '';
      nominateNameInput.value = '';
      nominateModal.style.display = 'flex';
      // ì…€ ì…ë ¥ í•„ë“œë¡œ í¬ì»¤ìŠ¤
      setTimeout(() => {
        if (nominateCellInput) nominateCellInput.focus();
      }, 100);
    }
  } catch (error) {
    console.error(error);
    archive.elements.dropzone.classList.add('status-message');
    archive.elements.dropzoneStatus.textContent = 'ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    addLog(archive.section.id, 'ì—…ë¡œë“œ ì‹¤íŒ¨', error.message || String(error));
    alert('ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    if (uploadMetadata?.path) {
      try {
        await supabase.storage.from(SUPABASE_BUCKET).remove([uploadMetadata.path]);
        addLog(archive.section.id, 'ì •ë¦¬ ì™„ë£Œ', 'ë¶€ë¶„ ì—…ë¡œë“œ íŒŒì¼ ì‚­ì œ', uploadMetadata.path);
      } catch (cleanupError) {
        console.warn('ì„ì‹œ íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨:', cleanupError);
      }
    }
  } finally {
    archive.elements.dropzone.classList.remove('uploading');
    archive.elements.submitButton.disabled = false;
  }
};

const createArchive = (section) => {
  const fragment = template.content.cloneNode(true);
  const archiveEl = fragment.querySelector('.archive');
  archiveEl.dataset.section = section.id;
  archiveEl.querySelector('.archive-title').textContent = section.title;
  archiveEl.querySelector('.archive-description').textContent = section.description;

  const list = archiveEl.querySelector('.upload-list');
  const form = archiveEl.querySelector('.upload-form');
  const cellInput = archiveEl.querySelector('.upload-cell');
  const nameInput = archiveEl.querySelector('.upload-name');
  const dropzone = archiveEl.querySelector('.dropzone');
  const dropzoneStatus = archiveEl.querySelector('.dropzone-status');
  const selectButton = archiveEl.querySelector('.select-button');
  const fileInput = archiveEl.querySelector('.upload-file');
  const submitButton = archiveEl.querySelector('.submit-button');
  const selectedNominationLabel = archiveEl.querySelector('[data-selected-nomination]');

  const archive = {
    section,
    elements: { list, form, cellInput, nameInput, dropzone, dropzoneStatus, selectButton, fileInput, submitButton, selectedNominationLabel },
    uploads: [],
    selectedFile: null,
    selectedPoster: null,
    selectedPosterPromise: null,
    selectedNomination: null,
    selectedNominationKey: null,
  };

  clearSelectedNomination(archive);

  const handleManualInput = () => {
    if (!archive.selectedNomination) return;
    const currentKey = normalizeNomination([
      cellInput?.value || '',
      nameInput?.value || '',
    ].filter(Boolean).join(' / '));
    if (currentKey !== archive.selectedNominationKey) {
      archive.selectedNomination = null;
      archive.selectedNominationKey = null;
      applySelectedNominationToForm(archive);
      renderNominatedList(archives);
    }
  };

  if (cellInput) cellInput.addEventListener('input', handleManualInput);
  if (nameInput) nameInput.addEventListener('input', handleManualInput);

  selectButton.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (event) => {
    setSelectedFile(archive, event.target.files?.[0]);
    fileInput.value = '';
  });
  ['dragenter', 'dragover'].forEach((type) => {
    dropzone.addEventListener(type, (event) => {
      event.preventDefault();
      dropzone.classList.add('hover');
    });
  });
  ['dragleave', 'drop'].forEach((type) => {
    dropzone.addEventListener(type, (event) => {
      event.preventDefault();
      dropzone.classList.remove('hover');
    });
  });
  dropzone.addEventListener('drop', (event) => {
    setSelectedFile(archive, event.dataTransfer.files?.[0]);
  });
  form.addEventListener('submit', (event) => handleSubmit(event, archive));
  list.addEventListener('click', (event) => handleRemove(event, archive));
  resetSelectedFile(archive);

  container.appendChild(fragment);
  // archive.elementsëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì„¤ì •í–ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì—…ë°ì´íŠ¸ë§Œ í•„ìš”í•˜ë©´ ì—…ë°ì´íŠ¸
  return archive;
};

const archives = sections.map(createArchive);
loadLogs();
renderLogs();
archives.forEach(async (archive) => await seedUploads(archive));

if (ENABLE_LOGS && logCopyBtn) {
  logCopyBtn.addEventListener('click', async () => {
    const payload = JSON.stringify(logs, null, 2);
    try {
      await navigator.clipboard.writeText(payload);
      alert('ë¡œê·¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } catch (error) {
      alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  });
}

if (ENABLE_LOGS && logClearBtn) {
  logClearBtn.addEventListener('click', () => {
    if (!logs.length) return;
    if (!confirm('ë¡œê·¸ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
    logs = [];
    persistLogs();
    renderLogs();
  });
}

// ì§€ëª© ëª¨ë‹¬ ì´ë²¤íŠ¸
if (nominateConfirmBtn && nominateCellInput && nominateNameInput) {
  nominateConfirmBtn.addEventListener('click', async () => {
    const cell = (nominateCellInput?.value || '').trim();
    const name = (nominateNameInput?.value || '').trim();
    if (!lastUploadedItem) {
      nominateModal.style.display = 'none';
      return;
    }
    
    let mention = '';
    if (cell && name) {
      mention = `ë‹¤ìŒ ì§€ëª©: ${cell} / ${name}`;
    } else if (cell || name) {
      // ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì…ë ¥ëœ ê²½ìš°ë„ ì²˜ë¦¬
      mention = `ë‹¤ìŒ ì§€ëª©: ${cell || name}`;
    }
    
    if (mention) {
      // ë¡œì»¬ ë°˜ì˜
      lastUploadedItem.subtitle = `${lastUploadedItem.subtitle} Â· ${mention}`;
      // ì›ê²© ì—…ë°ì´íŠ¸ ì‹œë„
      try {
        if (lastUploadedItem.id) {
          const { error } = await supabase
            .from(SUPABASE_TABLE)
            .update({ subtitle: lastUploadedItem.subtitle })
            .eq('id', lastUploadedItem.id);
          if (error) console.warn('ì§€ëª© ì €ì¥ ì‹¤íŒ¨:', error.message);
        }
      } catch (e) {
        console.warn('ì§€ëª© ì €ì¥ ì˜¤ë¥˜:', e);
      }
      // í™”ë©´ ê°±ì‹ 
      renderUploads(archives[0]);
    }
    nominateModal.style.display = 'none';
    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    if (nominateCellInput) nominateCellInput.value = '';
    if (nominateNameInput) nominateNameInput.value = '';
    lastUploadedItem = null;
  });
}

if (nominateSkipBtn) {
  nominateSkipBtn.addEventListener('click', () => {
    if (nominateModal) nominateModal.style.display = 'none';
    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    if (nominateCellInput) nominateCellInput.value = '';
    if (nominateNameInput) nominateNameInput.value = '';
    lastUploadedItem = null;
  });
}

if (syncCloudBtn) {
  syncCloudBtn.addEventListener('click', async () => {
    if (!archives.length) return;
    const archive = archives[0];

    syncCloudBtn.disabled = true;
    syncCloudBtn.textContent = 'ë™ê¸°í™” ì¤‘...';

    try {
      await fetchUploadsFromCloud(archive, { addLogEntry: true });
      renderUploads(archive);
      alert('í´ë¼ìš°ë“œì—ì„œ ìµœì‹  ëª©ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
    } catch (error) {
      console.error('ë™ê¸°í™” ì‹¤íŒ¨:', error);
      addLog(archive.section.id, 'ë™ê¸°í™” ì‹¤íŒ¨', error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
      alert('ë™ê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } finally {
      syncCloudBtn.disabled = false;
      syncCloudBtn.textContent = 'í´ë¼ìš°ë“œ ë™ê¸°í™”';
    }
  });
}

// í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
if (testSupabaseBtn) {
  testSupabaseBtn.addEventListener('click', testSupabaseConnection);
}
if (testDatabaseBtn) {
  testDatabaseBtn.addEventListener('click', testDatabase);
}
if (testStorageBtn) {
  testStorageBtn.addEventListener('click', testStorage);
}

// QR ì½”ë“œ ìƒì„± (í˜ì´ì§€ ë¡œë“œ í›„ ì‹¤í–‰)
(function() {
  function generateQRCode() {
    const qrImg = document.getElementById('qr-code-img');
    if (!qrImg) {
      console.error('QR ì½”ë“œ ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    try {
      const currentUrl = window.location.href;
      console.log('QR ì½”ë“œ ìƒì„± ì‹œì‘:', currentUrl);
      
      // ì™¸ë¶€ APIë¥¼ ì‚¬ìš©í•˜ì—¬ QR ì½”ë“œ ìƒì„±
      const apiUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=120x120&margin=1&data=' + encodeURIComponent(currentUrl);
      qrImg.src = apiUrl;
      qrImg.onload = function() {
        console.log('QR ì½”ë“œ ë¡œë“œ ì„±ê³µ');
      };
      qrImg.onerror = function() {
        console.error('QR ì½”ë“œ ë¡œë“œ ì‹¤íŒ¨');
        // ëŒ€ì²´: ë¡œì»¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© ì‹œë„
        if (typeof QRCode !== 'undefined') {
          const canvas = document.createElement('canvas');
          QRCode.toCanvas(canvas, currentUrl, {
            width: 120,
            margin: 1,
            color: {
              dark: '#000000',
              light: '#FFFFFF'
            }
          }, function(error) {
            if (!error) {
              qrImg.src = canvas.toDataURL();
            } else {
              console.error('QR ì½”ë“œ ìƒì„± ì‹¤íŒ¨:', error);
            }
          });
        }
      };
    } catch (error) {
      console.error('QR ì½”ë“œ ìƒì„± ì˜¤ë¥˜:', error);
    }
  }
  
  // DOM ë¡œë“œ ì™„ë£Œ í›„ ì‹¤í–‰
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', generateQRCode);
  } else {
    generateQRCode();
  }
})();
    </script>
  </body>
</html>
